import React, { useState, useEffect, useRef, useMemo } from "react"
import {
  Send,
  Hash,
  Users,
  Search,
  Plus,
  Bell,
  Paperclip,
  Edit2,
  Trash2,
  MessageSquare,
  X,
  ChevronDown,
  ChevronRight,
  Menu,
  Video,
  Info,
  Mail,
  UserPlus,
  Check,
  Sparkles,
  GraduationCap,
  Briefcase,
  User as UserIcon,
  MessageCircle,
  LogIn,
  UserPlus as UserPlusIcon,
  CheckCircle,
  XCircle,
  File as FileIcon,
  Calendar,
  Mic,
  MicOff,
  VideoOff,
  PhoneOff,
  Lock,
  ExternalLink,
  ShieldAlert,
  Grid3x3,
  FileText
} from "lucide-react"
import * as Storage from "./services/storage"
import { getStoredUser, getToken, logout as authLogout, saveAuth } from "./services/auth"
import * as GoogleService from "./services/google"
import { connectChatSocket } from "./services/ws"

// Backend API base used for uploads and metadata fetches
const API_BASE = import.meta.env.VITE_API_URL || "http://localhost:8000"

export default function CollaborationApp() {
  const [isAuthenticated, setIsAuthenticated] = useState(false)
  const [currentUser, setCurrentUser] = useState(null)
  const [authMode, setAuthMode] = useState("login")
  const [authData, setAuthData] = useState({
    email: "",
    password: "",
    confirmPassword: "",
    name: ""
  })
  const [authError, setAuthError] = useState("")
  const [authSuccess, setAuthSuccess] = useState("")

  // Main Data State
  const [spaces, setSpaces] = useState([])
  const [users, setUsers] = useState([])
  const [friends, setFriends] = useState([])
  const [events, setEvents] = useState([])

  // UI State
  const [activeSpace, setActiveSpace] = useState(null)
  const [activeChannel, setActiveChannel] = useState(null)
  const [activeView, setActiveView] = useState("channel")
  const [activeDMUser, setActiveDMUser] = useState(null)

  const [messages, setMessages] = useState({})
  const [unreadChannels, setUnreadChannels] = useState([]) // Track unread channel IDs
  const [messageCounts, setMessageCounts] = useState({}) // Track counts to detect changes

  const [sidebarCollapsed, setSidebarCollapsed] = useState(false)

  // Search State
  const [searchQuery, setSearchQuery] = useState("") // Spaces Search Input
  const [debouncedSearchQuery, setDebouncedSearchQuery] = useState("")
  const [spaceSearchResults, setSpaceSearchResults] = useState([])

  const [dmSearchQuery, setDmSearchQuery] = useState("") // DMs Search Input
  const [debouncedDmSearchQuery, setDebouncedDmSearchQuery] = useState("")
  const [dmSearchResults, setDmSearchResults] = useState([])

  // Search Highlighting & Navigation
  const [highlightTerm, setHighlightTerm] = useState("")
  const [targetMessageId, setTargetMessageId] = useState(null)
  const [pinnedMessageId, setPinnedMessageId] = useState(null)
  const [hoveredMessageId, setHoveredMessageId] = useState(null)
  const [showEmojiPickerFor, setShowEmojiPickerFor] = useState(null)

  // Modals & Panels
  const [messageInput, setMessageInput] = useState("")
  const [showChannelModal, setShowChannelModal] = useState(false)
  const [newChannelName, setNewChannelName] = useState("")
  const [showCreateSpaceModal, setShowCreateSpaceModal] = useState(false)
  const [showAddFriendModal, setShowAddFriendModal] = useState(false)
  const [showAddToSpaceModal, setShowAddToSpaceModal] = useState(false)
  const [showNotificationsModal, setShowNotificationsModal] = useState(false)
  const [showMemberDetails, setShowMemberDetails] = useState(false)
  const [showEventModal, setShowEventModal] = useState(false)
  const [showNewEventForm, setShowNewEventForm] = useState(false)
  const alertedScheduledRef = useRef(new Set())
  const [showUserMenu, setShowUserMenu] = useState(false)
  const [showProfileModal, setShowProfileModal] = useState(false)
  const [avatarPreview, setAvatarPreview] = useState(null)
  const [selectedPreset, setSelectedPreset] = useState(null)
  const [isSavingProfile, setIsSavingProfile] = useState(false)
  const [showAccessDeniedModal, setShowAccessDeniedModal] = useState(false)
  const [showAddFriendConfirm, setShowAddFriendConfirm] = useState(null) // ID of user to add

  // Management Modals
  const [showRenameModal, setShowRenameModal] = useState(null)
  const [newNameInput, setNewNameInput] = useState("")
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(null)
  const [showRemoveMemberConfirm, setShowRemoveMemberConfirm] = useState(null)

  // Invite/Friend System State
  const [inviteSearchQuery, setInviteSearchQuery] = useState("")
  const [inviteSearchResults, setInviteSearchResults] = useState([])
  // Changed to array for bulk selection in Friend Modal
  const [selectedFriendInvitees, setSelectedFriendInvitees] = useState([])

  // For Channel Invites
  const [selectedInviteUsers, setSelectedInviteUsers] = useState([])

  const [newSpaceName, setNewSpaceName] = useState("")
  const [inviteSent, setInviteSent] = useState(false)

  // --- Persistent Login: restore auth state from localStorage on app load
  useEffect(() => {
    const stUser = getStoredUser()
    const token = getToken()
    if (stUser && token) {
      setCurrentUser(stUser)
      setIsAuthenticated(true)
    } else if (!stUser && !token) {
      // If no stored credentials, ensure we're logged out
      setIsAuthenticated(false)
      setCurrentUser(null)
    }
  }, [])

  // Sync currentUser to localStorage whenever it changes (ensures auth persistence)
  useEffect(() => {
    if (currentUser && isAuthenticated) {
      const existingToken = getToken()
      const token = existingToken || `token_${currentUser.id}_${Date.now()}`
      saveAuth(currentUser, token)
      console.log("Auth saved to localStorage:", currentUser.email)
    }
  }, [currentUser, isAuthenticated])

  // File Attachment State
  const [selectedFiles, setSelectedFiles] = useState([])
  const [isUploading, setIsUploading] = useState(false)

  // Calendar State
  const [currentDate, setCurrentDate] = useState(new Date())
  const [newEvent, setNewEvent] = useState({
    title: "",
    description: "",
    time: "09:00",
    type: "meeting"
  })
  const [selectedDate, setSelectedDate] = useState(new Date())

  // Video Meeting State
  const [isMicOn, setIsMicOn] = useState(true)
  const [isVideoOn, setIsVideoOn] = useState(true)
  const [activeMeetingTitle, setActiveMeetingTitle] = useState("Meeting")
  const [activeCallId, setActiveCallId] = useState(null)
  const [incomingCall, setIncomingCall] = useState(null)
  const videoRef = useRef(null)
  const incomingTimeoutRef = useRef(null)
  // Feature flag to disable live video calls in channels and chats
  const VIDEO_ENABLED = false

  // Google Integration State
  const [showGoogleAppsMenu, setShowGoogleAppsMenu] = useState(false)
  const [showDocsModal, setShowDocsModal] = useState(false)
  const [showConnectAppsModal, setShowConnectAppsModal] = useState(false)
  const [googleAccessToken, setGoogleAccessToken] = useState(null)
  const [showVideoModal, setShowVideoModal] = useState(false)
  const [selectedCallMembers, setSelectedCallMembers] = useState([])
  const [callCreating, setCallCreating] = useState(false)
  const [currentMeeting, setCurrentMeeting] = useState(null)
  const [googleDocs, setGoogleDocs] = useState([])
  const [gmailAttachments, setGmailAttachments] = useState([])
  // Documents shared in chats/channels (collected from messages)
  const [sharedChatDocs, setSharedChatDocs] = useState([])
  const [connectedApps, setConnectedApps] = useState([])
  const [loadingDocs, setLoadingDocs] = useState(false)
  const [docsError, setDocsError] = useState(null)
  const [selectedAppFilter, setSelectedAppFilter] = useState('all')
  const [googleCalendarToken, setGoogleCalendarToken] = useState(null)
  const [googleCalendarEvents, setGoogleCalendarEvents] = useState([])
  const [showCalendarConnectModal, setShowCalendarConnectModal] = useState(false)
  const [showSuccessToast, setShowSuccessToast] = useState(false)
  const [successMessage, setSuccessMessage] = useState("")

  const messagesEndRef = useRef(null)
  const messagesContainerRef = useRef(null)
  const prevScrollHeightRef = useRef(0)
  const chatSocketRef = useRef(null)
  const fileInputRef = useRef(null)
  const messageInputRef = useRef(null)
  const justSwitchedThreadRef = useRef(false)
  const [isAtBottom, setIsAtBottom] = useState(true)

  // --- Initialize Google API on mount ---
  useEffect(() => {
    GoogleService.initGoogleAuth()
    
    // Check if user already has Google access token
    const savedToken = GoogleService.getGoogleAccessToken()
    if (savedToken) {
      setGoogleAccessToken(savedToken)
    }
    
    // Check if user already has Google Calendar token
    const savedCalendarToken = GoogleService.getGoogleCalendarToken()
    if (savedCalendarToken) {
      setGoogleCalendarToken(savedCalendarToken)
      loadGoogleCalendarEvents(savedCalendarToken)
    }
  }, [])

  // Helper: render avatar for a user object
  const renderAvatar = (user, size = 40) => {
    if (!user) return null
    const url = user.avatar_url || user.avatarImage || user.avatar_image
    const preset = user.avatar_preset
    const name = user.name || "?"
    const initial = (name && name[0]) ? name[0].toUpperCase() : "?"

    const sizeStyle = { width: size, height: size, lineHeight: `${size}px`, fontSize: Math.floor(size/2) }

    if (url && typeof url === 'string' && (url.startsWith('data:') || url.startsWith('http')) ) {
      return (
        <img src={url} alt={name} className="rounded-full object-cover" style={sizeStyle} />
      )
    }

    if (preset) {
      // simple gradient generation from preset id
      const grad = `linear-gradient(135deg, ${preset[0]} 0%, ${preset[1]} 100%)`
      return (
        <div className="rounded-full flex items-center justify-center text-white font-bold" style={{ ...sizeStyle, background: grad }}>
          {initial}
        </div>
      )
    }

    // fallback: letter avatar with generated gradient from user id
    const colors = ["#ff9a9e","#fad0c4","#f6d365","#f093fb","#a1c4fd","#c2e9fb","#d4fc79","#96fbc4"]
    const idx = (String(user.id || user._id || name).length) % colors.length
    const grad = `linear-gradient(135deg, ${colors[idx]} 0%, ${colors[(idx+3)%colors.length]} 100%)`
    return (
      <div className="rounded-full flex items-center justify-center text-white font-bold" style={{ ...sizeStyle, background: grad }}>
        {initial}
      </div>
    )
  }

  // --- Debounce Logic ---
  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedSearchQuery(searchQuery)
    }, 300)
    return () => clearTimeout(handler)
  }, [searchQuery])

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedDmSearchQuery(dmSearchQuery)
    }, 300)
    return () => clearTimeout(handler)
  }, [dmSearchQuery])

  // --- Search Logic: Spaces ---
  useEffect(() => {
    if (!debouncedSearchQuery.trim()) {
      setSpaceSearchResults([])
      // Clear any search highlights / pinned result when the search box is empty
      setHighlightTerm("")
      setPinnedMessageId(null)
      return
    }

    ;(async () => {
      const query = debouncedSearchQuery.toLowerCase()
      const results = []

      for (const space of spaces) {
        // 1. Space Match
        if (space.name.toLowerCase().includes(query)) {
          results.push({
            id: `space-${space.id}`,
            type: "space",
            title: space.name,
            subtitle: "Space",
            spaceId: space.id,
            icon: space.icon
          })
        }

        for (const channel of space.channels) {
          // 2. Channel Match
          if (channel.name.toLowerCase().includes(query)) {
            results.push({
              id: `channel-${channel.id}`,
              type: "channel",
              title: `# ${channel.name}`,
              subtitle: `Channel in ${space.name}`,
              spaceId: space.id,
              channelId: channel.id
            })
          }

          // 3. Message Match (Full scan via Storage)
          try {
            const msgs = await Storage.getMessages(channel.id)
            const users = await Storage.getUsers()
            for (const msg of msgs || []) {
              if (msg.text && msg.text.toLowerCase().includes(query)) {
                const user = users.find(u => u.id === msg.userId)
                results.push({
                  id: `msg-${msg.id}`,
                  type: "message",
                  title: user?.name || "Unknown",
                  subtitle: msg.text,
                  timestamp: msg.timestamp,
                  spaceId: space.id,
                  channelId: channel.id,
                  messageId: msg.id
                })
              }
            }
          } catch (e) {
            // If channel is restricted, ignore during search (don't spam modal)
            if (e && e.status === 403) {
              // silently ignore
            } else {
              console.error("Space search failed to load messages", e)
            }
          }
        }
      }

      // Sort by relevance (Messages recently first)
      results.sort((a, b) => {
        if (a.timestamp && b.timestamp)
          return new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
        return 0
      })

      setSpaceSearchResults(results)
    })()
  }, [debouncedSearchQuery, spaces])

  // --- Search Logic: DMs ---
  useEffect(() => {
    if (!debouncedDmSearchQuery.trim() || !currentUser) {
      setDmSearchResults([])
      // Clear any search highlights / pinned result when the DM search box is empty or no user
      setHighlightTerm("")
      setPinnedMessageId(null)
      return
    }

    ;(async () => {
      const query = debouncedDmSearchQuery.toLowerCase()
      const results = []

      for (const friend of friends) {
        // 1. Friend Name Match
        if (friend.name.toLowerCase().includes(query)) {
          results.push({
            id: `friend-${friend.id}`,
            type: "user",
            title: friend.name,
            subtitle: friend.status === "online" ? "Online" : "Offline",
            userId: friend.id,
            icon: <div className="text-xl">{friend.avatar}</div>
          })
        }

        // 2. Message Match
        const ids = [currentUser.id, friend.id].sort((a, b) => a - b)
        const chatId = `dm_${ids[0]}_${ids[1]}`
        try {
          const msgs = await Storage.getMessages(chatId)
          for (const msg of msgs || []) {
            if (msg.text && msg.text.toLowerCase().includes(query)) {
              const isMe = msg.userId === currentUser.id
              results.push({
                id: `dm-msg-${msg.id}`,
                type: "message",
                title: isMe ? "You" : friend.name,
                subtitle: msg.text,
                userId: friend.id,
                messageId: msg.id,
                timestamp: msg.timestamp,
                icon: <div className="text-sm">{friend.avatar}</div>
              })
            }
          }
        } catch (e) {
          console.error("DM search failed to load messages", e)
        }
      }

      // Sort by relevance
      results.sort((a, b) => {
        if (a.timestamp && b.timestamp)
          return new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
        return 0
      })

      setDmSearchResults(results)
    })()
  }, [debouncedDmSearchQuery, friends, currentUser])

  // --- Initialization & Data Loading ---

  useEffect(() => {
    if (!isAuthenticated || !currentUser) return

    const pollData = async () => {
      try {
        const storedUsers = await Storage.getUsers()
        const freshUser = storedUsers.find(u => u.id === currentUser.id)

        // Update User Data
        if (freshUser) {
          if (!freshUser.friends) freshUser.friends = []
          const filteredFresh = filterDismissedUser(freshUser)
          const friendsChanged =
            (filteredFresh.friends?.length || 0) !==
            (currentUser.friends?.length || 0)
          const notifsChanged =
            (filteredFresh.notifications?.length || 0) !== (currentUser.notifications?.length || 0)
          const spacesChanged =
            filteredFresh.spaces.length !== currentUser.spaces.length

          if (friendsChanged || notifsChanged || spacesChanged) {
            setCurrentUser(filteredFresh)
          }
        }

        // Check for Active Space Data Updates (Members/Channels)
        if (activeSpace) {
          const freshSpaces = await Storage.getSpaces()
          const freshActiveSpace = freshSpaces.find(s => s.id === activeSpace)
          const currentActiveSpace = spaces.find(s => s.id === activeSpace)

          if (freshActiveSpace && currentActiveSpace) {
            const hasMemberChange =
              freshActiveSpace.members.length !==
              currentActiveSpace.members.length
            const freshChannelsStr = JSON.stringify(freshActiveSpace.channels)
            const currentChannelsStr = JSON.stringify(currentActiveSpace.channels)

            if (hasMemberChange || freshChannelsStr !== currentChannelsStr) {
              setSpaces(prev =>
                prev.map(s => {
                  if (s.id === activeSpace) {
                    return {
                      ...freshActiveSpace,
                      icon: s.icon, // Preserve ReactNode icon from existing state
                      expanded: s.expanded
                    }
                  }
                  return s
                })
              )
            }
          }
        }

        // Poll for Unread Messages in Channels
        const allSpaces = await Storage.getSpaces()
        for (const space of allSpaces) {
          for (const ch of (space.channels || [])) {
            try {
              const msgs = await Storage.getMessages(ch.id)
              if (msgs === null) {
                continue
              }
              const count = (msgs && msgs.length) || 0
              const prevCount = messageCounts[ch.id] || 0

              // If new message AND channel not active, mark unread
              if (
                count > prevCount &&
                (activeView !== "channel" || activeChannel !== ch.id)
              ) {
                if (!unreadChannels.includes(ch.id)) {
                  setUnreadChannels(prev => [...prev, ch.id])
                }
              }
              // Update tracking map
              messageCounts[ch.id] = count
            } catch (e) {
              if (e && e.status === 403) {
                // Restricted channel â€” ignore for unread polling
              } else {
                console.error("Failed to poll messages for channel", ch.id, e)
              }
            }
          }
        }
        setMessageCounts({ ...messageCounts })

        // Update Events
        const storedEvents = await Storage.getEvents()
        // Map current google calendar items (if any) into app event shape
        const mappedGoogle = (googleCalendarEvents || []).map(ge => {
          const startIso = ge.start?.dateTime || ge.start?.date || null
          const endIso = ge.end?.dateTime || ge.end?.date || null
          const startDate = startIso ? new Date(startIso).toISOString().split('T')[0] : ''
          return {
            id: `gcal-${ge.id}`,
            title: ge.summary || 'Untitled',
            type: ge.conferenceData ? 'meeting' : 'event',
            startDate: startDate,
            startDateTime: startIso,
            endDateTime: endIso,
            description: ge.description || '',
            link: ge.hangoutLink || ge.htmlLink || (ge.conferenceData && ge.conferenceData.entryPoints && ge.conferenceData.entryPoints[0] && ge.conferenceData.entryPoints[0].uri) || null,
            source: 'google'
          }
        })

        // Merge stored (local) events with google events, dedupe by id
        const stored = storedEvents || []
        const dedupedGoogle = mappedGoogle.filter(g => !stored.some(s => String(s.id) === String(g.id)))
        const merged = [...stored, ...dedupedGoogle]

        if ((merged?.length || 0) !== events.length) {
          setEvents(merged)
        }

        // Poll Calls
        if (activeView !== "meeting") {
          const incoming = await Storage.getIncomingCall(currentUser.id)
          if (incoming && incoming.id !== incomingCall?.id) {
            setIncomingCall(incoming)
          } else if (!incoming && incomingCall) {
            setIncomingCall(null)
          }
        }

        if (activeView === "meeting" && activeCallId) {
          const calls = await Storage.getCalls()
          const myCall = calls.find(c => c.id === activeCallId)
          if (myCall) {
            if (myCall.status === "rejected" || myCall.status === "ended") {
              setActiveView("channel")
              setActiveCallId(null)
              setIncomingCall(null)
            }
          }
        }
      } catch (e) {
        console.error("pollData failed", e)
      }
    }

    const interval = setInterval(pollData, 1500)
    return () => clearInterval(interval)
  }, [
    isAuthenticated,
    currentUser,
    events.length,
    activeView,
    incomingCall,
    activeCallId,
    activeSpace,
    spaces,
    activeChannel,
    unreadChannels
  ])

  // Ensure any incoming timeout is cleared when incomingCall is removed elsewhere
  useEffect(() => {
    if (!incomingCall) {
      try { if (incomingTimeoutRef.current) { clearTimeout(incomingTimeoutRef.current); incomingTimeoutRef.current = null } } catch(e){}
    }
  }, [incomingCall])

  useEffect(() => {
    // Clear unread when entering a channel
    if (activeView === "channel" && activeChannel && currentUser) {
      setUnreadChannels(prev => prev.filter(id => id !== activeChannel))
      // Update current count reference
      ;(async () => {
        try {
          const msgs = await Storage.getMessages(activeChannel)
          messageCounts[activeChannel] = (msgs && msgs.length) || 0
          setMessageCounts({ ...messageCounts })
        } catch (e) {
          if (e && e.status === 403) {
            // restricted channel â€” skip silently
            messageCounts[activeChannel] = 0
            setMessageCounts({ ...messageCounts })
          }
          // Silently ignore other errors during initial load
        }
      })()
    }
  }, [activeChannel, activeView, currentUser])

  useEffect(() => {
    let userSocket = null

    if (isAuthenticated && currentUser) {
      ;(async () => {
        // Await async storage helpers to ensure we get actual arrays (not Promises)
        const userSpaces = await Storage.getSpacesForUser(currentUser.spaces)
        const safeUserSpaces = Array.isArray(userSpaces) ? userSpaces : []

        const enrichedSpaces = safeUserSpaces.map(s => ({
          ...s,
          icon:
            s.iconType === "graduation" ? (
              <GraduationCap className="w-5 h-5" />
            ) : s.iconType === "briefcase" ? (
              <Briefcase className="w-5 h-5" />
            ) : (
              <UserIcon className="w-5 h-5" />
            )
        }))

        setSpaces(enrichedSpaces)

        try {
            const allUsers = await Storage.getUsers()
          setUsers(Array.isArray(allUsers) ? allUsers : [])
        } catch (e) {
          console.error("Failed to load users", e)
          setUsers([])
        }

        try {
          const friendsList = await Storage.getFriends(currentUser.friends || [])
          setFriends(friendsList)
        } catch (e) {
          console.error("Failed to load friends", e)
          setFriends([])
        }

        try {
          const evts = await Storage.getEvents()
          setEvents(evts || [])
        } catch (e) {
          console.error("Failed to load events", e)
          setEvents([])
        }

        if (
          enrichedSpaces.length > 0 &&
          !activeSpace &&
          activeView === "channel"
        ) {
          // Find first accessible channel
          const firstSpace = enrichedSpaces[0]
          const accessibleChannel = firstSpace.channels.find(
            c =>
              (c.members || []).includes(currentUser.id) ||
              (firstSpace.members || []).includes(currentUser.id) ||
              firstSpace.ownerId === currentUser.id
          )

          setActiveSpace(firstSpace.id)
          if (accessibleChannel) {
            setActiveChannel(accessibleChannel.id)
          } else {
            // No accessible channel in first space â€” do not auto-select a restricted channel
            setActiveChannel("")
          }
        }
      })()

      // Open a background user socket to receive notifications in real-time
      import("./services/ws")
        .then(({ connectUserSocket }) => {
          userSocket = connectUserSocket(data => {
            if (!data || !data.type) return

            // Only react to 'notification' messages
            if (data.type === "notification" && data.notification) {
              const incoming = data.notification

              // If this is a scheduled calendar meet, show incoming call pop instead of saving to notifications
              // NOTE: live `meet_invite` notifications are ignored when video feature is disabled
              if (incoming.type === 'scheduled_meet') {
                // Normalize timestamp
                if (incoming.timestamp && incoming.timestamp < 1e12) incoming.timestamp = incoming.timestamp * 1000

                // Build incomingCall object expected by the modal
                const callObj = {
                  id: incoming.id,
                  fromId: incoming.from,
                  fromName: incoming.fromName || String(incoming.from),
                  fromAvatar: incoming.fromAvatar || 'ðŸ‘¤',
                  link: incoming.link || null,
                  title: incoming.title || 'Video Call',
                  timestamp: incoming.timestamp
                }
                // Clear any previous incoming timeout
                try { if (incomingTimeoutRef.current) { clearTimeout(incomingTimeoutRef.current); incomingTimeoutRef.current = null } } catch(e){}

                setIncomingCall(callObj)

                // Auto-dismiss the incoming call popup after 60s if unanswered
                incomingTimeoutRef.current = setTimeout(() => {
                  setIncomingCall(null)
                  incomingTimeoutRef.current = null
                }, 60000)

                // Do not persist into notifications list
                return
              }

              if (isNotificationDismissed(currentUser?.id, incoming.id)) return

              setCurrentUser(prev => {
                if (!prev) return prev
                const already = (prev.notifications || []).some(n => n.id === incoming.id)
                if (already) return prev
                return { ...prev, notifications: [...(prev.notifications || []), incoming] }
              })

              // Also refresh users list so friend lists / counts stay in sync
              ;(async () => {
                try {
                  const allUsers = await Storage.getUsers()
                  setUsers(Array.isArray(allUsers) ? allUsers : [])
                } catch (e) {
                  console.error('Failed to refresh users after incoming notification', e)
                }
              })()
            }

            // Presence events and other types could be handled here in future
          })
        })
        .catch(e => {
          console.error('Failed to connect user socket', e)
        })
    }

    return () => {
      try {
        if (userSocket) userSocket.close()
      } catch (e) {}
    }
  }, [isAuthenticated, currentUser?.spaces, currentUser?.friends, currentUser?.id])

  useEffect(() => {
    if (activeView === "meeting" && videoRef.current) {
      let cancelled = false
      ;(async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
          })
          if (!cancelled && videoRef.current) videoRef.current.srcObject = stream
        } catch (err) {
          console.error("Error accessing media devices", err)
        }
      })()
      return () => {
        cancelled = true
        if (videoRef.current && videoRef.current.srcObject) {
          const stream = videoRef.current.srcObject
          stream.getTracks().forEach(track => track.stop())
        }
      }
    }
  }, [activeView])

  useEffect(() => {
    if (!isAuthenticated) return
    
    let chatId = null
    if (activeView === "channel" && activeChannel) {
      chatId = Number(activeChannel)
    } else if (activeView === "dm" && activeDMUser && currentUser) {
      const ids = [currentUser.id, activeDMUser].sort((a, b) => a - b)
      chatId = `dm_${ids[0]}_${ids[1]}`
    }
    
    if (!chatId) return
    
    // Don't try to load messages if spaces haven't been loaded yet
    if (activeView === "channel" && spaces.length === 0) return
    
    const loadMessages = async () => {
      try {
        const storedMessages = await Storage.getMessages(chatId)
        const normalized = Array.isArray(storedMessages)
          ? storedMessages.map(msg => ({ ...msg, status: "sent", optimistic: false }))
          : []

        setMessages(prev => {
          const existing = prev[chatId] || []
          const serverIds = new Set(normalized.map(m => m.id))
          const optimisticOnly = existing.filter(m => m.optimistic && !serverIds.has(m.id))
          return {
            ...prev,
            [chatId]: [...normalized, ...optimisticOnly]
          }
        })
      } catch (e) {
        if (e && e.status === 403) {
          // Only show access denied modal if user has spaces loaded (not initial load)
          if (spaces.length > 0 && !sessionStorage.getItem(`denied_${chatId}`)) {
            setShowAccessDeniedModal(true)
            // Mark this channel as already shown to prevent repeated popups
            sessionStorage.setItem(`denied_${chatId}`, 'true')
          }
          // Don't clear messages - keep what we have locally
          // User might have sent messages that are awaiting sync
        }
        // Silently ignore other errors
      }
    }
    loadMessages()
    const interval = setInterval(loadMessages, 1000)
    return () => clearInterval(interval)
  }, [isAuthenticated, activeChannel, activeView, activeDMUser, currentUser, spaces.length])


  // Chat websocket connection for real-time message delivery
  useEffect(() => {
    if (!isAuthenticated) return

    let chatId = null
    if (activeView === "channel" && activeChannel) {
      chatId = Number(activeChannel)
    } else if (activeView === "dm" && activeDMUser && currentUser) {
      const ids = [currentUser.id, activeDMUser].sort((a, b) => a - b)
      chatId = `dm_${ids[0]}_${ids[1]}`
    }

    if (!chatId) return

    // Close previous socket if any
    try {
      if (chatSocketRef.current) {
        chatSocketRef.current.close()
      }
    } catch (e) {}

    // Connect new chat socket
    const ws = connectChatSocket(chatId, data => {
      // Expect data to be a message object; ignore presence updates
      if (!data) return
      const normalized = { ...data, status: "sent", optimistic: false }

      setMessages(prev => {
        const key = chatId
        const existing = prev[key] || []
        const filtered = normalized.id
          ? existing.filter(m => m.id !== normalized.id)
          : existing
        return { ...prev, [key]: [...filtered, normalized] }
      })
      // If message has attachments with file ids, fetch metadata for previews/downloads
      if (normalized.attachments && normalized.attachments.length > 0) {
        normalized.attachments.forEach(att => {
          const fid = att.fileId || att.id || att.drive_file_id || att.driveId
          if (fid && !att.url) {
            // fetch metadata and update message attachments
            (async () => {
              const meta = await fetchFileMetadata(fid)
              if (meta && meta.url) {
                updateMessageMeta(chatId, normalized.id || normalized.localId, msg => ({
                  ...msg,
                  attachments: (msg.attachments || []).map(a => (String(a.id) === String(fid) || String(a.fileId) === String(fid) || String(a.drive_file_id) === String(fid) ? { ...a, url: meta.url, status: meta.status } : a))
                }))
              }
            })()
          }
        })
      }
    })

    chatSocketRef.current = ws
    ws.onopen = () => console.log("Chat socket connected", chatId)
    ws.onclose = () => console.log("Chat socket closed", chatId)
    ws.onerror = e => console.error("Chat socket error", e)

    return () => {
      try {
        if (chatSocketRef.current) chatSocketRef.current.close()
      } catch (e) {}
      chatSocketRef.current = null
    }
  }, [isAuthenticated, activeView, activeChannel, activeDMUser, currentUser?.id])

  // --- Scroll to Message Logic ---
  useEffect(() => {
    // 1) If a specific message is targeted (search -> result), center it
    if (targetMessageId) {
      // Small timeout to allow render
      const timer = setTimeout(() => {
        const element = document.getElementById(`msg-${targetMessageId}`)
        if (element) {
          element.scrollIntoView({ behavior: "smooth", block: "center" })
          setTargetMessageId(null)
        }
      }, 500)
      return () => clearTimeout(timer)
    }

    // 2) If the user is reviewing a pinned search result, DO NOT auto-scroll away
    if (pinnedMessageId) {
      return
    }

    // 3) When the user manually switches a thread (channel/DM), do an instant jump to latest
    if (justSwitchedThreadRef.current) {
      messagesEndRef.current?.scrollIntoView({ behavior: "auto" })
      setIsAtBottom(true)
      justSwitchedThreadRef.current = false
      return
    }

    // 4) If user is at bottom, smooth-scroll to latest when messages change.
    // If user is NOT at bottom, preserve their scroll position instead of forcing them to the latest message.
    const el = messagesContainerRef.current
    if (!el) return

    if (isAtBottom) {
      messagesEndRef.current?.scrollIntoView({ behavior: "smooth" })
      setIsAtBottom(true)
      // record current height so future incoming messages can preserve scroll position
      try { prevScrollHeightRef.current = el.scrollHeight } catch (e) {}
      try { setVisibleDateLabel(messageDateLabel || "Today") } catch (e) {}
    } else {
      // Preserve scroll position: adjust scrollTop by the increase in scrollHeight
      try {
        const prev = prevScrollHeightRef.current || 0
        const delta = el.scrollHeight - prev
        if (delta > 0) {
          el.scrollTop = el.scrollTop + delta
        }
      } catch (e) {}
      // update stored height
      prevScrollHeightRef.current = el.scrollHeight
    }
  }, [messages, activeChannel, activeView, activeDMUser, targetMessageId, pinnedMessageId])

  useEffect(() => {
    ;(async () => {
      // 1. "Add Friend" Modal: Global Search for NEW friends
      if (showAddFriendModal && inviteSearchQuery.length > 0) {
        try {
          const users = await Storage.searchUsersByName(inviteSearchQuery)
          const safeUsers = Array.isArray(users) ? users : []
          const results = safeUsers.filter(
            u => u.id !== currentUser?.id && !currentUser?.friends?.includes(u.id)
          )
          setInviteSearchResults(results)
        } catch (e) {
          console.error("searchUsersByName failed", e)
          setInviteSearchResults([])
        }
      }
      // 2. "Invite to Channel" Modal: Filter EXISTING friends only
      else if (showAddToSpaceModal && activeView === "channel") {
        const currentCh = getCurrentChannels().find(c => c.id === activeChannel)
        // We only show friends who are NOT in the current channel
        // If inviteSearchQuery is empty, we show all eligible friends
        // If inviteSearchQuery is set, we filter friends by name
        const eligibleFriends = friends.filter(friend => {
          const isMember = currentCh
            ? currentCh.members.includes(friend.id)
            : false
          const matchesSearch =
            inviteSearchQuery.trim() === "" ||
            friend.name.toLowerCase().includes(inviteSearchQuery.toLowerCase())
          return !isMember && matchesSearch
        })
        setInviteSearchResults(eligibleFriends)
      } else {
        setInviteSearchResults([])
      }
    })()
  }, [
    inviteSearchQuery,
    showAddFriendModal,
    showAddToSpaceModal,
    currentUser,
    activeChannel,
    spaces,
    friends
  ])

  // --- Auth & Logout ---
  const handleAuthSubmit = async e => {
    e.preventDefault()
    setAuthError("")
    setAuthSuccess("")

    if (authMode === "signup") {
      if (!authData.name || !authData.email || !authData.password) {
        setAuthError("Please fill in all fields")
        return
      }
      if (authData.password !== authData.confirmPassword) {
        setAuthError("Passwords do not match")
        return
      }
      const existingUser = await Storage.findUserByEmail(authData.email)
      if (existingUser) {
        setAuthError("Email already registered")
        return
      }

      const newUserId = Date.now()

      // 1. Create Default Space 1
      const defaultSpace = {
        id: newUserId + 1, // Simple ID gen
        name: "Space 1",
        iconType: "briefcase",
        members: [newUserId],
        inviteCode: `SPACE1-${Math.floor(1000 + Math.random() * 9000)}`,
        channels: [
          {
            id: newUserId + 2,
            name: "general",
            type: "public",
            members: [newUserId]
          },
          {
            id: newUserId + 3,
            name: "random",
            type: "public",
            members: [newUserId]
          }
        ],
        expanded: true,
        ownerId: newUserId
      }
      await Storage.saveSpace(defaultSpace)

      // 2. Create User with Space 1
      const newUser = {
        id: newUserId,
        name: authData.name,
        email: authData.email,
        password: authData.password,
        avatar: "ðŸ‘¤",
        status: "online",
        spaces: [defaultSpace.id],
        dms: [],
        friends: [],
        notifications: [],
        integrations: {}
      }
      await Storage.saveUser(newUser)

      // Generate a simple token for the new user
      const token = `token_${newUserId}_${Date.now()}`
      saveAuth(newUser, token)
      
      setCurrentUser(newUser)
      setIsAuthenticated(true)
      setActiveSpace(defaultSpace.id)
      setActiveChannel(defaultSpace.channels[0].id)
      setAuthSuccess("Account created successfully!")
    } else {
      if (!authData.email || !authData.password) {
        setAuthError("Please fill in all fields")
        return
      }
      try {
        const data = await Storage.login({ email: authData.email, password: authData.password })
        if (data?.user && data?.token) {
          setCurrentUser(data.user)
          setIsAuthenticated(true)
          setAuthSuccess("Logged in successfully!")
        } else {
          setAuthError(data?.error || "Invalid credentials")
        }
      } catch (e) {
        console.error("Login failed", e)
        setAuthError("Invalid credentials")
      }
    }
  }

  const handleLogout = () => {
    // Clear persisted auth
    authLogout()

    setIsAuthenticated(false)
    setCurrentUser(null)
    setSpaces([])
    setFriends([])
    setEvents([])
    setActiveSpace(null)
    setActiveView("channel")
    setAuthData({ email: "", password: "", confirmPassword: "", name: "" })
    setAuthError("")
    setAuthSuccess("")
    setDmSearchQuery("")
    setSearchQuery("")
    
    // Clear Google data
    GoogleService.removeGoogleAccessToken()
    setGoogleAccessToken(null)
    setGoogleDocs([])
    setGmailAttachments([])
  }

  // --- Google OAuth Handlers ---
  const handleGoogleLogin = () => {
    GoogleService.handleGoogleSignIn(
      async (userInfo, credential) => {
        setAuthError("")
        
        // Check if user exists
        const existingUser = await Storage.findUserByEmail(userInfo.email)
        
        if (existingUser) {
          // Login existing user
          const token = `token_${existingUser.id}_${Date.now()}`
          saveAuth(existingUser, token)
          
          setCurrentUser(existingUser)
          setIsAuthenticated(true)
          setAuthSuccess("Logged in with Google successfully!")
        } else {
          // Create new user from Google data
          const newUserId = Date.now()
          
          // Create default space
          const defaultSpace = {
            id: newUserId + 1,
            name: "Space 1",
            iconType: "briefcase",
            members: [newUserId],
            inviteCode: `SPACE1-${Math.floor(1000 + Math.random() * 9000)}`,
            channels: [
              {
                id: newUserId + 2,
                name: "general",
                type: "public",
                members: [newUserId]
              },
              {
                id: newUserId + 3,
                name: "random",
                type: "public",
                members: [newUserId]
              }
            ],
            expanded: true,
            ownerId: newUserId
          }
          await Storage.saveSpace(defaultSpace)
          
          // Create new user
          const newUser = {
            id: newUserId,
            name: userInfo.name || userInfo.email.split('@')[0],
            email: userInfo.email,
            password: '', // No password for Google OAuth users
            avatar: userInfo.picture ? 'ðŸ”µ' : 'ðŸ‘¤',
            status: "online",
            spaces: [defaultSpace.id],
            dms: [],
            friends: [],
            notifications: [],
            integrations: {
              google: {
                connected: true,
                email: userInfo.email
              }
            }
          }
          await Storage.saveUser(newUser)
          
          // Generate a simple token for the new user
          const token = `token_${newUserId}_${Date.now()}`
          saveAuth(newUser, token)
          
          setCurrentUser(newUser)
          setIsAuthenticated(true)
          setActiveSpace(defaultSpace.id)
          setActiveChannel(defaultSpace.channels[0].id)
          setAuthSuccess("Account created with Google successfully!")
        }
      },
      (error) => {
        console.error('Google Sign-In Error:', error)
        
        // Check if it's an origin error
        if (error && (error.includes?.('origin') || error.includes?.('client ID'))) {
          setAuthError("Google Sign-In configuration error. Please use regular email/password login.")
        } else {
          setAuthError("Google sign-in temporarily unavailable. Please use email/password login.")
        }
      }
    )
  }

  const handleConnectGoogleDocs = () => {
    GoogleService.requestGoogleDocsAccess(
      (accessToken) => {
        setGoogleAccessToken(accessToken)
        GoogleService.setGoogleAccessToken(accessToken)
        // Mark initial apps as connected
        setConnectedApps(['drive', 'gmail'])
        // Automatically load docs after connection
        loadGoogleDocs(accessToken)
      },
      (error) => {
        setDocsError("Failed to connect Google account. Please ensure you've granted all permissions and that the Google Drive API and Gmail API are enabled in your Google Cloud Console.")
      }
    )
  }

  const handleConnectSpecificApp = (appType) => {
    if (!googleAccessToken) {
      handleConnectGoogleDocs()
      return
    }
    
    // Add app to connected apps if not already there
    if (!connectedApps.includes(appType)) {
      setConnectedApps(prev => [...prev, appType])
    }
    
    setShowConnectAppsModal(false)
    loadGoogleDocs(googleAccessToken, appType)
  }

  const loadGoogleDocs = async (token, specificApp = null) => {
    setLoadingDocs(true)
    setDocsError(null)
    
    try {
      // Fetch Google Drive files first
      let driveFiles = []
      try {
        driveFiles = await GoogleService.fetchGoogleDriveFiles(token, specificApp || 'all')
        setGoogleDocs(driveFiles)
      } catch (driveError) {
        setDocsError(driveError.message || "Failed to load Google Drive files.")
        setGoogleDocs([])
      }
      
      // Try to fetch Gmail attachments (optional - don't fail if this errors)
      if (!specificApp || specificApp === 'gmail') {
        try {
          const gmailFiles = await GoogleService.fetchGmailAttachments(token)
          setGmailAttachments(gmailFiles)
        } catch (gmailError) {
          // Gmail is optional, just log the error
          setGmailAttachments([])
        }
      }
      
      setLoadingDocs(false)
    } catch (error) {
      setDocsError(error.message || "Failed to load documents. Please try again.")
      setLoadingDocs(false)
    }
  }

  // Extract attachments from current in-memory messages for display in Documents modal
  const extractSharedChatDocs = (messagesObj = {}) => {
    const collected = []
    const seen = new Set()

    Object.keys(messagesObj).forEach(chatId => {
      const msgs = messagesObj[chatId] || []
      msgs.forEach(m => {
        if (m && Array.isArray(m.attachments)) {
          m.attachments.forEach(att => {
            try {
              const key = att.webViewLink || att.url || att.id || `${att.name}-${att.size || 0}`
              if (!key || seen.has(key)) return
              seen.add(key)

              collected.push({
                ...att,
                chatId,
                messageId: m.id,
                timestamp: m.timestamp || m.date || null,
                source: att.source || 'chat'
              })
            } catch (e) {
              // ignore per-item errors
            }
          })
        }
      })
    })

    return collected
  }

  const handleDocsClick = () => {
    setShowDocsModal(true)
    
    if (googleAccessToken) {
      loadGoogleDocs(googleAccessToken)
    }
    // Populate shared chat docs from currently loaded messages
    setSharedChatDocs(extractSharedChatDocs(messages))
  }

  // Keep shared chat docs up-to-date while the modal is open
  useEffect(() => {
    if (!showDocsModal) return
    setSharedChatDocs(extractSharedChatDocs(messages))
  }, [showDocsModal, messages])

  // Add document as attachment to message input
  const addDocumentAsAttachment = (doc) => {
    const newAttachment = {
      id: Date.now() + Math.random(),
      name: doc.name,
      size: 0, // Google Docs don't have a file size in the traditional sense
      type: doc.mimeType,
      url: doc.webViewLink,
      source: "drive",
      thumbnailLink: doc.thumbnailLink,
      iconLink: doc.iconLink
    }
    setSelectedFiles(prev => [...prev, newAttachment])
    
    // Show success message
    setSuccessMessage(`"${doc.name}" added to message`)
    setShowSuccessToast(true)
    setTimeout(() => setShowSuccessToast(false), 3000)
  }

  // Connect Google Calendar
  const handleConnectGoogleCalendar = () => {
    GoogleService.requestGoogleCalendarAccess(
      (accessToken) => {
        setGoogleCalendarToken(accessToken)
        GoogleService.setGoogleCalendarToken(accessToken)
        loadGoogleCalendarEvents(accessToken)
        setShowCalendarConnectModal(false)
        // Navigate to calendar view after successful connection
        setActiveView("calendar")
        setActiveSpace(null)
      },
      (error) => {
        console.error('Failed to connect Google Calendar:', error)
        alert('Failed to connect Google Calendar. Please ensure you\'ve granted Calendar permissions.')
      }
    )
  }

  const loadGoogleCalendarEvents = async (token) => {
    try {
      const gEvents = await GoogleService.fetchGoogleCalendarEvents(token)
      setGoogleCalendarEvents(gEvents)

      // Map Google events into app event format and merge into local `events`
      const mapped = (gEvents || [])
        // Ignore ephemeral live Meet events created by the app for immediate calls
        .filter(ge => !(ge.extendedProperties && ge.extendedProperties.private && ge.extendedProperties.private.ephemeral_meet === 'true'))
        .map(ge => {
        const startIso = ge.start?.dateTime || ge.start?.date || null
        const endIso = ge.end?.dateTime || ge.end?.date || null
        const startDate = startIso ? new Date(startIso).toISOString().split('T')[0] : ''
        return {
          id: `gcal-${ge.id}`,
          title: ge.summary || 'Untitled',
          type: ge.conferenceData ? 'meeting' : 'event',
          startDate: startDate,
          startDateTime: startIso,
          endDateTime: endIso,
          description: ge.description || '',
          link: ge.hangoutLink || ge.htmlLink || (ge.conferenceData && ge.conferenceData.entryPoints && ge.conferenceData.entryPoints[0] && ge.conferenceData.entryPoints[0].uri) || null,
          source: 'google'
        }
      })

      setEvents(prev => {
        const others = (prev || []).filter(e => e.source !== 'google')
        return [...others, ...mapped]
      })

      // If any google event is scheduled to start very soon, trigger an incomingCall pop
      try {
        const now = Date.now()
        for (const ge of mapped) {
          if (!ge.startDateTime) continue
          const startTs = new Date(ge.startDateTime).getTime()
          // If event starts within the next 60 seconds and hasn't been alerted yet
          if (startTs >= now && startTs - now <= 60000 && !alertedScheduledRef.current.has(ge.id)) {
            alertedScheduledRef.current.add(ge.id)
            setIncomingCall({
              id: ge.id,
              fromId: null,
              fromName: ge.title || 'Scheduled Meeting',
              fromAvatar: 'ðŸ“…',
              link: ge.link || null,
              title: ge.title,
              timestamp: startTs
            })
          }
        }
      } catch (e) {
        // ignore scheduling alert errors
      }
    } catch (error) {
      console.error('Failed to load calendar events:', error)
    }
  }

  // Poll Google Calendar regularly when connected (near real-time sync)
  useEffect(() => {
    if (!googleCalendarToken) return
    // Initial load already handled by connect flow, but ensure we fetch here too
    loadGoogleCalendarEvents(googleCalendarToken)
    const id = setInterval(() => loadGoogleCalendarEvents(googleCalendarToken), 30000)
    return () => clearInterval(id)
  }, [googleCalendarToken])

  // Video call helpers
  const toggleCallMember = (userId) => {
    setSelectedCallMembers(prev => prev.includes(userId) ? prev.filter(id => id !== userId) : [...prev, userId])
  }

  const createMeetCall = async ({callEveryone = false} = {}) => {
    if (!currentUser) return
    const members = getActiveMembers()
    const targets = callEveryone ? members.filter(m => m.id !== currentUser.id) : members.filter(m => selectedCallMembers.includes(m.id))
    const emails = targets.map(t => t.email).filter(Boolean)

    // Ensure we have a calendar token with write access
    let token = GoogleService.getGoogleCalendarToken()
    if (!token) {
      // request interactive permission
      try {
        await new Promise((resolve, reject) => {
          GoogleService.requestGoogleCalendarAccess((accessToken) => { token = accessToken; GoogleService.setGoogleCalendarToken(accessToken); resolve() }, err => reject(err))
        })
      } catch (err) {
        alert('Google Calendar access is required to create Meet links.')
        return
      }
    }
    setCallCreating(true)
    let triedRefresh = false
    try {
      const attemptCreate = async () => {
        const start = new Date()
        const end = new Date(start.getTime() + 30 * 60000)
        const ev = await GoogleService.createCalendarEvent(token, {
          summary: `${getActiveViewName().replace('#','').trim()} â€” ${currentUser.name}`,
          description: `Video call started by ${currentUser.name}`,
          startDateTime: start.toISOString(),
          endDateTime: end.toISOString(),
          attendees: emails,
          ephemeral: true
        })
        return ev
      }

      let ev
      try {
        ev = await attemptCreate()
      } catch (err) {
        const msg = (err && err.message) || ''
        if (!triedRefresh && (msg.includes('Invalid or expired token') || msg.includes('Calendar access denied') || msg.includes('401') || msg.includes('403'))) {
          triedRefresh = true
          try {
            await new Promise((resolve, reject) => {
              GoogleService.requestGoogleCalendarAccess((accessToken) => { token = accessToken; GoogleService.setGoogleCalendarToken(accessToken); resolve() }, err2 => reject(err2))
            })
            ev = await attemptCreate()
          } catch (err2) {
            throw err2 || err
          }
        } else {
          throw err
        }
      }

      const meetLink = ev.hangoutLink || (ev.conferenceData && ev.conferenceData.entryPoints && ev.conferenceData.entryPoints[0] && ev.conferenceData.entryPoints[0].uri) || null

      setCurrentMeeting({ event: ev, link: meetLink })

      await Storage.sendMeetInvite({
        organizerId: currentUser.id,
        targetUserIds: targets.map(t => t.id),
        spaceId: activeSpace,
        channelId: activeView === 'channel' ? activeChannel : null,
        meetingLink: meetLink,
        meetingTitle: ev.summary
      })

      if (meetLink) window.open(meetLink, '_blank')

      setShowVideoModal(false)
    } catch (err) {
      console.error('Failed to create Meet call', err)
      const friendly = (err && err.message) ? err.message : 'Failed to create Meet call. Please ensure Calendar permissions are granted.'
      alert(friendly)
    } finally {
      setCallCreating(false)
    }
  }

  const addParticipantsToMeeting = async (additionalUserIds = []) => {
    if (!currentMeeting || !currentMeeting.event) return
    const token = GoogleService.getGoogleCalendarToken()
    if (!token) {
      alert('No calendar token available')
      return
    }

    // Build attendees emails and send notifications; we won't patch the original event attendees for brevity,
    // but we will notify the new participants with the same meet link.
    const targets = users.filter(u => additionalUserIds.includes(u.id))
    await Storage.sendMeetInvite({
      organizerId: currentUser.id,
      targetUserIds: targets.map(t => t.id),
      spaceId: activeSpace,
      channelId: activeView === 'channel' ? activeChannel : null,
      meetingLink: currentMeeting.link,
      meetingTitle: currentMeeting.event.summary
    })
  }

  // --- Helpers ---
  const formatTime = timestamp => {
    try {
      const date = new Date(timestamp)
      return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
    } catch (e) {
      return ""
    }
  }

  // Live relative time for notifications (updates when `timeTicker` changes)
  const [timeTicker, setTimeTicker] = useState(Date.now())

  useEffect(() => {
    const id = setInterval(() => setTimeTicker(Date.now()), 30000)
    return () => clearInterval(id)
  }, [])

  const formatRelativeTime = (timestamp, now = Date.now()) => {
    if (!timestamp) return ""
    const ts = new Date(timestamp).getTime()
    const diff = Math.max(0, now - ts)
    const seconds = Math.floor(diff / 1000)
    if (seconds < 5) return "just now"
    if (seconds < 60) return `${seconds}s ago`
    const minutes = Math.floor(seconds / 60)
    if (minutes < 60) return `${minutes}m ago`
    const hours = Math.floor(minutes / 60)
    if (hours < 24) return `${hours}h ago`
    const days = Math.floor(hours / 24)
    if (days < 7) return `${days}d ago`
    return new Date(timestamp).toLocaleDateString()
  }

  // Date label for chat header (Today / Yesterday / actual date) â€” updates with `timeTicker`
  const formatDateLabel = (timestamp, now = Date.now()) => {
    // Default to Today when we have no timestamp
    if (!timestamp) return "Today"
    const d = new Date(timestamp)
    const n = new Date(now)

    const sameDay = (a, b) =>
      a.getFullYear() === b.getFullYear() &&
      a.getMonth() === b.getMonth() &&
      a.getDate() === b.getDate()

    if (sameDay(d, n)) return "Today"
    const yesterday = new Date(n)
    yesterday.setDate(n.getDate() - 1)
    if (sameDay(d, yesterday)) return "Yesterday"
    return d.toLocaleDateString()
  }

  // Compute the current chat's date label (latest message) and update when relevant state changes
  const messageDateLabel = useMemo(() => {
    try {
      const _msgs = getCurrentMessages() || []
      const _latest = _msgs.length ? _msgs[_msgs.length - 1] : null
      return formatDateLabel(_latest?.timestamp, timeTicker)
    } catch (e) {
      return "Today"
    }
  }, [messages, activeView, activeChannel, activeDMUser, timeTicker])

  // Visible date label (changes while scrolling to indicate the date of messages in view)
  const [visibleDateLabel, setVisibleDateLabel] = useState(messageDateLabel || "Today")

  // --- Dismissed notifications persistence helpers ---
  const dismissedKeyFor = userId => `spaces_dismissed_notifications_${userId}`

  const getDismissedNotifications = userId => {
    if (!userId) return []
    try {
      return JSON.parse(localStorage.getItem(dismissedKeyFor(userId)) || "[]")
    } catch (e) {
      return []
    }
  }

  const addDismissedNotification = (userId, notificationId) => {
    if (!userId || !notificationId) return
    try {
      const key = dismissedKeyFor(userId)
      const arr = JSON.parse(localStorage.getItem(key) || "[]")
      if (!arr.includes(notificationId)) {
        arr.push(notificationId)
        localStorage.setItem(key, JSON.stringify(arr))
      }
    } catch (e) {
      // ignore localStorage errors
    }
  }

  const isNotificationDismissed = (userId, notificationId) => {
    const arr = getDismissedNotifications(userId)
    return arr.includes(notificationId)
  }

  const filterDismissedUser = user => {
    if (!user) return user
    const dismissed = getDismissedNotifications(user.id)
    if (!dismissed || dismissed.length === 0) return user
    return { ...user, notifications: (user.notifications || []).filter(n => !dismissed.includes(n.id)) }
  }

  const renderWithHighlight = (text, highlight) => {
    if (!highlight || !text) return text
    const escapedHighlight = highlight.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")
    const parts = text.split(new RegExp(`(${escapedHighlight})`, "gi"))
    return parts.map((part, i) =>
      part.toLowerCase() === highlight.toLowerCase() ? (
        <span
          key={i}
          className="bg-yellow-300 text-slate-900 px-0.5 rounded shadow-sm"
        >
          {part}
        </span>
      ) : (
        part
      )
    )
  }

  const getCurrentSpace = () => spaces.find(s => s.id === activeSpace)
  const getCurrentChannels = () => getCurrentSpace()?.channels || []

  // Reactions / Emoji helpers
  const EMOJIS = ['ðŸ‘','â¤ï¸','ðŸ˜‚','ðŸ˜®','ðŸ˜¢','ðŸŽ‰','ðŸ”¥']
  const longPressTimerRef = useRef(null)

  const toggleReaction = async (chatId, messageId, emoji) => {
    if (!chatId || !currentUser) return
    const msgs = messages[chatId] || []
    const idx = msgs.findIndex(m => m.id === messageId)
    if (idx === -1) return
    const msg = { ...msgs[idx] }
    if (!msg.reactions) msg.reactions = {}
    const current = Array.isArray(msg.reactions[emoji]) ? [...msg.reactions[emoji]] : []
    const hasReacted = current.includes(currentUser.id)
    const next = hasReacted ? current.filter(id => id !== currentUser.id) : [...current, currentUser.id]
    if (next.length === 0) delete msg.reactions[emoji]
    else msg.reactions[emoji] = next

    try {
      await Storage.updateMessage(chatId, msg)
      setMessages(prev => ({
        ...prev,
        [chatId]: prev[chatId].map(m => (m.id === msg.id ? msg : m))
      }))
    } catch (e) {
      console.error('Failed to update reaction', e)
    }
  }

  const getActiveChatId = () => {
    if (activeView === "channel") return Number(activeChannel)
    if (activeView === "dm" && activeDMUser && currentUser) {
      const ids = [currentUser.id, activeDMUser].sort((a, b) => a - b)
      return `dm_${ids[0]}_${ids[1]}`
    }
    return null
  }

  const getCurrentMessages = () => {
    const chatId = getActiveChatId()
    return chatId ? messages[chatId] || [] : []
  }

  const getUser = userId => {
    if (currentUser?.id === userId) return currentUser
    const found = users.find(u => u.id === userId) || friends.find(u => u.id === userId)
    return found
  }

  const getActiveMembers = () => {
    if (activeView === "channel") {
      const channel = getCurrentChannels().find(c => c.id === activeChannel)
      if (!channel) return []
      // Bug Fix: Filter out undefined users to prevent white screen if user data isn't synced
      return channel.members.map(id => getUser(id)).filter(u => u !== undefined)
    } else if (activeView === "dm" && activeDMUser && currentUser) {
      const partner = getUser(activeDMUser)
      return partner ? [currentUser, partner] : [currentUser]
    }
    return []
  }

  const MAX_MESSAGE_SEND_RETRIES = 3

  const sanitizeMessagePayload = message => {
    if (!message) return message
    const { status, optimistic, retryCount, previewUrl, data, source, ...rest } = message
    return rest
  }

  // Poll backend for file metadata until it's available (url/status)
  const fetchFileMetadata = async fileId => {
    try {
      const token = getToken()
      const stored = getStoredUser()
      const userId = stored && (stored.id || stored._id || (stored._id && stored._id.$oid) || stored.userId)
      const resp = await fetch(`${API_BASE}/upload/file/${fileId}`, { headers: { ...(token ? { Authorization: `Bearer ${token}` } : {}), ...(userId ? { 'X-User-Id': String(userId) } : {}) } })
      if (!resp.ok) return null
      const json = await resp.json()
      if (json && !json.error) return json
    } catch (e) {
      // ignore
    }
    return null
  }

  const startPollingFileStatus = (fileId) => {
    if (!fileId) return
    let attempts = 0
    const maxAttempts = 30
    const interval = setInterval(async () => {
      attempts += 1
      const meta = await fetchFileMetadata(fileId)
      if (meta) {
        setSelectedFiles(prev => prev.map(f => (String(f.id) === String(fileId) ? { ...f, status: meta.status || f.status, url: meta.url || meta.public_url || f.url } : f)))
        // Also update any messages in current thread that reference this fileId
        setMessages(prev => {
          const key = getActiveChatId()
          if (!key || !prev[key]) return prev
          return {
            ...prev,
            [key]: prev[key].map(m => {
              if (!m.attachments || !m.attachments.length) return m
              const updated = m.attachments.map(att => (String(att.id) === String(fileId) || String(att.fileId) === String(fileId) ? { ...att, url: meta.url || att.url, status: meta.status || att.status } : att))
              return { ...m, attachments: updated }
            })
          }
        })
      }
      if (meta && (meta.status === 'done' || meta.status === 'error')) clearInterval(interval)
      if (attempts >= maxAttempts) clearInterval(interval)
    }, 1500)
  }

  const updateMessageMeta = (chatId, messageId, updater) => {
    if (!chatId || !messageId) return
    setMessages(prev => {
      const list = prev[chatId] || []
      if (!list.length) return prev
      return {
        ...prev,
        [chatId]: list.map(msg => (msg.id === messageId ? updater(msg) : msg))
      }
    })
  }

  const persistMessageWithRetry = (chatId, payload, localId, attempt = 0) => {
    if (!chatId || !localId || !payload) return
    Storage.saveMessage(chatId, payload)
      .then(() => {
        updateMessageMeta(chatId, localId, msg => ({
          ...msg,
          status: "sent",
          optimistic: false
        }))
      })
      .catch(err => {
        if (err && err.status === 403) {
          setShowAccessDeniedModal(true)
          updateMessageMeta(chatId, localId, msg => ({ ...msg, status: "failed" }))
          return
        }

        if (attempt + 1 >= MAX_MESSAGE_SEND_RETRIES) {
          updateMessageMeta(chatId, localId, msg => ({ ...msg, status: "failed" }))
        } else {
          updateMessageMeta(chatId, localId, msg => ({ ...msg, status: "retrying" }))
          const delay = Math.min(5000, 1200 * (attempt + 1))
          setTimeout(() => persistMessageWithRetry(chatId, payload, localId, attempt + 1), delay)
        }
      })
  }

  const retryFailedMessage = (chatId, message) => {
    if (!chatId || !message) return
    const payload = sanitizeMessagePayload(message)
    updateMessageMeta(chatId, message.id, msg => ({
      ...msg,
      status: "sending",
      optimistic: true
    }))

    try {
      if (chatSocketRef.current) {
        chatSocketRef.current.send(payload)
      }
    } catch (wsErr) {
      console.warn("chat socket send failed during retry", wsErr)
    }

    persistMessageWithRetry(chatId, payload, message.id, 0)
  }

  const getActiveViewName = () => {
    if (activeView === "channel") {
      const channels = getCurrentChannels()
      const channel = channels.find(c => c.id === activeChannel)
      return channel ? `# ${channel.name}` : ""
    } else if (activeView === "dm" && activeDMUser) {
      const user = getUser(activeDMUser)
      return user ? user.name : "Unknown User"
    } else if (activeView === "calendar") return "Calendar"
    else if (activeView === "meeting") return "Meeting"
    return ""
  }

  // --- Actions ---

  const handleChannelNavigation = (spaceId, channelId) => {
    if (!currentUser) return
    const space = spaces.find(s => s.id === spaceId)
    if (!space) return
    const channel = space.channels.find(c => c.id === channelId)
    if (!channel) return

    // Access Check: User has access if they own the space OR have it in their spaces list OR are in members array
    // For public channels: space members have access
    // For private channels: need to be channel member
    const userOwnsSpace = space.ownerId === currentUser.id
    const userHasSpace = (currentUser.spaces || []).includes(spaceId)
    const userInSpaceMembers = (space.members || []).includes(currentUser.id)
    
    const hasAccess =
      userOwnsSpace || userHasSpace || 
      (channel.type === "public" ? userInSpaceMembers : (channel.members || []).includes(currentUser.id))

  if (hasAccess) {
    setActiveSpace(spaceId)
    setActiveChannel(channelId)
    setActiveView("channel")
    // Indicate a manual thread switch so scroll logic jumps directly to latest (no long smooth animation)
    justSwitchedThreadRef.current = true
  } else {
    setShowAccessDeniedModal(true)
  }
}

  const handleFileSelect = async e => {
    if (e.target.files && e.target.files.length > 0) {
      setIsUploading(true)
      const files = Array.from(e.target.files)
      // Upload concurrently
      const uploadPromises = files.map(async file => {
        const previewUrl = URL.createObjectURL(file)
        try {
          const form = new FormData()
          form.append('file', file)
          const token = getToken()
          const stored = getStoredUser()
          const userId = stored && (stored.id || stored._id || (stored._id && stored._id.$oid) || stored.userId)
          const resp = await fetch(`${API_BASE}/upload/file`, { method: 'POST', body: form, headers: { ...(token ? { Authorization: `Bearer ${token}` } : {}), ...(userId ? { 'X-User-Id': String(userId) } : {}) } })
          if (!resp.ok) throw new Error('Upload failed')
          const data = await resp.json()
          const id = data.file_id || `tmp-${Date.now()}-${Math.floor(Math.random()*1000)}`
          // start polling for drive url
          startPollingFileStatus(id)
          return {
            id,
            name: file.name,
            size: file.size,
            type: file.type,
            fileId: data.file_id || null,
            status: 'uploading',
            source: 'uploaded',
            previewUrl
          }
        } catch (err) {
          return {
            id: `tmp-${Date.now()}-${Math.floor(Math.random()*1000)}`,
            name: file.name,
            size: file.size,
            type: file.type,
            status: 'error',
            source: 'local',
            previewUrl
          }
        }
      })

      const newAttachments = await Promise.all(uploadPromises)
      setSelectedFiles(prev => [...prev, ...newAttachments])
      setIsUploading(false)
      if (fileInputRef.current) fileInputRef.current.value = ''
    }
  }

  const removeAttachment = id => {
    setSelectedFiles(prev => prev.filter(f => f.id !== id))
  }

  // Open confirmation modal to remove a member from a channel (owner-only action)
  const handleRemoveMember = memberId => {
    if (!memberId || !activeSpace) return
    const memberName = getUser(memberId)?.name || ""
    setShowRemoveMemberConfirm({ id: memberId, name: memberName })
  }

  // Confirm and perform the removal
  const confirmRemoveMember = async () => {
    if (!showRemoveMemberConfirm || !activeSpace) return
    const memberId = showRemoveMemberConfirm.id
    try {
      await Storage.removeMemberFromSpace(memberId, activeSpace, activeChannel)

      // Refresh spaces for current user so UI updates accurately
      try {
        const sps = await Storage.getSpacesForUser(currentUser.spaces)
        const enrichedSpaces = sps.map(s => ({
          ...s,
          icon:
            s.iconType === "graduation" ? (
              <GraduationCap className="w-5 h-5" />
            ) : s.iconType === "briefcase" ? (
              <Briefcase className="w-5 h-5" />
            ) : (
              <UserIcon className="w-5 h-5" />
            )
        }))
        setSpaces(enrichedSpaces)
      } catch (e) {
        console.error('Failed to refresh spaces after remove', e)
      }

    } catch (e) {
      console.error('Failed to remove member', e)
    } finally {
      setShowRemoveMemberConfirm(null)
    }
  }

  const sendMessage = async () => {
    if ((!messageInput.trim() && selectedFiles.length === 0) || !currentUser)
      return
    const chatId = getActiveChatId()
    if (!chatId) return

    const attachments = selectedFiles.map(file => ({ ...file }))
    const tempId = `tmp-${Date.now()}-${Math.floor(Math.random() * 1000)}`
    const newMsg = {
      id: tempId,
      userId: currentUser.id,
      text: messageInput,
      timestamp: new Date().toISOString(),
      reactions: {},
      thread: [],
      attachments,
      status: "sending",
      optimistic: true
    }

    setMessages(prev => ({
      ...prev,
      [chatId]: [...(prev[chatId] || []), newMsg]
    }))
    setMessageInput("")
    setSelectedFiles([])

    const payload = sanitizeMessagePayload(newMsg)

    try {
      if (chatSocketRef.current) {
        chatSocketRef.current.send(payload)
      }
    } catch (wsErr) {
      console.warn('chat socket send failed', wsErr)
    }

    persistMessageWithRetry(chatId, payload, newMsg.id, 0)
  }

  // Helper to open or download attachments
  const openAttachment = att => {
    if (!att) return
    const url = att.url || att.public_url || att.previewUrl
    if (url) {
      window.open(url, "_blank")
      return
    }
    // If we only have a fileId, try to fetch metadata and open
    const fid = att.fileId || att.id
    if (fid) {
      (async () => {
        const meta = await fetchFileMetadata(fid)
        if (meta && (meta.url || meta.public_url)) window.open(meta.url || meta.public_url, "_blank")
      })()
    }
  }

  const downloadAttachment = async att => {
    if (!att) return
    const url = att.url || att.public_url
    if (url) {
      window.open(url, "_blank")
      return
    }

    if (att.previewUrl) {
      // download the blob from previewUrl
      try {
        const res = await fetch(att.previewUrl)
        const blob = await res.blob()
        const url2 = URL.createObjectURL(blob)
        const a = document.createElement("a")
        a.href = url2
        a.download = att.name || "attachment"
        document.body.appendChild(a)
        a.click()
        a.remove()
        URL.revokeObjectURL(url2)
      } catch (e) {
        console.error("downloadAttachment failed", e)
      }
      return
    }

    // Fallback: try fetching metadata by fileId
    const fid = att.fileId || att.id
    if (fid) {
      const meta = await fetchFileMetadata(fid)
      if (meta && (meta.url || meta.public_url)) window.open(meta.url || meta.public_url, "_blank")
    }
  }

  const createSpace = async () => {
    if (!newSpaceName.trim() || !currentUser) return
    const newSpace = {
      id: Date.now(),
      name: newSpaceName,
      iconType: "user",
      members: [currentUser.id],
      inviteCode: `${newSpaceName.substring(0, 4).toUpperCase()}-${Math.floor(
        1000 + Math.random() * 9000
      )}`,
      channels: [
        {
          id: Date.now() + 1,
          name: "general",
          type: "public",
          members: [currentUser.id]
        },
        {
          id: Date.now() + 2,
          name: "random",
          type: "public",
          members: [currentUser.id]
        }
      ],
      expanded: true,
      ownerId: currentUser.id
    }
    await Storage.saveSpace(newSpace)
    const updatedUser = {
      ...currentUser,
      spaces: [...currentUser.spaces, newSpace.id]
    }
    await Storage.saveUser(updatedUser)
    setCurrentUser(updatedUser)
    setShowCreateSpaceModal(false)
    setNewSpaceName("")
  }

  const createChannel = async () => {
    if (!newChannelName.trim() || !currentUser || !activeSpace) return
    // Removed visibility selection as per requirement
    const newChannel = {
      id: Date.now(),
      name: newChannelName.toLowerCase().replace(/\s+/g, "-"),
      type: "public", // Defaulted
      members: [currentUser.id]
    }
    const space = spaces.find(s => s.id === activeSpace)
    if (space) {
      const updatedSpace = {
        ...space,
        channels: [...space.channels, newChannel]
      }
      await Storage.saveSpace(updatedSpace)
      setSpaces(prev =>
        prev.map(s => (s.id === activeSpace ? updatedSpace : s))
      )
      setMessages(prev => ({ ...prev, [newChannel.id]: [] }))
      setShowChannelModal(false)
      setNewChannelName("")
      setActiveChannel(newChannel.id)
      setActiveView("channel")
    }
  }

  // Management Logic
  const handleRename = async () => {
    if (!showRenameModal || !newNameInput.trim()) return
    if (showRenameModal.type === "space") {
      await Storage.renameSpace(showRenameModal.id, newNameInput)
      setSpaces(prev =>
        prev.map(s =>
          s.id === showRenameModal.id ? { ...s, name: newNameInput } : s
        )
      )
    } else if (showRenameModal.type === "channel" && activeSpace) {
      await Storage.renameChannel(activeSpace, showRenameModal.id, newNameInput)
      setSpaces(prev =>
        prev.map(s => {
          if (s.id === activeSpace) {
            const newChannels = s.channels.map(c =>
              c.id === showRenameModal.id ? { ...c, name: newNameInput } : c
            )
            return { ...s, channels: newChannels }
          }
          return s
        })
      )
    }
    setShowRenameModal(null)
    setNewNameInput("")
  }

  const handleDelete = async () => {
    if (!showDeleteConfirm) return
    if (showDeleteConfirm.type === "space") {
      await Storage.deleteSpace(showDeleteConfirm.id)
      setSpaces(prev => prev.filter(s => s.id !== showDeleteConfirm.id))
      if (activeSpace === showDeleteConfirm.id) setActiveSpace(null)
    } else if (showDeleteConfirm.type === "channel" && activeSpace) {
      await Storage.deleteChannel(activeSpace, showDeleteConfirm.id)
      setSpaces(prev =>
        prev.map(s => {
          if (s.id === activeSpace) {
            return {
              ...s,
              channels: s.channels.filter(c => c.id !== showDeleteConfirm.id)
            }
          }
          return s
        })
      )
      if (activeChannel === showDeleteConfirm.id) {
        const space = spaces.find(s => s.id === activeSpace)
        if (space && space.channels.length > 0) {
          const firstRemaining = space.channels.find(
            c => c.id !== showDeleteConfirm.id
          )
          if (firstRemaining) setActiveChannel(firstRemaining.id)
          else setActiveChannel("")
        }
      }
    }
    setShowDeleteConfirm(null)
  }

  const saveCalendarEvent = async () => {
    if (!currentUser || !newEvent.title.trim()) return
    const dateStr = selectedDate.toISOString().split("T")[0]
    const event = {
      id: Date.now(),
      title: newEvent.title,
      description: newEvent.description,
      startDate: dateStr,
      startTime: newEvent.time,
      duration: 60,
      type: newEvent.type,
      createdBy: currentUser.id,
      attendees: [currentUser.id]
    }
    await Storage.saveEvent(event)
    setEvents(prev => [...prev, event])
    setShowEventModal(false)
    setNewEvent({ title: "", description: "", time: "09:00", type: "meeting" })
  }

  const getDaysInMonth = date => {
    const year = date.getFullYear()
    const month = date.getMonth()
    const daysInMonth = new Date(year, month + 1, 0).getDate()
    const firstDay = new Date(year, month, 1).getDay()
    return { daysInMonth, firstDay }
  }

  const changeMonth = offset => {
    const newDate = new Date(currentDate)
    newDate.setMonth(newDate.getMonth() + offset)
    setCurrentDate(newDate)
  }

  const startVideoCall = async () => {
    if (!VIDEO_ENABLED) return
    if (activeView === "dm" && activeDMUser && currentUser) {
      const partner = getUser(activeDMUser)
      if (partner) {
        const call = await Storage.initiateCall(currentUser, activeDMUser)
        setActiveCallId(call.id)
        setActiveMeetingTitle(`Calling ${partner.name}...`)
        setActiveView("meeting")
      }
    } else {
      setActiveMeetingTitle("Instant Meeting")
      setActiveView("meeting")
    }
  }

  const startMeeting = title => {
    setActiveMeetingTitle(title)
    setActiveView("meeting")
  }

  const answerCall = async () => {
    if (incomingCall) {
      // If the incoming call has a Meet link (scheduled or meet invite), open it
      if (incomingCall.link) {
        try {
          window.open(incomingCall.link, '_blank')
        } catch (e) {}
        setActiveCallId(incomingCall.id)
        setActiveMeetingTitle(`Call with ${incomingCall.fromName || incomingCall.title}`)
        setActiveView("meeting")
        // Clear any auto-dismiss timer
        try { if (incomingTimeoutRef.current) { clearTimeout(incomingTimeoutRef.current); incomingTimeoutRef.current = null } } catch(e){}
        setIncomingCall(null)
        return
      }

      await Storage.updateCallStatus(incomingCall.id, "accepted")
      setActiveCallId(incomingCall.id)
      setActiveMeetingTitle(`Call with ${incomingCall.fromName}`)
      setActiveView("meeting")
      // Clear any auto-dismiss timer
      try { if (incomingTimeoutRef.current) { clearTimeout(incomingTimeoutRef.current); incomingTimeoutRef.current = null } } catch(e){}
      setIncomingCall(null)
    }
  }

  const declineCall = async () => {
    if (incomingCall) {
      // If scheduled event (has link) simply dismiss
      if (incomingCall.link) {
        // Clear any auto-dismiss timer
        try { if (incomingTimeoutRef.current) { clearTimeout(incomingTimeoutRef.current); incomingTimeoutRef.current = null } } catch(e){}
        setIncomingCall(null)
        return
      }
      await Storage.updateCallStatus(incomingCall.id, "rejected")
        try { if (incomingTimeoutRef.current) { clearTimeout(incomingTimeoutRef.current); incomingTimeoutRef.current = null } } catch(e){}
        setIncomingCall(null)
    }
  }

  const endCall = async () => {
    if (activeCallId) {
      await Storage.updateCallStatus(activeCallId, "ended")
    }
    setActiveView("channel")
    setActiveCallId(null)
  }

  const toggleMic = () => {
    setIsMicOn(!isMicOn)
    if (videoRef.current?.srcObject) {
      videoRef.current.srcObject
        .getAudioTracks()
        .forEach(t => (t.enabled = !isMicOn))
    }
  }

  const toggleVideo = () => {
    setIsVideoOn(!isVideoOn)
    if (videoRef.current?.srcObject) {
      videoRef.current.srcObject
        .getVideoTracks()
        .forEach(t => (t.enabled = !isVideoOn))
    }
  }

  const sendFriendRequest = async targetId => {
    if (!currentUser) return
    const target = users.find(u => u.id === targetId)
    if (!target) return

    await Storage.sendFriendRequest(currentUser.id, currentUser.name, target.id)
  }

  const handleBulkFriendInvite = async () => {
    if (selectedFriendInvitees.length === 0) return
    for (const id of selectedFriendInvitees) {
      // await each to ensure backend compatibility
      // errors are intentionally not thrown to keep UI flow
      // eslint-disable-next-line no-await-in-loop
      await sendFriendRequest(id)
    }

    setInviteSent(true)
    setTimeout(() => {
      setShowAddFriendModal(false)
      setInviteSearchQuery("")
      setSelectedFriendInvitees([])
      setInviteSent(false)
    }, 2000)
  }

  const toggleFriendSelection = userId => {
    setSelectedFriendInvitees(prev =>
      prev.includes(userId)
        ? prev.filter(id => id !== userId)
        : [...prev, userId]
    )
  }

  const addFriendsToChannel = async () => {
    if (
      selectedInviteUsers.length === 0 ||
      !currentUser ||
      !activeSpace ||
      !activeChannel
    )
      return

    // Use the new Bulk Add function
    await Storage.addBulkMembersToChannel(
      selectedInviteUsers,
      activeSpace,
      Number(activeChannel)
    )

    setInviteSent(true)
    setTimeout(() => {
      setShowAddToSpaceModal(false)
      setSelectedInviteUsers([])
      setInviteSent(false)
      const updatedSpace = Storage.getSpaces().find(s => s.id === activeSpace)
      if (updatedSpace) {
        setSpaces(prev =>
          prev.map(s => {
            if (s.id === activeSpace) {
              // Preserve ReactNode icon and local UI state (expanded) from current state
              // Fixes the white screen crash
              return {
                ...updatedSpace,
                icon: s.icon,
                expanded: s.expanded
              }
            }
            return s
          })
        )
      }
    }, 1500)
  }

  const toggleInviteSelection = userId => {
    setSelectedInviteUsers(prev =>
      prev.includes(userId)
        ? prev.filter(id => id !== userId)
        : [...prev, userId]
    )
  }

  const handleNotificationAction = async (notificationId, type) => {
    if (!currentUser) return

    // Find the notification object from currentUser's notifications
    const notif = (currentUser.notifications || []).find(n => n.id === notificationId)

    if (type === "info") {
      await Storage.deleteNotification(currentUser.id, notificationId)
      // Refresh users and currentUser from server
      const allUsers = await Storage.getUsers()
      setUsers(Array.isArray(allUsers) ? allUsers : [])
      const updatedUser = (allUsers || []).find(u => u.id === currentUser.id)
      if (updatedUser) setCurrentUser(filterDismissedUser(updatedUser))
    } else if (type === "friend_request") {
      const friendId = notif?.fromId
      if (!friendId) return
      await Storage.acceptFriendRequest(friendId, notificationId)
      // Refresh users and currentUser from server so friend lists and notifications stay in sync
      const allUsers = await Storage.getUsers()
      setUsers(Array.isArray(allUsers) ? allUsers : [])
      const updatedUser = (allUsers || []).find(u => u.id === currentUser.id)
      if (updatedUser) setCurrentUser(filterDismissedUser(updatedUser))
    } else {
      const joinedSpace = await Storage.acceptInvite(currentUser.id, notificationId)
      // Force refresh user regardless of joinedSpace result to ensure notification is gone
      const allUsers = await Storage.getUsers()
      setUsers(Array.isArray(allUsers) ? allUsers : [])
      const updatedUser = (allUsers || []).find(u => u.id === currentUser.id)
      if (updatedUser) {
        setCurrentUser(filterDismissedUser(updatedUser))
        if (joinedSpace) {
          setActiveSpace(joinedSpace.id)
          setActiveView("channel")
          if (joinedSpace.channels.length > 0) {
            const firstChannel = joinedSpace.channels[0]
            // User has access if they own the space OR have it in their spaces list
            const userOwnsSpace = joinedSpace.ownerId === currentUser.id
            const userHasSpace = (updatedUser.spaces || []).includes(joinedSpace.id)
            const hasAccess = userOwnsSpace || userHasSpace
            if (hasAccess) {
              setActiveChannel(firstChannel.id)
            }
          }
        }
      }
    }
  }

  const handleRejectNotification = async (notificationId, type) => {
    if (!currentUser) return

    // Find the notification to extract sender id
    const notif = (currentUser.notifications || []).find(n => n.id === notificationId)

    if (type === "friend_request") {
      const friendId = notif?.fromId
      if (!friendId) return
      await Storage.rejectFriendRequest(friendId, notificationId)
    } else {
      await Storage.rejectInvite(currentUser.id, notificationId)
    }

    // Refresh users and currentUser
    const allUsers = await Storage.getUsers()
    setUsers(Array.isArray(allUsers) ? allUsers : [])
    const updatedUser = (allUsers || []).find(u => u.id === currentUser.id)
    if (updatedUser) setCurrentUser(filterDismissedUser(updatedUser))
  }

  // Optimistic dismiss for simple info notifications
  const dismissNotification = async (notificationId) => {
    if (!currentUser) return

    // Persist dismissed id locally so it never re-appears
    addDismissedNotification(currentUser.id, notificationId)

    // Optimistically remove from UI
    setCurrentUser(prev => ({
      ...prev,
      notifications: (prev.notifications || []).filter(n => n.id !== notificationId)
    }))

    try {
      await Storage.deleteNotification(currentUser.id, notificationId)
    } catch (e) {
      console.error('dismissNotification failed', e)
      // On failure, refetch full user to ensure consistency and re-apply dismissed filter
      const allUsers = await Storage.getUsers()
      setUsers(Array.isArray(allUsers) ? allUsers : [])
      const updatedUser = (allUsers || []).find(u => u.id === currentUser.id)
      if (updatedUser) setCurrentUser(filterDismissedUser(updatedUser))
    }
  }

  // Clear only 'info' type notification messages (keep invites/friend requests)
  const clearAllNotifications = async () => {
    if (!currentUser) return
    const infos = (currentUser.notifications || []).filter(n => n.type === 'info')
    if (infos.length === 0) return

    // Persist dismissed ids locally
    infos.forEach(i => addDismissedNotification(currentUser.id, i.id))

    // Optimistically remove info notifications from UI
    setCurrentUser(prev => ({
      ...prev,
      notifications: (prev.notifications || []).filter(n => n.type !== 'info')
    }))

    try {
      await Promise.all(infos.map(n => Storage.deleteNotification(currentUser.id, n.id)))
    } catch (e) {
      console.error('clearAllNotifications failed', e)
      // On failure, refetch full user to ensure consistency and re-apply filter
      const allUsers = await Storage.getUsers()
      setUsers(Array.isArray(allUsers) ? allUsers : [])
      const updatedUser = (allUsers || []).find(u => u.id === currentUser.id)
      if (updatedUser) setCurrentUser(filterDismissedUser(updatedUser))
    }
  }

  const toggleSpaceExpansion = spaceId => {
    setSpaces(prev =>
      prev.map(space =>
        space.id === spaceId ? { ...space, expanded: !space.expanded } : space
      )
    )
  }

  // --- Render ---

  if (!isAuthenticated) {
    return (
      <div className="min-h-screen flex items-center justify-center p-6 font-sans relative overflow-hidden bg-gradient-to-br from-indigo-50 via-white to-purple-50 text-slate-900">
        <div className="w-full max-w-md animate-fade-in relative z-10">
          <div className="text-center mb-10">
            <div className="inline-flex items-center justify-center w-24 h-24 rounded-[2rem] mb-6 shadow-2xl transform hover:scale-105 hover:rotate-6 transition-all duration-300 bg-gradient-to-tr from-indigo-600 to-purple-600 shadow-indigo-200">
              <Sparkles className="w-12 h-12 text-white" />
            </div>
            <h1 className="text-5xl font-extrabold mb-3 tracking-tight text-slate-900">
              Spaces
            </h1>
            <p className="text-lg font-medium text-slate-500">
              Where squads and pros collide.
            </p>
          </div>

          <div className="rounded-[2rem] overflow-hidden p-1 bg-white/80 backdrop-blur-xl shadow-2xl border border-white/50">
            <div className="flex p-1 rounded-[1.8rem] mb-2 bg-slate-100">
              <button
                onClick={() => setAuthMode("login")}
                className={`flex-1 py-3 px-6 text-center font-bold text-sm rounded-3xl transition-all duration-300 ${
                  authMode === "login"
                    ? "bg-white text-indigo-600 shadow-sm"
                    : "text-slate-400 hover:text-slate-600"
                }`}
              >
                Sign In
              </button>
              <button
                onClick={() => setAuthMode("signup")}
                className={`flex-1 py-3 px-6 text-center font-bold text-sm rounded-3xl transition-all duration-300 ${
                  authMode === "signup"
                    ? "bg-white text-indigo-600 shadow-sm"
                    : "text-slate-400 hover:text-slate-600"
                }`}
              >
                Sign Up
              </button>
            </div>
            <form onSubmit={handleAuthSubmit} className="p-8 space-y-5">
              {authSuccess && (
                <div className="px-4 py-3 rounded-2xl text-sm flex items-center gap-3 bg-emerald-50 border border-emerald-200 text-emerald-700">
                  <CheckCircle className="w-5 h-5" />
                  {authSuccess}
                </div>
              )}
              {authError && (
                <div className="px-4 py-3 rounded-2xl text-sm flex items-center gap-3 bg-red-50 border border-red-200 text-red-700">
                  <XCircle className="w-5 h-5" />
                  {authError}
                </div>
              )}

              {authMode === "signup" && (
                <div className="group">
                  <label className="block text-[10px] font-bold uppercase tracking-widest mb-2 ml-1 text-slate-400">
                    Full Name
                  </label>
                  <input
                    type="text"
                    value={authData.name}
                    onChange={e =>
                      setAuthData({ ...authData, name: e.target.value })
                    }
                    className="w-full px-5 py-4 rounded-2xl focus:outline-none focus:ring-2 focus:ring-pink-500/50 focus:border-transparent transition-all font-medium bg-slate-50 border border-slate-200 text-slate-800"
                    placeholder="Jane Doe"
                  />
                </div>
              )}
              <div className="group">
                <label className="block text-[10px] font-bold uppercase tracking-widest mb-2 ml-1 text-slate-400">
                  Email
                </label>
                <input
                  type="email"
                  value={authData.email}
                  onChange={e =>
                    setAuthData({ ...authData, email: e.target.value })
                  }
                  className="w-full px-5 py-4 rounded-2xl focus:outline-none focus:ring-2 focus:ring-pink-500/50 focus:border-transparent transition-all font-medium bg-slate-50 border border-slate-200 text-slate-800"
                  placeholder="jane@example.com"
                />
              </div>
              <div className="group">
                <label className="block text-[10px] font-bold uppercase tracking-widest mb-2 ml-1 text-slate-400">
                  Password
                </label>
                <input
                  type="password"
                  value={authData.password}
                  onChange={e =>
                    setAuthData({ ...authData, password: e.target.value })
                  }
                  className="w-full px-5 py-4 rounded-2xl focus:outline-none focus:ring-2 focus:ring-pink-500/50 focus:border-transparent transition-all font-medium bg-slate-50 border border-slate-200 text-slate-800"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                />
              </div>
              {authMode === "signup" && (
                <div className="group">
                  <label className="block text-[10px] font-bold uppercase tracking-widest mb-2 ml-1 text-slate-400">
                    Confirm Password
                  </label>
                  <input
                    type="password"
                    value={authData.confirmPassword}
                    onChange={e =>
                      setAuthData({
                        ...authData,
                        confirmPassword: e.target.value
                      })
                    }
                    className="w-full px-5 py-4 rounded-2xl focus:outline-none focus:ring-2 focus:ring-pink-500/50 focus:border-transparent transition-all font-medium bg-slate-50 border border-slate-200 text-slate-800"
                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  />
                </div>
              )}
              <button
                type="submit"
                className="w-full py-4 font-bold rounded-2xl transition-all flex items-center justify-center gap-2 transform active:scale-[0.98] mt-4 bg-indigo-600 hover:bg-indigo-700 text-white hover:shadow-lg hover:shadow-indigo-500/30"
              >
                {authMode === "login" ? (
                  <>
                    <LogIn className="w-5 h-5" /> Enter Space
                  </>
                ) : (
                  <>
                    <UserPlusIcon className="w-5 h-5" /> Join the Crew
                  </>
                )}
              </button>

              {/* Google Sign-In Divider */}
              <div className="relative my-6">
                <div className="absolute inset-0 flex items-center">
                  <div className="w-full border-t border-slate-200"></div>
                </div>
                <div className="relative flex justify-center text-xs uppercase">
                  <span className="bg-white px-3 text-slate-500 font-bold">Or continue with</span>
                </div>
              </div>

              {/* Google Sign-In Button */}
              <button
                type="button"
                onClick={handleGoogleLogin}
                className="w-full py-4 font-bold rounded-2xl transition-all flex items-center justify-center gap-3 transform active:scale-[0.98] bg-white border-2 border-slate-200 text-slate-700 hover:bg-slate-50 hover:border-slate-300 hover:shadow-md"
              >
                <svg className="w-5 h-5" viewBox="0 0 24 24">
                  <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                  <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                  <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                  <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
              </button>
            </form>
          </div>
        </div>
      </div>
    )
  }

  // --- Authenticated App UI ---
  const activeMembers = getActiveMembers()

  return (
    <div className="flex h-screen overflow-hidden font-sans transition-colors duration-300 text-slate-900 bg-slate-50">
      {/* ... (Incoming Call Modal) ... */}
      {incomingCall && (
        <div className="fixed inset-0 z-[60] backdrop-blur-xl flex flex-col items-center justify-center animate-fade-in bg-slate-900/80">
          <div className="text-center mb-12">
            <div className="relative inline-block mb-8">
              <div className="absolute inset-0 bg-pink-500 rounded-full animate-ping opacity-50 blur-xl"></div>
              <div className="relative w-32 h-32 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-full flex items-center justify-center text-6xl shadow-2xl border-4 border-white/20">
                {incomingCall.fromAvatar}
              </div>
            </div>
            <h2 className="text-4xl font-bold text-white mb-3 tracking-tight">
              {incomingCall.fromName}
            </h2>
            <p className="text-pink-300 text-lg font-medium animate-pulse">
              Incoming Video Call...
            </p>
          </div>
          <div className="flex items-center gap-10">
            <button
              onClick={declineCall}
              className="w-20 h-20 rounded-full bg-red-500/20 border border-red-500/50 text-red-400 hover:bg-red-500 hover:text-white flex items-center justify-center shadow-lg backdrop-blur-md transition-all hover:scale-110"
            >
              <PhoneOff className="w-8 h-8" />
            </button>
            <button
              onClick={answerCall}
              className="w-24 h-24 rounded-full bg-emerald-500 hover:bg-emerald-400 text-white flex items-center justify-center shadow-2xl shadow-emerald-500/30 transition-all hover:scale-110 animate-bounce"
            >
              <Video className="w-10 h-10" />
            </button>
          </div>
        </div>
      )}

      {/* Video Call Modal */}
      {showVideoModal && (
        <div className="fixed inset-0 backdrop-blur-md flex items-center justify-center z-50 p-6 animate-fade-in bg-slate-900/40">
          <div className="rounded-[2rem] p-6 w-full max-w-lg shadow-2xl bg-white ring-1 ring-slate-900/5">
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-3xl font-bold text-slate-800">Start Video Call</h3>
              <button onClick={() => setShowVideoModal(false)} className="p-2 rounded-full transition-colors hover:bg-slate-100 text-slate-500"><X className="w-6 h-6"/></button>
            </div>

            <div className="space-y-4">
                <button
                  onClick={() => createMeetCall({callEveryone: true})}
                  disabled={callCreating}
                  className="flex-1 py-3 rounded-2xl font-bold bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-60"
                >
                  Call Everyone
                </button>
                <button
                  onClick={() => setSelectedCallMembers([])}
                  className="py-3 px-4 rounded-2xl font-bold border bg-white"
                >
                  Select Members
                </button>
              </div>

                          
              {/* Member selection */}
              <div className="max-h-56 overflow-y-auto rounded-2xl border p-3 bg-slate-50">
                {getActiveMembers().map(m => (
                  <label key={m.id} className="flex items-center gap-3 p-2 rounded-lg hover:bg-white cursor-pointer">
                    <input type="checkbox" checked={selectedCallMembers.includes(m.id)} onChange={() => toggleCallMember(m.id)} disabled={m.id === currentUser?.id} />
                    <div className="flex-1">
                      <div className="font-bold text-sm">{m.name}</div>
                      <div className="text-xs text-slate-500">{m.email || ''}</div>
                    </div>
                  </label>
                ))}
              </div>

              <div className="flex items-center gap-3 justify-end">
                <button onClick={() => setShowVideoModal(false)} className="px-4 py-2 rounded-2xl border">Cancel</button>
                <button
                  onClick={() => createMeetCall({callEveryone: false})}
                  disabled={callCreating || selectedCallMembers.length === 0}
                  className="px-4 py-2 rounded-2xl bg-indigo-600 text-white disabled:opacity-60"
                >
                  {activeView === 'dm' ? 'Start Call' : 'Create Call'}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Left Sidebar - SPACES */}
      <div
        className={`${
          sidebarCollapsed ? "w-20" : "w-80"
        } flex flex-col transition-all duration-300 z-20 flex-shrink-0 bg-white border-r border-slate-200/60`}
      >
        {/* ... (Sidebar Content) ... */}
        <div className="p-6 flex items-center justify-between h-[80px] border-b border-slate-100">
          {!sidebarCollapsed && (
            <div
              className="flex items-center gap-3 animate-fade-in cursor-pointer group"
              onClick={() => {
                if (!googleCalendarToken) {
                  setShowCalendarConnectModal(true)
                } else {
                  setActiveView("calendar")
                  setActiveSpace(null)
                }
              }}
            >
              <div className="p-2 rounded-xl shadow-lg transition-all bg-indigo-600 shadow-indigo-200">
                <Sparkles className="w-5 h-5 text-white" />
              </div>
              <h1 className="font-extrabold text-xl tracking-tight text-slate-800">
                Spaces
              </h1>
            </div>
          )}
          <div className="flex gap-2 ml-auto">
            {!sidebarCollapsed && (
              <button
                onClick={() => setShowCreateSpaceModal(true)}
                className="p-2 rounded-xl transition-colors hover:bg-slate-100 text-slate-400 hover:text-indigo-600"
              >
                <Plus className="w-5 h-5" />
              </button>
            )}
            <button
              onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
              className="p-2 rounded-xl transition-colors hover:bg-slate-100 text-slate-400"
            >
              <Menu className="w-5 h-5" />
            </button>
          </div>
        </div>

        {!sidebarCollapsed && (
          <div className="px-5 pt-6 pb-2 animate-fade-in">
            <div className="relative group">
              <Search className="absolute left-4 top-3.5 w-4 h-4 transition-colors text-slate-400 group-focus-within:text-indigo-500" />
              <input
                type="text"
                placeholder="Find a space..."
                value={searchQuery}
                onChange={e => setSearchQuery(e.target.value)}
                className="w-full pl-11 pr-4 py-3 rounded-2xl text-sm focus:outline-none transition-all bg-slate-100/50 border border-slate-200/50 focus:bg-white focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 text-slate-800"
              />
            </div>
          </div>
        )}

        <div className="flex-1 overflow-y-auto scrollbar-thin px-4 py-4 space-y-6">
          {!sidebarCollapsed ? (
            <div className="animate-fade-in">
              {/* Conditional Rendering: Show Search Results or Standard Tree */}
              {debouncedSearchQuery.trim().length > 0 ? (
                <div className="space-y-4">
                  <div className="px-2 mb-1 flex items-center justify-between">
                    <span className="text-[10px] font-black uppercase tracking-widest text-slate-400">
                      Search Results
                    </span>
                    <span className="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-100 text-slate-500">
                      {spaceSearchResults.length}
                    </span>
                  </div>
                  {spaceSearchResults.length === 0 ? (
                    <div className="text-center py-8 text-slate-500 text-xs font-medium">
                      No results found
                    </div>
                  ) : (
                    spaceSearchResults.map(result => (
                      <div
                        key={result.id}
                        onClick={() => {
                          if (result.spaceId && result.channelId) {
                            handleChannelNavigation(
                              result.spaceId,
                              result.channelId
                            )

                            // Highlight the search query in the channel
                            setHighlightTerm(debouncedSearchQuery)

                            if (result.messageId) {
                              // Scroll to the message and pin it for review
                              setTargetMessageId(result.messageId)
                              setPinnedMessageId(result.messageId)
                            } else {
                              // If we don't have a specific message, try to find the first message in the channel that matches
                              ;(async () => {
                                try {
                                  const chatId = Number(result.channelId)
                                  const existing = messages[chatId]
                                  const msgs =
                                    Array.isArray(existing) && existing.length > 0
                                      ? existing
                                      : (await Storage.getMessages(chatId)) || []

                                  const firstMatch = (msgs || []).find(m =>
                                    m.text &&
                                    m.text
                                      .toLowerCase()
                                      .includes(debouncedSearchQuery.toLowerCase())
                                  )

                                  if (firstMatch) {
                                    setTargetMessageId(firstMatch.id)
                                    setPinnedMessageId(firstMatch.id)
                                  } else {
                                    setPinnedMessageId(null)
                                    setTargetMessageId(null)
                                  }
                                } catch (e) {
                                  console.error("Search navigation failed to load messages", e)
                                  setPinnedMessageId(null)
                                  setTargetMessageId(null)
                                }
                              })()
                            }
                          } else if (result.spaceId) {
                            setActiveSpace(result.spaceId)
                          }
                        }}
                        className="p-3 rounded-2xl bg-white border border-slate-100 shadow-sm hover:shadow-md cursor-pointer transition-all group"
                      >
                        <div className="flex items-center gap-3 mb-1">
                          <span
                            className={`p-1.5 rounded-lg ${
                              result.type === "message"
                                ? "bg-indigo-50 text-indigo-500"
                                : "bg-slate-100 text-slate-500"
                            }`}
                          >
                            {result.type === "space" ? (
                              <Briefcase className="w-3 h-3" />
                            ) : result.type === "channel" ? (
                              <Hash className="w-3 h-3" />
                            ) : (
                              <MessageSquare className="w-3 h-3" />
                            )}
                          </span>
                          <span className="text-xs font-bold text-slate-700">
                            {result.title}
                          </span>
                        </div>
                        <div className="text-xs text-slate-500 truncate pl-9">
                          {renderWithHighlight(
                            result.subtitle,
                            debouncedSearchQuery
                          )}
                        </div>
                      </div>
                    ))
                  )}
                </div>
              ) : (
                <>
                  <button
                    onClick={() => {
                      if (!googleCalendarToken) {
                        setShowCalendarConnectModal(true)
                      } else {
                        setActiveView("calendar")
                        setActiveSpace(null)
                      }
                    }}
                    className={`w-full flex items-center gap-4 p-3 rounded-2xl cursor-pointer transition-all duration-200 mb-6 group ${
                      activeView === "calendar"
                        ? "bg-white shadow-md shadow-indigo-100 border border-indigo-50 text-indigo-600"
                        : "hover:bg-slate-100/80 border border-transparent text-slate-600"
                    }`}
                  >
                    <div
                      className={`p-2.5 rounded-xl transition-colors ${
                        activeView === "calendar"
                          ? "bg-indigo-500 text-white"
                          : "bg-slate-100 text-slate-500 group-hover:bg-white"
                      }`}
                    >
                      <Calendar className="w-5 h-5" />
                    </div>
                    <span className="font-bold text-sm tracking-wide">
                      Calendar
                    </span>
                  </button>

                  <div className="px-2 mb-3 flex items-center justify-between">
                    <span className="text-[10px] font-black uppercase tracking-widest text-slate-400">
                      Your Spaces
                    </span>
                    <span className="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-100 text-slate-500">
                      {spaces.length}
                    </span>
                  </div>

                  {spaces.map(space => (
                    <div key={space.id} className="mb-2">
                      <div
                        className={`flex items-center gap-3 p-3 rounded-2xl cursor-pointer transition-all duration-200 group ${
                          activeView === "channel" && activeSpace === space.id
                            ? "bg-white shadow-md shadow-indigo-100 border border-indigo-50"
                            : "hover:bg-slate-100/80 border border-transparent"
                        }`}
                        onClick={() => {
                          setActiveSpace(space.id)
                          // Don't auto-switch channel unless user has access to current active, handled by effect
                          // Just set view to channel
                          setActiveView("channel")
                        }}
                      >
                        <div
                          className={`p-2.5 rounded-xl transition-colors ${
                            activeSpace === space.id
                              ? "bg-indigo-100 text-indigo-600"
                              : "bg-slate-100 text-slate-500 group-hover:bg-white"
                          }`}
                        >
                          {space.icon}
                        </div>
                        <span
                          className={`font-semibold text-sm truncate flex-1 ${
                            activeSpace === space.id
                              ? "text-slate-900"
                              : "text-slate-600"
                          }`}
                        >
                          {space.name}
                        </span>

                        {/* Space Actions */}
                        <div className="flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                          {space.ownerId === currentUser?.id && (
                            <>
                              <button
                                onClick={e => {
                                  e.stopPropagation()
                                  setShowRenameModal({
                                    type: "space",
                                    id: space.id,
                                    currentName: space.name
                                  })
                                }}
                                className="p-1 hover:text-indigo-600 text-slate-400"
                              >
                                <Edit2 className="w-3 h-3" />
                              </button>
                              <button
                                onClick={e => {
                                  e.stopPropagation()
                                  setShowDeleteConfirm({
                                    type: "space",
                                    id: space.id
                                  })
                                }}
                                className="p-1 hover:text-red-500 text-slate-400"
                              >
                                <Trash2 className="w-3 h-3" />
                              </button>
                            </>
                          )}
                          <button
                            onClick={e => {
                              e.stopPropagation()
                              toggleSpaceExpansion(space.id)
                            }}
                            className="p-1 rounded-lg hover:bg-slate-200"
                          >
                            {space.expanded ? (
                              <ChevronDown className="w-4 h-4 text-slate-500" />
                            ) : (
                              <ChevronRight className="w-4 h-4 text-slate-500" />
                            )}
                          </button>
                        </div>
                      </div>

                      {space.expanded && (
                        <div className="ml-6 pl-4 border-l-2 mt-2 space-y-1 border-slate-100">
                          {(space.channels || []).filter(channel => {
                            const chMembers = channel?.members || []
                            if (chMembers && chMembers.length > 0) {
                              return (
                                currentUser &&
                                (chMembers.includes(currentUser.id) || space.ownerId === currentUser.id)
                              )
                            }
                            const spaceMembers = space?.members || []
                            return (
                              currentUser &&
                              (space.ownerId === currentUser.id || spaceMembers.includes(currentUser.id))
                            )
                          }).map(channel => (
                            <div
                              key={channel.id}
                              className="relative group/channel"
                            >
                              <button
                                onClick={() =>
                                  handleChannelNavigation(space.id, channel.id)
                                }
                                className={`flex items-center gap-3 w-full px-3 py-2 rounded-xl text-[13px] font-medium transition-all ${
                                  activeView === "channel" &&
                                  activeChannel === channel.id
                                    ? "bg-indigo-50 text-indigo-600"
                                    : "text-slate-500 hover:text-slate-800 hover:bg-slate-50"
                                }`}
                              >
                                <Hash
                                  className={`w-4 h-4 ${
                                    activeChannel === channel.id
                                      ? "text-indigo-400"
                                      : "text-slate-300"
                                  }`}
                                />
                                <span className="truncate flex-1 text-left">
                                  {channel.name}
                                </span>

                                {/* Unread Indicator */}
                                {unreadChannels.includes(channel.id) &&
                                  activeChannel !== channel.id && (
                                    <div className="w-2 h-2 rounded-full bg-blue-500 mr-2"></div>
                                  )}

                                {/* Real-time member count */}
                                <span className="text-[10px] bg-slate-200 px-1.5 py-0.5 rounded-full text-slate-500 group-hover/channel:hidden">
                                  {channel.members.length}
                                </span>

                                {space.ownerId === currentUser?.id && (
                                  <div className="hidden group-hover/channel:flex items-center gap-1">
                                    <span
                                      className="p-1 hover:text-indigo-600 text-slate-400"
                                      onClick={e => {
                                        e.stopPropagation()
                                        setShowRenameModal({
                                          type: "channel",
                                          id: channel.id,
                                          currentName: channel.name
                                        })
                                      }}
                                    >
                                      <Edit2 className="w-3 h-3" />
                                    </span>
                                    <span
                                      className="p-1 hover:text-red-600 text-slate-400"
                                      onClick={e => {
                                        e.stopPropagation()
                                        setShowDeleteConfirm({
                                          type: "channel",
                                          id: channel.id
                                        })
                                      }}
                                    >
                                      <Trash2 className="w-3 h-3" />
                                    </span>
                                  </div>
                                )}
                              </button>
                            </div>
                          ))}
                          {space.ownerId === currentUser?.id && (
                            <button
                              onClick={() => {
                                setActiveSpace(space.id)
                                setShowChannelModal(true)
                              }}
                              className="flex items-center gap-3 w-full px-3 py-2 rounded-xl text-[13px] transition-all group mt-1 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50"
                            >
                              <Plus className="w-4 h-4" />
                              <span>Add channel</span>
                            </button>
                          )}
                        </div>
                      )}
                    </div>
                  ))}
                </>
              )}
            </div>
          ) : (
            <div className="flex flex-col items-center gap-4 mt-2 animate-fade-in">
              <button
                onClick={() => {
                  if (!googleCalendarToken) {
                    setShowCalendarConnectModal(true)
                  } else {
                    setActiveView("calendar")
                    setActiveSpace(null)
                  }
                }}
                className={`p-3 rounded-2xl transition-all duration-300 ${
                  activeView === "calendar"
                    ? "bg-indigo-600 text-white shadow-lg shadow-indigo-500/30"
                    : "bg-slate-100 text-slate-500 hover:bg-white hover:shadow-md"
                }`}
                title="Calendar"
              >
                <Calendar className="w-5 h-5" />
              </button>
              <div className="w-8 h-px my-2 bg-slate-200"></div>
              {spaces.map(s => (
                <button
                  key={s.id}
                  className={`w-12 h-12 flex items-center justify-center rounded-2xl transition-all duration-300 font-bold text-lg ${
                    activeSpace === s.id
                      ? "bg-indigo-600 text-white shadow-lg shadow-indigo-500/30"
                      : "bg-slate-100 text-slate-600 hover:bg-white hover:shadow-md"
                  }`}
                  title={s.name}
                  onClick={() => {
                    setActiveSpace(s.id)
                    setActiveView("channel")
                    const accChannel = s.channels.find(
                      c =>
                        c.members.includes(currentUser?.id || 0) ||
                        s.ownerId === currentUser?.id
                    )
                    if (accChannel) setActiveChannel(accChannel.id)
                  }}
                >
                  {s.name.charAt(0).toUpperCase()}
                </button>
              ))}
              <button
                onClick={() => setShowCreateSpaceModal(true)}
                className="p-3 rounded-2xl border-2 border-dashed transition-all border-slate-200 text-slate-400 hover:border-indigo-400 hover:text-indigo-500"
              >
                <Plus className="w-5 h-5" />
              </button>
            </div>
          )}
        </div>
      </div>

      {/* ... (Main Content, Headers, etc.) ... */}

      {/* Main Content Area */}
      <div className="flex-1 flex flex-col min-w-0 relative z-0">
        {/* VIEW: VIDEO MEETING / CALENDAR (No changes needed) ... */}
        {activeView === "meeting" ? (
          <div className="flex-1 flex flex-col relative bg-slate-900">
            {/* ... (Meeting UI) ... */}
            <div className="absolute top-0 left-0 right-0 p-6 flex justify-between items-center z-10 bg-gradient-to-b from-black/80 to-transparent">
              <div className="text-white">
                <h2 className="font-bold text-xl tracking-tight">
                  {activeMeetingTitle}
                </h2>
                <span className="text-xs font-bold text-red-400 bg-red-500/10 px-3 py-1 rounded-full border border-red-500/20 flex items-center gap-2 w-fit mt-2">
                  <span className="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>{" "}
                  LIVE
                </span>
              </div>
            </div>

            <div className="flex-1 flex items-center justify-center p-6 relative">
              <div className="relative w-full h-full max-w-6xl rounded-[2rem] overflow-hidden shadow-2xl border border-white/10 bg-black">
                <video
                  ref={videoRef}
                  autoPlay
                  muted
                  playsInline
                  className="w-full h-full object-cover"
                  style={{ transform: "scaleX(-1)" }}
                />
                <div className="absolute bottom-8 right-8 w-64 h-40 bg-slate-800/90 backdrop-blur-xl rounded-2xl shadow-xl border border-white/10 overflow-hidden">
                  <div className="w-full h-full flex flex-col items-center justify-center text-slate-400">
                    <UserIcon className="w-10 h-10 mb-2 opacity-50" />
                    <span className="text-xs font-medium uppercase tracking-wider">
                      Waiting for user...
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <div className="h-28 flex items-center justify-center gap-6 pb-6">
              <div className="bg-black/60 backdrop-blur-xl border border-white/10 rounded-full p-2 flex gap-4 shadow-2xl">
                <button
                  onClick={toggleMic}
                  className={`p-4 rounded-full ${
                    isMicOn
                      ? "bg-white/10 text-white hover:bg-white/20"
                      : "bg-red-500 text-white hover:bg-red-600"
                  } transition-all`}
                >
                  {isMicOn ? (
                    <Mic className="w-6 h-6" />
                  ) : (
                    <MicOff className="w-6 h-6" />
                  )}
                </button>
                <button
                  onClick={toggleVideo}
                  className={`p-4 rounded-full ${
                    isVideoOn
                      ? "bg-white/10 text-white hover:bg-white/20"
                      : "bg-red-500 text-white hover:bg-red-600"
                  } transition-all`}
                >
                  {isVideoOn ? (
                    <Video className="w-6 h-6" />
                  ) : (
                    <VideoOff className="w-6 h-6" />
                  )}
                </button>
                <button
                  onClick={endCall}
                  className="px-8 rounded-full bg-gradient-to-r from-red-600 to-rose-600 hover:from-red-500 hover:to-rose-500 text-white font-bold flex items-center gap-2 shadow-lg shadow-red-900/50 transition-all transform hover:scale-105"
                >
                  <PhoneOff className="w-6 h-6" />{" "}
                  <span className="hidden sm:inline">End Call</span>
                </button>
              </div>
            </div>
          </div>
        ) : activeView === "calendar" ? (
          /* VIEW: CALENDAR */
          <div className="flex-1 flex flex-col overflow-hidden bg-white">
            {/* ... (Calendar UI) ... */}
            <div className="h-[80px] flex items-center justify-between px-8 border-b border-slate-200">
              <h2 className="text-3xl font-bold flex items-center gap-3 text-slate-800">
                <Calendar className="w-8 h-8 text-indigo-600" /> Calendar
              </h2>
              <div className="flex items-center gap-4">
                <div className="flex rounded-2xl p-1 border bg-slate-100 border-transparent">
                  <button
                    onClick={() => changeMonth(-1)}
                    className="p-2 rounded-xl transition-all hover:bg-white shadow-sm"
                  >
                    <ChevronDown className="w-5 h-5 rotate-90 text-slate-600" />
                  </button>
                  <span className="px-6 font-bold flex items-center text-slate-700">
                    {currentDate.toLocaleString("default", {
                      month: "long",
                      year: "numeric"
                    })}
                  </span>
                  <button
                    onClick={() => changeMonth(1)}
                    className="p-2 rounded-xl transition-all hover:bg-white shadow-sm"
                  >
                    <ChevronRight className="w-5 h-5 text-slate-600" />
                  </button>
                </div>
                <button
                  onClick={() => {
                    setSelectedDate(new Date())
                    setShowEventModal(true)
                  }}
                  className="px-6 py-3 rounded-2xl font-bold text-sm shadow-lg hover:scale-105 transition-all flex items-center gap-2 bg-indigo-600 text-white shadow-indigo-200 hover:bg-indigo-700"
                >
                  <Plus className="w-5 h-5" /> New Event
                </button>
                <button
                  onClick={() => handleConnectGoogleCalendar()}
                  className="px-4 py-2 rounded-2xl font-bold text-sm border bg-white hover:bg-slate-50 transition-all flex items-center gap-2 text-slate-700"
                >
                  Connect Google Calendar
                </button>
              </div>
            </div>
            <div className="flex-1 overflow-y-auto p-8">
              {/* ... (Calendar Grid) ... */}
              <div className="grid grid-cols-7 gap-4 mb-4">
                {["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].map(d => (
                  <div
                    key={d}
                    className="text-center text-xs font-bold uppercase tracking-widest text-slate-400"
                  >
                    {d}
                  </div>
                ))}
              </div>
              <div className="grid grid-cols-7 gap-4 auto-rows-[140px]">
                {Array.from({
                  length: getDaysInMonth(currentDate).firstDay
                }).map((_, i) => (
                  <div
                    key={`empty-${i}`}
                    className="rounded-3xl bg-slate-50/50"
                  ></div>
                ))}
                {Array.from({
                  length: getDaysInMonth(currentDate).daysInMonth
                }).map((_, i) => {
                  const day = i + 1
                  const dateStr = new Date(
                    currentDate.getFullYear(),
                    currentDate.getMonth(),
                    day
                  )
                    .toISOString()
                    .split("T")[0]
                  const dayEvents = events.filter(e => e.startDate === dateStr)
                  const isToday =
                    new Date().toISOString().split("T")[0] === dateStr

                  return (
                    <div
                      key={day}
                      onClick={() => {
                        const d = new Date(
                          currentDate.getFullYear(),
                          currentDate.getMonth(),
                          day
                        )
                        setSelectedDate(d)
                        setShowEventModal(true)
                      }}
                      className={`p-4 rounded-3xl border transition-all cursor-pointer flex flex-col gap-2 group ${
                        isToday
                          ? "bg-indigo-50 border-indigo-200"
                          : "bg-white border-slate-100 hover:shadow-md hover:border-indigo-300"
                      }`}
                    >
                      <span
                        className={`text-sm font-bold w-8 h-8 flex items-center justify-center rounded-full ${
                          isToday
                            ? "bg-indigo-600 text-white"
                            : "text-slate-700"
                        }`}
                      >
                        {day}
                      </span>
                      <div className="flex-1 overflow-y-auto scrollbar-thin space-y-1.5 mt-1">
                        {dayEvents.map(ev => (
                          <div
                            key={ev.id}
                            onClick={e => {
                              e.stopPropagation()
                              if (ev.type === "meeting") startMeeting(ev.title)
                            }}
                            className={`text-[10px] px-2.5 py-1.5 rounded-lg font-bold truncate flex items-center gap-1.5 ${
                              ev.type === "meeting"
                                ? "bg-indigo-100 text-indigo-700 hover:bg-indigo-200"
                                : "bg-yellow-100 text-yellow-700"
                            }`}
                          >
                            {ev.type === "meeting" && (
                              <Video className="w-3 h-3" />
                            )}
                            {ev.title}
                          </div>
                        ))}
                      </div>
                    </div>
                  )
                })}
              </div>
            </div>
          </div>
        ) : (
          /* VIEW: CHANNEL / DM */
          <>
            {/* Header */}
            <div className="h-[90px] sticky top-0 z-30 flex items-center justify-between px-10 border-b bg-white backdrop-blur-xl border-slate-200 shadow-sm">
              {/* ... (Header Content) ... */}
              <div
                onClick={() => setShowMemberDetails(prev => !prev)}
                className="flex items-center gap-5 cursor-pointer group py-2.5 px-4 -ml-4 rounded-2xl transition-all hover:bg-gradient-to-r hover:from-slate-50 hover:to-white hover:shadow-md"
              >
                {activeView === "dm" ? (
                  <div className="flex items-center gap-5">
                    <div className="relative">
                      <div className="w-12 h-12 rounded-2xl flex items-center justify-center text-xl shadow-lg border-2 bg-gradient-to-br from-indigo-100 to-purple-100 border-white text-slate-700">
                        {getUser(activeDMUser)?.avatar}
                      </div>
                      <span
                        className={`absolute -bottom-0.5 -right-0.5 w-4 h-4 rounded-full border-[3px] border-white shadow-md ${
                          getUser(activeDMUser)?.status === "online"
                            ? "bg-emerald-500"
                            : "bg-slate-400"
                        }`}
                      ></span>
                    </div>
                    <div>
                      <h2 className="font-bold text-2xl leading-tight tracking-tight text-slate-800">
                        {getActiveViewName()}
                      </h2>
                      <p className="text-xs font-bold uppercase tracking-wider flex items-center gap-2 text-emerald-600 mt-0.5">
                        <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse shadow-sm shadow-emerald-300"></span>{" "}
                        Online
                      </p>
                    </div>
                  </div>
                ) : (
                  <div className="flex items-center gap-5">
                    <div className="w-12 h-12 rounded-2xl flex items-center justify-center transition-all bg-gradient-to-br from-slate-100 to-slate-50 text-slate-600 border-2 border-slate-200/50 shadow-sm group-hover:shadow-md group-hover:from-indigo-50 group-hover:to-purple-50 group-hover:border-indigo-200 group-hover:text-indigo-600">
                      <Hash className="w-6 h-6" />
                    </div>
                    <div>
                      <h2 className="font-bold text-2xl leading-tight tracking-tight text-slate-800 flex items-center gap-2.5">
                        {/* Header Breadcrumb Context */}
                        <span className="text-slate-400 font-semibold">
                          {getCurrentSpace()?.name}
                        </span>
                        <ChevronRight className="w-4 h-4 text-slate-300" />
                        <span>{getActiveViewName().replace("#", "")}</span>
                      </h2>
                      <div className="flex items-center gap-3 text-xs font-medium text-slate-400 mt-0.5">
                        <span className="flex items-center gap-1.5 text-slate-500">
                          <Users className="w-3.5 h-3.5" /> {activeMembers.length}{" "}
                          members
                        </span>
                        <span className="opacity-0 group-hover:opacity-100 transition-opacity text-indigo-500">
                          â€¢ View details
                        </span>
                      </div>
                    </div>
                  </div>
                )}
              </div>

              <div className="flex items-center gap-4">
                {/* Docs Icon */}
                <div className="relative">
                  <button
                    onClick={handleDocsClick}
                    className="p-3.5 rounded-2xl transition-all bg-slate-50 hover:bg-gradient-to-br hover:from-indigo-50 hover:to-purple-50 text-slate-600 hover:text-indigo-600 hover:shadow-lg border border-transparent hover:border-indigo-200 relative group"
                    title="Documents"
                  >
                    <FileText className="w-5 h-5 group-hover:scale-110 transition-transform" />
                    {googleAccessToken && (
                      <span className="absolute top-2 right-2 w-2.5 h-2.5 bg-green-500 rounded-full border-2 border-white shadow-md animate-pulse"></span>
                    )}
                  </button>
                </div>

                {/* Google Apps Grid Icon */}
                <div className="relative">
                  <button
                    onClick={() => setShowGoogleAppsMenu(!showGoogleAppsMenu)}
                    className="p-3.5 rounded-2xl transition-all bg-slate-50 hover:bg-gradient-to-br hover:from-indigo-50 hover:to-purple-50 text-slate-600 hover:text-indigo-600 hover:shadow-lg border border-transparent hover:border-indigo-200 group"
                    title="Google Apps"
                  >
                    <Grid3x3 className="w-5 h-5 group-hover:scale-110 transition-transform" />
                  </button>

                  {showGoogleAppsMenu && (
                    <>
                      <div
                        className="fixed inset-0 z-40"
                        onClick={() => setShowGoogleAppsMenu(false)}
                      ></div>
                      <div className="absolute right-0 top-full mt-3 w-96 rounded-3xl shadow-2xl p-8 animate-fade-in origin-top-right ring-1 ring-slate-200 bg-white backdrop-blur-xl border border-slate-100 z-50">
                        <h3 className="text-xl font-bold mb-6 text-slate-800 flex items-center gap-3">
                          <div className="w-10 h-10 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                            <Grid3x3 className="w-5 h-5 text-white" />
                          </div>
                          Google Apps
                        </h3>
                        <div className="grid grid-cols-4 gap-3">
                          {GoogleService.GOOGLE_APPS.map((app) => (
                            <a
                              key={app.name}
                              href={app.url}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="flex flex-col items-center gap-2.5 p-4 rounded-2xl hover:bg-slate-50 transition-all group hover:shadow-md border border-transparent hover:border-slate-200"
                              onClick={() => setShowGoogleAppsMenu(false)}
                            >
                              <div className={`w-14 h-14 rounded-2xl flex items-center justify-center ${app.color} group-hover:scale-110 transition-all duration-300 shadow-sm group-hover:shadow-md`}>
                                <img 
                                  src={app.icon} 
                                  alt={app.name} 
                                  className="w-8 h-8 object-contain"
                                  onError={(e) => {
                                    e.target.style.display = 'none'
                                    e.target.parentElement.innerHTML = '<span class="text-2xl">' + (app.name.charAt(0)) + '</span>'
                                  }}
                                />
                              </div>
                              <span className="text-xs font-semibold text-slate-700 text-center group-hover:text-slate-900">{app.name}</span>
                            </a>
                          ))}
                        </div>
                      </div>
                    </>
                  )}
                </div>

                {/* Video Call Icon */}
                {VIDEO_ENABLED && (
                  <div className="relative">
                    <button
                      onClick={() => {
                        setSelectedCallMembers([])
                        setShowVideoModal(true)
                      }}
                      className="p-3.5 rounded-2xl transition-all bg-slate-50 hover:bg-gradient-to-br hover:from-indigo-50 hover:to-purple-50 text-slate-600 hover:text-indigo-600 hover:shadow-lg border border-transparent hover:border-indigo-200"
                      title="Start video call"
                    >
                      <Video className="w-5 h-5" />
                    </button>
                  </div>
                )}

                {activeView === "channel" && (
                  <button
                    onClick={() => {
                      setInviteSearchQuery("")
                      setSelectedInviteUsers([])
                      setShowAddToSpaceModal(true)
                    }}
                    className="hidden md:flex items-center gap-2.5 px-6 py-3.5 text-xs font-extrabold uppercase tracking-wide rounded-2xl transition-all shadow-lg hover:shadow-xl active:scale-95 bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 text-white hover:from-slate-800 hover:via-slate-700 hover:to-slate-800"
                  >
                    <UserPlus className="w-4 h-4" />
                    <span>Invite Members</span>
                  </button>
                )}

                <div className="h-10 w-px mx-2 bg-gradient-to-b from-transparent via-slate-200 to-transparent"></div>

                {/* User Menu */}
                {/* ... (User Menu) ... */}
                <div className="relative z-50">
                  <button
                    onClick={() => setShowUserMenu(!showUserMenu)}
                    className={`flex items-center gap-4 pl-4 pr-3 py-2.5 rounded-2xl transition-all border-2 ${
                      showUserMenu
                        ? "bg-white border-indigo-200 shadow-xl"
                        : "border-transparent bg-slate-50 hover:bg-white hover:border-slate-200 hover:shadow-lg"
                    }`}
                  >
                    <div className="text-right hidden sm:block">
                      <div className="text-sm font-bold text-slate-800">
                        {currentUser?.name}
                      </div>
                      <div className="text-[10px] font-bold uppercase tracking-wider text-slate-400">
                        Available
                      </div>
                    </div>
                    <div className="relative">
                      <div className="w-11 h-11 rounded-2xl flex items-center justify-center text-lg shadow-md bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 border-2 border-white ring-2 ring-slate-100">
                        {currentUser?.avatar}
                      </div>
                      {currentUser?.notifications.length ? (
                        <span className="absolute -top-1 -right-1 flex h-4 w-4">
                          <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                          <span className="relative inline-flex rounded-full h-4 w-4 bg-gradient-to-br from-red-500 to-rose-600 border-[3px] border-white shadow-lg"></span>
                        </span>
                      ) : null}
                    </div>
                    <ChevronDown
                      className={`w-4 h-4 text-slate-400 transition-transform duration-300 ${
                        showUserMenu ? "rotate-180" : ""
                      }`}
                    />
                  </button>

                  {showUserMenu && (
                    <>
                      <div
                        className="fixed inset-0 z-40"
                        onClick={() => setShowUserMenu(false)}
                      ></div>
                      <div className="absolute right-0 top-full mt-3 w-72 rounded-3xl shadow-2xl py-2 animate-fade-in origin-top-right ring-1 ring-black/5 bg-white/95 backdrop-blur-xl border border-slate-100 z-50">
                        <div className="px-5 py-4 border-b border-slate-100 bg-slate-50/50">
                          <div className="flex items-center gap-3">
                            <span className="text-3xl p-2 rounded-full bg-white shadow-sm border border-slate-100">
                              {renderAvatar(currentUser, 36)}
                            </span>
                            <div className="overflow-hidden">
                              <div className="font-bold truncate text-slate-800">
                                {currentUser?.name}
                              </div>
                              <div className="text-xs truncate text-slate-500">
                                {currentUser?.email}
                              </div>
                            </div>
                          </div>
                        </div>
                        <div className="p-2 space-y-1">
                          {/* Profile Modal */}
                          {showProfileModal && (
                            <div className="fixed inset-0 z-60 flex items-center justify-center">
                              <div className="absolute inset-0 bg-black/30" onClick={() => setShowProfileModal(false)}></div>
                              <div className="relative bg-white rounded-2xl shadow-2xl w-[720px] max-w-full p-6 z-70">
                                <h3 className="text-lg font-bold mb-4">Edit Profile</h3>
                                <div className="grid grid-cols-2 gap-6">
                                  <div>
                                    <div className="mb-3">Choose an avatar</div>
                                    <div className="grid grid-cols-4 gap-3">
                                      {[
                                        ['#ff9a9e','#fecfef'],
                                        ['#a1c4fd','#c2e9fb'],
                                        ['#f6d365','#fda085'],
                                        ['#f093fb','#f5576c'],
                                        ['#96fbc4','#f9f586'],
                                        ['#c2e9fb','#a1c4fd'],
                                        ['#fddb92','#d1fdff'],
                                        ['#fbc2eb','#a6c1ee']
                                      ].map((p, i) => (
                                        <button key={i} onClick={() => { setSelectedPreset(p); setAvatarPreview(null) }} className={`w-16 h-16 rounded-full shadow-md flex items-center justify-center ${selectedPreset === p ? 'ring-4 ring-indigo-200' : ''}`} style={{ background: `linear-gradient(135deg, ${p[0]} 0%, ${p[1]} 100%)` }}>
                                          <span className="text-white font-bold">{(currentUser?.name||'')[0]||'?'}</span>
                                        </button>
                                      ))}
                                    </div>

                                    <div className="mt-4">
                                      <div className="mb-2">Or upload your own</div>
                                      <input type="file" accept="image/*" onChange={e => {
                                        const f = e.target.files && e.target.files[0]
                                        if (!f) return
                                        const reader = new FileReader()
                                        reader.onload = () => {
                                          setAvatarPreview(reader.result)
                                          setSelectedPreset(null)
                                        }
                                        reader.readAsDataURL(f)
                                      }} />
                                      {avatarPreview && (
                                        <div className="mt-3">
                                          <img src={avatarPreview} alt="preview" className="w-32 h-32 rounded-full object-cover" />
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                  <div>
                                    <div className="mb-3">Preview</div>
                                    <div className="p-4 bg-slate-50 rounded-xl flex items-center gap-4">
                                      <div>{renderAvatar({ id: currentUser?.id, name: currentUser?.name, avatar_url: avatarPreview, avatar_preset: selectedPreset }, 64)}</div>
                                      <div>
                                        <div className="font-bold">{currentUser?.name}</div>
                                        <div className="text-xs text-slate-500">{currentUser?.email}</div>
                                      </div>
                                    </div>

                                    <div className="mt-6 flex gap-3">
                                      <button onClick={async () => {
                                        setIsSavingProfile(true)
                                        try {
                                          const stored = getStoredUser()
                                          const uid = stored && (stored.id || stored._id || (stored._id && stored._id.$oid) || stored.userId)
                                          if (!uid) throw new Error('No user id')
                                          const updates = {}
                                          if (avatarPreview) updates.avatar_url = avatarPreview
                                          else updates.avatar_url = null
                                          if (selectedPreset) updates.avatar_preset = selectedPreset
                                          else updates.avatar_preset = null

                                          const res = await Storage.updateUser(uid, { ...stored, ...updates })
                                          if (res && res.user) {
                                            saveAuth(res.user, getToken())
                                            setCurrentUser(res.user)
                                          } else if (res && res.id) {
                                            // some backends return the user object directly
                                            const newUser = res
                                            saveAuth(newUser, getToken())
                                            setCurrentUser(newUser)
                                          }
                                          setShowProfileModal(false)
                                        } catch (e) {
                                          console.error('save profile failed', e)
                                        }
                                        setIsSavingProfile(false)
                                      }} className="px-4 py-2 rounded-xl bg-indigo-600 text-white font-bold shadow">Save</button>
                                      <button onClick={() => { setAvatarPreview(null); setSelectedPreset(null); setShowProfileModal(false) }} className="px-4 py-2 rounded-xl border">Cancel</button>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          )}
                          <button
                            onClick={() => {
                              // prepare modal
                              setSelectedPreset(currentUser?.avatar_preset || null)
                              setAvatarPreview(currentUser?.avatar_url || null)
                              setShowProfileModal(true)
                              setShowUserMenu(false)
                            }}
                            className="w-full text-left px-4 py-3 text-sm rounded-2xl flex items-center justify-between transition-colors font-medium text-slate-700 hover:bg-indigo-50 hover:text-indigo-700"
                          >
                            <div className="flex items-center gap-3">
                              <UserPlus className="w-4 h-4" /> Edit Profile
                            </div>
                          </button>
                          <button
                            onClick={() => {
                              setShowNotificationsModal(true)
                              setShowUserMenu(false)
                            }}
                            className="w-full text-left px-4 py-3 text-sm rounded-2xl flex items-center justify-between transition-colors font-medium text-slate-700 hover:bg-indigo-50 hover:text-indigo-700"
                          >
                            <div className="flex items-center gap-3">
                              <Bell className="w-4 h-4" /> Notifications
                            </div>
                            {currentUser?.notifications.length ? (
                              <span className="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-lg shadow-red-500/30">
                                {currentUser.notifications.length}
                              </span>
                            ) : null}
                          </button>
                          <div className="h-px my-1 mx-2 bg-slate-100"></div>
                          <button
                            onClick={() => {
                              handleLogout()
                              setShowUserMenu(false)
                            }}
                            className="w-full text-left px-4 py-3 text-sm rounded-2xl flex items-center gap-3 transition-colors font-medium text-red-600 hover:bg-red-50"
                          >
                            <LogIn className="w-4 h-4" /> Sign Out
                          </button>
                        </div>
                      </div>
                    </>
                  )}
                </div>
              </div>
            </div>

            {/* Messages / Chat Area */}
            {/* ... (Chat Area Code) ... */}
            <div className="flex-1 flex overflow-hidden bg-slate-50/50">
              <div className="flex-1 flex flex-col min-w-0">
                {/* Updated Container with Custom Pattern Background */}
                {/* day label computed above via `messageDateLabel` */}

                <div
                  ref={messagesContainerRef}
                  onScroll={() => {
                    const el = messagesContainerRef.current
                    if (!el) return
                    const threshold = (messageInputRef.current?.offsetHeight || 64) + 16
                    const atBottom = el.scrollHeight - el.scrollTop - el.clientHeight < threshold
                    setIsAtBottom(atBottom)
                    // keep track of latest scrollHeight for preserving position when new messages arrive
                    prevScrollHeightRef.current = el.scrollHeight
                    // Update the visible date label based on the message near the vertical center
                    try {
                      const mid = el.scrollTop + el.clientHeight / 2
                      const nodes = el.querySelectorAll('[id^="msg-"]')
                      let foundTs = null
                      for (let i = 0; i < nodes.length; i++) {
                        const n = nodes[i]
                        if (n.offsetTop <= mid) {
                          foundTs = n.dataset.timestamp || null
                        } else break
                      }
                      if (foundTs) {
                        const label = formatDateLabel(foundTs, timeTicker)
                        setVisibleDateLabel(label)
                      }
                    } catch (e) {}
                  }}
                  className="flex-1 overflow-y-auto p-4 sm:p-8 space-y-8 scrollbar-thin chat-background relative"
                >
                  {/* ... (Existing Message Rendering) ... */}
                      {getCurrentMessages().length === 0 ? (
                    <div className="h-full flex flex-col items-center justify-center">
                      <div className="p-10 rounded-[2.5rem] text-center max-w-sm bg-white/80 backdrop-blur-sm shadow-sm border border-white/50">
                        <div className="inline-flex items-center justify-center w-24 h-24 rounded-[2rem] mb-6 relative shadow-lg transform rotate-3 hover:rotate-6 transition-transform bg-indigo-100 text-indigo-600">
                          <MessageCircle className="w-12 h-12" />
                          <div className="absolute -top-2 -right-2 w-6 h-6 rounded-full border-4 animate-bounce bg-yellow-400 border-white"></div>
                        </div>
                        <h3 className="text-2xl font-extrabold mb-3 text-slate-800">
                          Say Hello!
                        </h3>
                        <p className="text-sm leading-relaxed mb-6 text-slate-500">
                          This is the start of something epic in{" "}
                          <span className="font-bold text-indigo-600">
                            {getActiveViewName()}
                          </span>
                          . Send a message to break the ice.
                        </p>
                        <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full border text-[10px] font-bold uppercase tracking-widest bg-yellow-50/80 border-yellow-100 text-yellow-800">
                          <Lock className="w-3 h-3" /> End-to-End Encrypted
                        </div>
                      </div>
                    </div>
                  ) : (
                    <>
                      {pinnedMessageId && (
                        <div className="sticky top-0 z-20 mb-4 flex items-center justify-between gap-4 bg-white/90 rounded-xl px-4 py-3 border border-slate-100 shadow-sm">
                          <div className="flex items-center gap-3">
                            <Sparkles className="w-4 h-4 text-indigo-500" />
                            <div className="text-sm font-bold">Pinned Search Result</div>
                            <div className="text-xs text-slate-500">Reviewing highlighted message</div>
                          </div>
                          <div className="flex items-center gap-2">
                            <button
                              onClick={() => {
                                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
                                setPinnedMessageId(null)
                                setHighlightTerm("")
                              }}
                              className="px-3 py-1 rounded-full text-sm bg-indigo-50 text-indigo-600 font-semibold"
                            >
                              Back to Latest
                            </button>
                            <button
                              onClick={() => {
                                setPinnedMessageId(null)
                                setHighlightTerm("")
                              }}
                              className="px-3 py-1 rounded-full text-sm bg-white border border-slate-100"
                            >
                              Clear
                            </button>
                          </div>
                        </div>
                      )}

                      <div className="sticky top-0 z-10 flex justify-center mb-6 pointer-events-none">
                        <span className="text-[10px] font-black px-4 py-1.5 rounded-full uppercase tracking-widest shadow-lg backdrop-blur-xl bg-white/90 text-slate-500 border border-slate-100">
                          {visibleDateLabel || messageDateLabel || 'Today'}
                        </span>
                      </div>

                      {getCurrentMessages().map((msg, idx) => {
                        const user = getUser(msg.userId)
                        const isMe = user?.id === currentUser?.id
                        const prevMsg =
                          idx > 0 ? getCurrentMessages()[idx - 1] : null
                        // Date separator logic
                        const msgDayLabel = formatDateLabel(msg.timestamp, timeTicker)
                        const prevDayLabel = prevMsg ? formatDateLabel(prevMsg.timestamp, timeTicker) : null
                        const showDateSeparator = idx === 0 || msgDayLabel !== prevDayLabel
                        const isSequence =
                          prevMsg && prevMsg.userId === msg.userId
                        const messageStatus = msg.status || "sent"
                        const statusLabel = (() => {
                          if (!isMe) return null
                          if (messageStatus === "failed") {
                            return (
                              <button
                                onClick={() => retryFailedMessage(getActiveChatId(), msg)}
                                className="flex items-center gap-1 text-[9px] text-rose-200 underline underline-offset-2"
                              >
                                <XCircle className="w-3 h-3" />
                                Retry send
                              </button>
                            )
                          }
                          if (messageStatus === "sending" || messageStatus === "retrying") {
                            return (
                              <span className="flex items-center gap-1 text-[9px] text-indigo-100">
                                <span className="w-3 h-3 rounded-full border border-white/40 border-t-transparent animate-spin"></span>
                                {messageStatus === "retrying" ? "Retrying" : "Sending"}
                              </span>
                            )
                          }
                          return (
                            <span className="flex items-center gap-1 text-[9px] text-indigo-100">
                              Sent
                              <Check className="w-3 h-3" />
                            </span>
                          )
                        })()

                        return (
                          <>
                            {showDateSeparator && (
                              <div className="w-full flex justify-center mb-4">
                                <span className="text-[11px] font-bold px-3 py-1 rounded-full bg-white/90 border border-slate-100 text-slate-500">
                                  {msgDayLabel}
                                </span>
                              </div>
                            )}
                            <div
                              key={msg.id}
                              id={`msg-${msg.id}`}
                              data-timestamp={msg.timestamp || ''}
                              className={`flex gap-4 ${
                                isMe ? "flex-row-reverse" : ""
                              } ${
                                isSequence ? "mt-1" : "mt-6"
                              } group animate-fade-in`}
                            >
                            {/* Avatar only for first in sequence */}
                            <div className="flex-shrink-0 w-10 flex flex-col items-center">
                              {!isSequence ? (
                                <div
                                  className={`w-10 h-10 rounded-full flex items-center justify-center text-lg shadow-lg border-2 ${
                                    isMe
                                      ? "bg-indigo-50 border-white"
                                      : "bg-white border-white text-sm"
                                  } ${isMe ? "text-indigo-600" : ""}`}
                                >
                                  {renderAvatar(user, 36)}
                                </div>
                              ) : (
                                <div className="w-10" />
                              )}
                            </div>

                            <div
                              className={`flex flex-col max-w-[70%] ${
                                isMe ? "items-end" : "items-start"
                              }`}
                            >
                              {/* Name only for first in sequence */}
                              {!isSequence && !isMe && (
                                <div className="ml-1 mb-1.5 flex items-baseline gap-2">
                                  <span className="text-xs font-bold text-slate-500">
                                    {user?.name}
                                  </span>
                                  <span className="text-[10px] font-medium text-slate-400">
                                    {msg.timestamp
                                      ? formatTime(msg.timestamp)
                                      : "now"}
                                  </span>
                                </div>
                              )}

                              <div
                              onMouseEnter={() => setHoveredMessageId(msg.id)}
                              onMouseLeave={() => setHoveredMessageId(null)}
                              onTouchStart={() => {
                                longPressTimerRef.current = setTimeout(() => setShowEmojiPickerFor(msg.id), 600)
                              }}
                              onTouchEnd={() => {
                                clearTimeout(longPressTimerRef.current)
                              }}
                              className={`relative px-5 py-3 text-[15px] leading-relaxed break-words shadow-lg backdrop-blur-sm ${
                                  isMe
                                    ? "bg-indigo-600 text-white rounded-2xl rounded-tr-sm"
                                    : "bg-white text-slate-800 rounded-2xl rounded-tl-sm"
                                } ${pinnedMessageId === msg.id ? 'ring-2 ring-indigo-400 ring-offset-2' : ''}`}
                              >
                                {msg.text && (
                                  <div>
                                    {renderWithHighlight(
                                      msg.text,
                                      highlightTerm
                                    )}
                                  </div>
                                )}

                                {/* Reactions row */}
                                {msg.reactions && Object.keys(msg.reactions).length > 0 && (
                                  <div className="mt-2 flex items-center gap-2">
                                    {Object.entries(msg.reactions).map(([emoji, uids]) => (
                                      <button
                                        key={emoji}
                                        title={uids.map(id => getUser(id)?.name || '').join(', ')}
                                        onClick={() => toggleReaction(getActiveChatId(), msg.id, emoji)}
                                        className="px-2 py-1 rounded-full text-sm bg-slate-100 flex items-center gap-2"
                                      >
                                        <span className="text-lg">{emoji}</span>
                                        <span className="ml-1 text-xs text-slate-600 font-bold">{uids.length}</span>
                                      </button>
                                    ))}
                                  </div>
                                )}

                                {/* Emoji picker - hover or explicit open */}
                                {(hoveredMessageId === msg.id || showEmojiPickerFor === msg.id) && (
                                  <div
                                    className="absolute flex gap-1 bg-white p-2 rounded-xl shadow-lg z-20 animate-fade-in"
                                    style={{ left: '-72px', top: '50%', transform: 'translateY(-50%)' }}
                                  >
                                    {EMOJIS.map(e => (
                                      <button
                                        key={e}
                                        onClick={() => { toggleReaction(getActiveChatId(), msg.id, e); setShowEmojiPickerFor(null) }}
                                        className="p-1 text-lg"
                                      >
                                        {e}
                                      </button>
                                    ))}
                                  </div>
                                )}

                                {msg.attachments && msg.attachments.length > 0 && (
                                  <div
                                    className={`flex flex-wrap gap-2 ${
                                      msg.text ? "mt-3" : ""
                                    }`}
                                  >
                                    {msg.attachments.map(att => (
                                      <div
                                        key={att.id}
                                        onClick={() => openAttachment(att)}
                                        style={{ cursor: (att.url || att.previewUrl) ? "pointer" : "default" }}
                                        className={`relative rounded-xl overflow-hidden transition-transform hover:scale-[1.02] ${
                                          ((att.url && String(att.url).includes('drive.google.com')) || att.drive_file_id)
                                            ? "bg-blue-50 border border-blue-100"
                                            : "bg-black/5"
                                        }`}
                                      >
                                        {/* Download overlay */}
                                        {(att.url || att.previewUrl) && (
                                          <button
                                            onClick={e => {
                                              e.stopPropagation()
                                              downloadAttachment(att)
                                            }}
                                            className="absolute top-2 right-2 z-10 p-1 rounded-lg bg-white/90 border border-slate-100 hover:bg-white shadow-md text-slate-600"
                                          >
                                            Download
                                          </button>
                                        )}
                                        {(((att.url && String(att.url).includes('drive.google.com')) || att.drive_file_id)) ? (
                                          <div className="p-3 flex items-center gap-3 rounded-xl min-w-[200px]">
                                            <div className="p-2 rounded-lg bg-white shadow-sm text-blue-600">
                                              <img
                                                src="https://upload.wikimedia.org/wikipedia/commons/1/12/Google_Drive_icon_%282020%29.svg"
                                                className="w-6 h-6"
                                                alt="Drive"
                                              />
                                            </div>
                                            <div className="overflow-hidden flex-1">
                                              <span className="text-xs font-bold truncate block text-slate-800">
                                                {att.name}
                                              </span>
                                              <div className="flex items-center gap-2 mt-0.5">
                                                <span className="text-[10px] text-slate-500">
                                                  Google Drive
                                                </span>
                                                <ExternalLink className="w-3 h-3 text-slate-400" />
                                              </div>
                                            </div>
                                          </div>
                                        ) : (() => {
                                          const srcUrl = att.url || att.previewUrl || att.public_url || att.webViewLink
                                          const mime = att.type || att.mimeType || att.mimetype || ''
                                          if (mime && mime.startsWith && mime.startsWith('image/') && srcUrl) {
                                            return (
                                              <img
                                                src={srcUrl}
                                                alt={att.name}
                                                className="max-w-[240px] max-h-[240px] object-cover"
                                              />
                                            )
                                          }
                                          if ((mime === 'application/pdf' || (srcUrl && String(srcUrl).toLowerCase().endsWith('.pdf'))) && srcUrl) {
                                            return (
                                              <div className="max-w-[320px] max-h-[260px] rounded-xl overflow-hidden border bg-white">
                                                <iframe
                                                  src={srcUrl}
                                                  title={att.name}
                                                  className="w-full h-60"
                                                  frameBorder="0"
                                                />
                                              </div>
                                            )
                                          }
                                          if (mime && mime.startsWith && mime.startsWith('video/') && srcUrl) {
                                            return (
                                              <video className="max-w-[320px] max-h-[260px] rounded-xl" controls>
                                                <source src={srcUrl} type={mime} />
                                                Your browser does not support the video tag.
                                              </video>
                                            )
                                          }

                                          return (
                                            <div className="p-3 flex items-center gap-3 rounded-xl min-w-[160px] bg-white/90">
                                              <div className="p-2 rounded-lg text-slate-500">
                                                <FileIcon className="w-5 h-5" />
                                              </div>
                                              <div className="overflow-hidden">
                                                <span className="text-xs font-bold truncate block text-slate-700">
                                                  {att.name}
                                                </span>
                                                <span className="text-[10px] text-slate-400">
                                                  {att.size ? ((att.size / 1024).toFixed(1) + " KB") : ""}
                                                </span>
                                              </div>
                                            </div>
                                          )
                                        })()}
                                      </div>
                                    ))}
                                  </div>
                                )}
                              
                                {/* Timestamp for Me inside bubble, slightly cleaner */}
                                {isMe && (
                                  <div className="text-[9px] text-right mt-1 font-bold flex justify-end items-center gap-2 text-indigo-100 flex-wrap">
                                    <span>
                                      {msg.timestamp
                                        ? formatTime(msg.timestamp)
                                        : "now"}
                                    </span>
                                    {statusLabel}
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                          </>
                        )
                      })}
                    </>
                  )}
                  <div ref={messagesEndRef} />

                  {!isAtBottom && getCurrentMessages().length > 0 && (
                    <button
                      onClick={() => {
                        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
                        setIsAtBottom(true)
                        setPinnedMessageId(null)
                        setHighlightTerm("")
                      }}
                      style={{ bottom: `${(messageInputRef.current?.offsetHeight || 48) + 12}px`, right: '1.5rem' }}
                      className="absolute z-30 p-3 rounded-full bg-white shadow-lg border hover:bg-indigo-50 transition-transform transition-opacity animate-fade-in hover:-translate-y-1"
                      aria-label="Scroll to latest messages"
                    >
                      <ChevronDown className="w-5 h-5 text-indigo-600" />
                    </button>
                  )}
                </div>

                {/* Message Input */}
                <div ref={messageInputRef} className="p-6 pt-2 bg-slate-50/50 backdrop-blur-sm">
                  {/* ... (Input UI) ... */}
                  <div className="rounded-[2rem] p-2 relative transition-all focus-within:ring-2 bg-white shadow-xl shadow-slate-200/50 border border-slate-100 focus-within:ring-indigo-500/20 focus-within:border-indigo-400">
                    {/* Attachments Preview */}
                    {selectedFiles.length > 0 && (
                      <div className="flex gap-3 p-3 mb-2 overflow-x-auto border-b border-slate-100">
                        {selectedFiles.map(file => (
                          <div
                            key={file.id}
                            className="relative group border rounded-2xl p-2 flex items-center gap-3 flex-shrink-0 pr-8 bg-slate-50 border-slate-200"
                          >
                            {file.source === "drive" ? (
                              <img
                                src="https://upload.wikimedia.org/wikipedia/commons/1/12/Google_Drive_icon_%282020%29.svg"
                                className="w-6 h-6"
                                alt="Drive"
                              />
                            ) : file.type.startsWith("image/") && (file.previewUrl || file.url) ? (
                              <img
                                src={file.url || file.previewUrl}
                                className="w-10 h-10 rounded-xl object-cover"
                                alt=""
                              />
                            ) : (
                              <FileIcon className="w-6 h-6 text-indigo-500" />
                            )}
                            <span className="text-xs font-bold max-w-[100px] truncate">
                              {file.name}
                            </span>
                            <button
                              onClick={() => removeAttachment(file.id)}
                              className="absolute -top-2 -right-2 rounded-full p-1 shadow-md hover:scale-110 transition-transform bg-white border border-slate-200 hover:text-red-500"
                            >
                              <X className="w-3 h-3" />
                            </button>
                          </div>
                        ))}
                      </div>
                    )}

                    <div className="flex items-end gap-2 px-2 pb-1 relative">
                      <div className="relative">
                        <button
                          onClick={() => fileInputRef.current?.click()}
                          className="p-3 mb-1 rounded-full transition-colors hover:bg-slate-100 text-slate-400 hover:text-indigo-600"
                        >
                          <Paperclip className="w-5 h-5" />
                        </button>
                        <button
                          onClick={() => setShowEmojiPickerFor('input')}
                          className="p-3 mb-1 ml-1 rounded-full transition-colors hover:bg-slate-100 text-slate-400 hover:text-indigo-600"
                        >
                          <span className="text-lg">ðŸ˜€</span>
                        </button>

                        {showEmojiPickerFor === 'input' && (
                          <div className="absolute left-0 top-12 flex gap-1 bg-white p-2 rounded-xl shadow-lg z-30">
                            {EMOJIS.map(e => (
                              <button
                                key={e}
                                className="p-1 text-lg"
                                onClick={() => {
                                  setMessageInput(prev => prev + e)
                                  setShowEmojiPickerFor(null)
                                }}
                              >
                                {e}
                              </button>
                            ))}
                          </div>
                        )}
                      </div>
                      <input
                        type="file"
                        multiple
                        className="hidden"
                        ref={fileInputRef}
                        onChange={handleFileSelect}
                      />

                      <textarea
                        rows={1}
                        placeholder={`Message ${getActiveViewName()}`}
                        value={messageInput}
                        onChange={e => setMessageInput(e.target.value)}
                        onKeyPress={e => {
                          if (e.key === "Enter" && !e.shiftKey) {
                            e.preventDefault()
                            sendMessage()
                          }
                        }}
                        className="flex-1 bg-transparent border-none focus:ring-0 py-3.5 max-h-32 resize-none leading-relaxed font-medium text-slate-800 placeholder-slate-400"
                        style={{ minHeight: "48px" }}
                      />

                      <button
                        onClick={sendMessage}
                        disabled={
                          (!messageInput.trim() &&
                            selectedFiles.length === 0) ||
                          isUploading
                        }
                        className="p-3 mb-1 rounded-2xl shadow-lg transition-all active:scale-90 transform bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-200 disabled:text-slate-400 text-white shadow-indigo-200"
                      >
                        <Send className="w-5 h-5 ml-0.5" />
                      </button>
                    </div>
                  </div>
                  <div className="text-center mt-3 text-[10px] font-bold uppercase tracking-widest opacity-50 text-slate-400">
                    Press <strong>Enter</strong> to send
                  </div>
                </div>
              </div>

              {/* Member Details Sidebar - Added Logic for Add Friend */}
              <div
                className={`border-l transition-all duration-300 ease-[cubic-bezier(0.4,0,0.2,1)] flex flex-col z-30 border-slate-200 bg-white shadow-2xl ${
                  showMemberDetails
                    ? "w-80 translate-x-0"
                    : "w-0 translate-x-full opacity-0 overflow-hidden"
                }`}
              >
                <div className="h-[80px] flex items-center justify-between px-6 border-b border-slate-100 bg-slate-50/50">
                  <h3 className="font-bold text-lg text-slate-800">Details</h3>
                  <button
                    onClick={() => setShowMemberDetails(false)}
                    className="p-2 rounded-full transition-colors hover:bg-slate-200 text-slate-500"
                  >
                    <X className="w-5 h-5" />
                  </button>
                </div>

                <div className="flex-1 overflow-y-auto p-6 scrollbar-thin">
                  <div className="text-center mb-10">
                    <div className="inline-block relative mb-5">
                      {activeView === "dm" ? (
                        <span className="text-7xl drop-shadow-2xl filter text-slate-700">
                          {getUser(activeDMUser)?.avatar}
                        </span>
                      ) : (
                        <div className="w-24 h-24 rounded-[2rem] mx-auto flex items-center justify-center shadow-lg bg-gradient-to-br from-slate-100 to-slate-200 text-slate-400 shadow-inner">
                          <Hash className="w-10 h-10" />
                        </div>
                      )}
                    </div>
                    <h2 className="text-2xl font-bold mb-1 text-slate-900">
                      {getActiveViewName().replace("#", "")}
                    </h2>
                    {activeView === "channel" && (
                      <p className="text-sm font-medium text-slate-500">
                        {activeMembers.length} members in this channel
                      </p>
                    )}
                  </div>

                  {activeView === "channel" && (
                    <div className="mb-8">
                      <h4 className="text-[10px] font-bold uppercase tracking-widest mb-3 text-slate-400">
                        Topic
                      </h4>
                      <div className="rounded-2xl p-5 border text-sm leading-relaxed bg-slate-50 border-slate-100 text-slate-600">
                        Welcome to the{" "}
                        <span className="font-bold text-indigo-600">
                          #{getActiveViewName().replace("# ", "")}
                        </span>{" "}
                        channel. This is the beginning of your collaboration
                        journey in {getCurrentSpace()?.name}.
                      </div>
                    </div>
                  )}

                  <div>
                    <h4 className="text-[10px] font-bold uppercase tracking-widest mb-4 flex items-center justify-between text-slate-400">
                      Members
                      <span className="px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">
                        {activeMembers.length}
                      </span>
                    </h4>
                    <div className="space-y-2">
                      {activeMembers.map(member => {
                        const isMe = member.id === currentUser?.id
                        const isFriend = currentUser?.friends.includes(
                          member.id
                        )
                        const isPending = (() => {
                          if (isMe || isFriend) return false
                          // Check if member has an outgoing friend request to current user
                          const memberObj = users.find(u => u.id === member.id)
                          const hasOutgoing = memberObj?.notifications?.some(n => n.type === "friend_request" && n.fromId === currentUser?.id && n.status === "pending")
                          // Check if current user has an incoming friend request from member
                          const hasIncoming = currentUser?.notifications?.some(n => n.type === "friend_request" && n.fromId === member.id && n.status === "pending")
                          return !!hasOutgoing || !!hasIncoming
                        })()

                        return (
                          <div
                            key={member.id}
                            className="flex items-center gap-3 p-3 rounded-2xl transition-colors cursor-default group border border-transparent hover:bg-slate-50 hover:border-slate-100"
                          >
                            <div className="relative">
                              <div className="w-10 h-10 rounded-full flex items-center justify-center text-xl shadow-sm border bg-white border-slate-100">
                                {member.avatar}
                              </div>
                              <span
                                className={`absolute -bottom-0.5 -right-0.5 w-3 h-3 rounded-full border-2 border-white ${
                                  member.status === "online"
                                    ? "bg-emerald-500"
                                    : "bg-slate-300"
                                }`}
                              ></span>
                            </div>
                            <div className="overflow-hidden flex-1">
                              <div className="text-sm font-bold truncate text-slate-800">
                                {member.name}
                              </div>
                              <div className="text-xs truncate text-slate-400">
                                {member.email}
                              </div>
                            </div>
                            {isMe ? (
                              <span className="text-[10px] px-2 py-1 rounded-md font-bold tracking-wide bg-indigo-50 text-indigo-600">
                                YOU
                              </span>
                            ) : (
                              <div className="flex items-center gap-2">
                                {!isFriend && (
                                  <button
                                    onClick={() =>
                                      !isPending &&
                                      setShowAddFriendConfirm(member.id)
                                    }
                                    disabled={isPending}
                                    className={`p-1.5 rounded-lg transition-all ${
                                      isPending
                                        ? "text-slate-300 cursor-default"
                                        : "hover:bg-indigo-100 text-slate-400 hover:text-indigo-600"
                                    }`}
                                    title={
                                      isPending
                                        ? "Request Sent"
                                        : "Add to friends"
                                    }
                                  >
                                    {isPending ? (
                                      <Check className="w-4 h-4" />
                                    ) : (
                                      <Plus className="w-4 h-4" />
                                    )}
                                  </button>
                                )}

                                {/* Remove member (visible to main space or channel creator) */}
                                {(currentUser?.id === getCurrentSpace()?.ownerId || currentUser?.id === (getCurrentChannels().find(c => c.id === activeChannel)?.ownerId)) && !isMe && (
                                  <button
                                    onClick={() => handleRemoveMember(member.id)}
                                    className="p-1.5 rounded-lg transition-all hover:bg-red-100 text-slate-400 hover:text-red-600"
                                    title="Remove member"
                                  >
                                    <Trash2 className="w-4 h-4" />
                                  </button>
                                )}
                              </div>
                            )}
                          </div>
                        )
                      })}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </>
        )}
      </div>

      {/* Right Sidebar - FRIENDS & DMs */}
      <div className="hidden lg:flex flex-col w-80 border-l border-slate-200/60 bg-white z-20">
        <div className="p-6 h-[80px] border-b border-slate-100 flex items-center justify-between">
          <h3 className="font-extrabold text-lg text-slate-800">Friends</h3>
          <button
            onClick={() => {
              setInviteSearchQuery("")
              setSelectedFriendInvitees([])
              setShowAddFriendModal(true)
            }}
            className="p-2 rounded-xl transition-all hover:bg-slate-100 text-slate-400 hover:text-indigo-600"
          >
            <UserPlus className="w-5 h-5" />
          </button>
        </div>

        <div className="px-5 pt-6 pb-2">
          <div className="relative group">
            <Search className="absolute left-4 top-3.5 w-4 h-4 transition-colors text-slate-400 group-focus-within:text-indigo-500" />
            <input
              type="text"
              placeholder="Filter friends..."
              value={dmSearchQuery}
              onChange={e => setDmSearchQuery(e.target.value)}
              className="w-full pl-11 pr-4 py-3 rounded-2xl text-sm focus:outline-none transition-all bg-slate-100/50 border border-slate-200/50 focus:bg-white focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 text-slate-800"
            />
          </div>
        </div>

        <div className="flex-1 overflow-y-auto scrollbar-thin px-4 py-4 space-y-2">
          {dmSearchResults.length > 0 ? (
            dmSearchResults.map(result => (
              <div
                key={result.id}
                onClick={() => {
                  if (result.userId) {
                    setActiveDMUser(result.userId)
                    setActiveView("dm")
                    if (result.messageId) {
                      // Scroll to the message and pin it for review
                      setTargetMessageId(result.messageId)
                      setPinnedMessageId(result.messageId)
                      setHighlightTerm(debouncedDmSearchQuery)
                    } else {
                      // Navigating to a DM without a specific message should clear any pinned result
                      setPinnedMessageId(null)
                    }
                  }
                }}
                className={`flex items-center gap-3 p-3 rounded-2xl cursor-pointer transition-all border ${
                  activeView === "dm" && activeDMUser === result.userId
                    ? "bg-indigo-50 border-indigo-100"
                    : "bg-white border-transparent hover:bg-slate-50"
                }`}
              >
                <div className="relative">
                  <div className="w-10 h-10 rounded-full flex items-center justify-center text-lg shadow-sm bg-white border border-slate-100">
                    {result.icon}
                  </div>
                </div>
                <div className="flex-1 overflow-hidden">
                  <div className="flex justify-between items-center">
                    <span
                      className={`text-sm font-bold truncate ${
                        activeView === "dm" && activeDMUser === result.userId
                          ? "text-indigo-900"
                          : "text-slate-700"
                      }`}
                    >
                      {result.title}
                    </span>
                    {result.timestamp && (
                      <span className="text-[10px] text-slate-400">
                        {formatTime(result.timestamp)}
                      </span>
                    )}
                  </div>
                  <div className="text-xs text-slate-500 truncate">
                    {renderWithHighlight(
                      result.subtitle,
                      debouncedDmSearchQuery
                    )}
                  </div>
                </div>
              </div>
            ))
          ) : friends.length === 0 ? (
            <div className="text-center py-10 px-4">
              <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400">
                <Users className="w-8 h-8" />
              </div>
              <p className="text-sm font-medium text-slate-500 mb-4">
                No friends yet.
              </p>
              <button
                onClick={() => setShowAddFriendModal(true)}
                className="text-xs font-bold text-indigo-600 hover:underline"
              >
                Find people
              </button>
            </div>
          ) : (
            friends.map(friend => (
              <div
                key={friend.id}
                onClick={() => {
                  setActiveDMUser(friend.id)
                  setActiveView("dm")
                  justSwitchedThreadRef.current = true
                }}
                className={`flex items-center gap-3 p-3 rounded-2xl cursor-pointer transition-all border ${
                  activeView === "dm" && activeDMUser === friend.id
                    ? "bg-indigo-50 border-indigo-100"
                    : "bg-white border-transparent hover:bg-slate-50"
                }`}
              >
                <div className="relative">
                  <div className="w-10 h-10 rounded-full flex items-center justify-center text-lg shadow-sm bg-white border border-slate-100">
                    {friend.avatar}
                  </div>
                  <span
                    className={`absolute -bottom-0.5 -right-0.5 w-3 h-3 rounded-full border-2 border-white ${
                      friend.status === "online"
                        ? "bg-emerald-500"
                        : "bg-slate-300"
                    }`}
                  ></span>
                </div>
                <div className="flex-1 overflow-hidden">
                  <div className="text-sm font-bold truncate text-slate-700">
                    {friend.name}
                  </div>
                  <div className="text-xs text-slate-400 truncate">
                    {friend.status === "online" ? "Online" : "Offline"}
                  </div>
                </div>
                <div className="p-1.5 rounded-lg hover:bg-white hover:text-indigo-600 text-slate-300 transition-colors">
                  <MessageSquare className="w-4 h-4" />
                </div>
              </div>
            ))
          )}
        </div>
      </div>

      {/* --- MODALS --- */}

      {/* Add Friend Confirmation Modal */}
      {showAddFriendConfirm && (
        <div className="fixed inset-0 backdrop-blur-md flex items-center justify-center z-[100] p-6 animate-fade-in bg-slate-900/40">
          <div className="bg-white rounded-[2.5rem] p-8 w-full max-w-sm shadow-2xl border border-slate-100 text-center">
            <div className="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-3xl flex items-center justify-center mb-6 mx-auto shadow-sm">
              <UserPlus className="w-8 h-8" />
            </div>
            <h3 className="text-xl font-bold mb-2 text-slate-900">
              Add Friend?
            </h3>
            <p className="text-slate-500 text-sm mb-8 leading-relaxed">
              Do you want to send a friend request to{" "}
              <span className="font-bold">
                {users.find(u => u.id === showAddFriendConfirm)?.name}
              </span>
              ?
            </p>
            <div className="flex gap-4">
              <button
                onClick={() => setShowAddFriendConfirm(null)}
                className="flex-1 py-3 px-6 rounded-2xl font-bold text-slate-600 hover:bg-slate-100 transition-colors border border-slate-200"
              >
                No
              </button>
              <button
                onClick={() => {
                  if (showAddFriendConfirm)
                    sendFriendRequest(showAddFriendConfirm)
                  setShowAddFriendConfirm(null)
                }}
                className="flex-1 py-3 px-6 rounded-2xl font-bold bg-indigo-600 text-white shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all"
              >
                Yes
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Access Denied Modal */}
      {showAccessDeniedModal && (
        <div className="fixed inset-0 backdrop-blur-md flex items-center justify-center z-[100] p-6 animate-fade-in bg-slate-900/40">
          <div className="bg-white rounded-[2.5rem] p-8 w-full max-w-sm shadow-2xl border border-slate-100">
            <div className="w-16 h-16 bg-red-100 text-red-600 rounded-3xl flex items-center justify-center mb-6 mx-auto shadow-sm">
              <ShieldAlert className="w-8 h-8" />
            </div>
            <h3 className="text-xl font-bold text-center mb-2 text-slate-900">
              Access Restricted
            </h3>
            <p className="text-slate-500 text-center text-sm mb-8 leading-relaxed">
              The admin has not allowed you to view/message this channel. Please
              ask for an invite.
            </p>
            <button
              onClick={() => {
                setShowAccessDeniedModal(false)
                // Switch to a different view or channel to avoid repeated access attempts
                setActiveView("calendar")
              }}
              className="w-full py-3.5 px-6 rounded-2xl font-bold bg-slate-900 text-white shadow-lg hover:bg-slate-800 transition-all active:scale-95"
            >
              Understood
            </button>
          </div>
        </div>
      )}

      {/* Rename Modal */}
      {showRenameModal && (
        <div className="fixed inset-0 backdrop-blur-md flex items-center justify-center z-50 p-6 animate-fade-in bg-slate-900/40">
          <div className="rounded-[2rem] p-8 w-full max-w-sm shadow-2xl bg-white ring-1 ring-slate-900/5">
            <h3 className="text-xl font-bold mb-6 text-slate-900">
              Rename {showRenameModal.type === "space" ? "Space" : "Channel"}
            </h3>
            <input
              type="text"
              className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl mb-6 outline-none focus:ring-2 focus:ring-indigo-500"
              placeholder={showRenameModal.currentName}
              defaultValue={showRenameModal.currentName}
              onChange={e => setNewNameInput(e.target.value)}
              autoFocus
            />
            <div className="flex gap-4">
              <button
                onClick={() => {
                  setShowRenameModal(null)
                  setNewNameInput("")
                }}
                className="flex-1 py-3 rounded-2xl font-bold text-slate-500 border border-slate-200 hover:bg-slate-50"
              >
                Cancel
              </button>
              <button
                onClick={handleRename}
                className="flex-1 py-3 rounded-2xl font-bold bg-indigo-600 text-white shadow-lg shadow-indigo-200 hover:bg-indigo-700"
              >
                Save
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      {showDeleteConfirm && (
        <div className="fixed inset-0 backdrop-blur-md flex items-center justify-center z-50 p-6 animate-fade-in bg-slate-900/40">
          <div className="bg-white rounded-[2.5rem] p-8 w-full max-w-sm shadow-2xl border border-slate-100">
            <div className="w-16 h-16 bg-red-100 text-red-600 rounded-3xl flex items-center justify-center mb-6 mx-auto">
              <Trash2 className="w-8 h-8" />
            </div>
            <h3 className="text-xl font-bold text-center mb-2 text-slate-900">
              Are you sure?
            </h3>
            <p className="text-slate-500 text-center text-sm mb-8 leading-relaxed">
              You are about to delete this {showDeleteConfirm.type}. This action
              cannot be undone.
            </p>
            <div className="flex gap-4">
              <button
                onClick={() => setShowDeleteConfirm(null)}
                className="flex-1 py-3 px-6 rounded-2xl font-bold text-slate-600 hover:bg-slate-100 transition-colors border border-slate-200"
              >
                Cancel
              </button>
              <button
                onClick={handleDelete}
                className="flex-1 py-3 px-6 rounded-2xl font-bold bg-red-600 text-white shadow-lg shadow-red-200 hover:bg-red-700 transition-all"
              >
                Delete
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Remove Member Confirmation Modal */}
      {showRemoveMemberConfirm && (
        <div className="fixed inset-0 backdrop-blur-md flex items-center justify-center z-50 p-6 animate-fade-in bg-slate-900/40">
          <div className="bg-white rounded-[2.5rem] p-8 w-full max-w-sm shadow-2xl border border-slate-100">
            <div className="w-16 h-16 bg-yellow-100 text-yellow-600 rounded-3xl flex items-center justify-center mb-6 mx-auto">
              <Trash2 className="w-8 h-8" />
            </div>
            <h3 className="text-xl font-bold text-center mb-2 text-slate-900">
              Remove member?
            </h3>
            <p className="text-slate-500 text-center text-sm mb-8 leading-relaxed">
              You are about to remove <strong>{showRemoveMemberConfirm.name}</strong> from <strong>{getActiveViewName().replace('# ', '')}</strong>. They will receive a notification about this.
            </p>
            <div className="flex gap-4">
              <button
                onClick={() => setShowRemoveMemberConfirm(null)}
                className="flex-1 py-3 px-6 rounded-2xl font-bold text-slate-600 hover:bg-slate-100 transition-colors border border-slate-200"
              >
                Cancel
              </button>
              <button
                onClick={confirmRemoveMember}
                className="flex-1 py-3 px-6 rounded-2xl font-bold bg-red-600 text-white shadow-lg shadow-red-200 hover:bg-red-700 transition-all"
              >
                Remove
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Event Modal (Day Details + Create) */}
      {showEventModal && (
        <div className="fixed inset-0 backdrop-blur-md flex items-center justify-center z-50 p-6 animate-fade-in bg-slate-900/40">
          <div className="rounded-[2rem] p-6 w-full max-w-2xl shadow-2xl bg-white ring-1 ring-slate-900/5">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-2xl font-bold text-slate-800">
                {selectedDate ? new Date(selectedDate).toDateString() : 'Day Details'}
              </h3>
              <div className="flex items-center gap-2">
                <button onClick={() => setShowNewEventForm(prev => !prev)} className="px-3 py-2 rounded-2xl border bg-white text-sm">{showNewEventForm ? 'Close' : 'New Event'}</button>
                <button onClick={() => setShowEventModal(false)} className="px-3 py-2 rounded-2xl border bg-white text-sm">Close</button>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="space-y-4">
                <h4 className="text-sm font-bold text-slate-600">Events</h4>
                <div className="rounded-2xl border p-3 max-h-96 overflow-y-auto bg-slate-50">
                  {((events || []).filter(e => e.startDate === (selectedDate ? new Date(selectedDate).toISOString().split('T')[0] : '')) || []).length === 0 ? (
                    <div className="text-sm text-slate-500">No events for this day.</div>
                  ) : (
                    (events || []).filter(e => e.startDate === (selectedDate ? new Date(selectedDate).toISOString().split('T')[0] : '')).map(ev => (
                      <div key={ev.id} className="p-3 rounded-md bg-white border mb-2">
                        <div className="flex items-center justify-between">
                          <div>
                            <div className="font-bold">{ev.title}</div>
                            <div className="text-xs text-slate-500">{ev.startDateTime ? new Date(ev.startDateTime).toLocaleString() : ''}</div>
                          </div>
                          <div className="flex items-center gap-2">
                            {ev.type === 'meeting' && ev.link && (
                              <button onClick={() => window.open(ev.link, '_blank')} className="px-3 py-1 rounded-2xl bg-indigo-600 text-white text-sm">Join</button>
                            )}
                          </div>
                        </div>
                        {ev.description && <div className="text-sm text-slate-600 mt-2">{ev.description}</div>}
                      </div>
                    ))
                  )}
                </div>
              </div>

              <div>
                {showNewEventForm ? (
                  <div className="space-y-4">
                    <div>
                      <label className="block text-[10px] font-bold uppercase tracking-widest text-slate-500 mb-2">Title</label>
                      <input type="text" value={newEvent.title} onChange={e => setNewEvent({ ...newEvent, title: e.target.value })} className="w-full px-5 py-3 rounded-2xl bg-white border border-slate-200 focus:outline-none" placeholder="Event title" />
                    </div>
                    <div>
                      <label className="block text-[10px] font-bold uppercase tracking-widest text-slate-500 mb-2">Time</label>
                      <input type="time" value={newEvent.time} onChange={e => setNewEvent({ ...newEvent, time: e.target.value })} className="w-full px-5 py-3 rounded-2xl bg-white border border-slate-200" />
                    </div>
                    <div>
                      <label className="block text-[10px] font-bold uppercase tracking-widest text-slate-500 mb-2">Description</label>
                      <textarea value={newEvent.description} onChange={e => setNewEvent({ ...newEvent, description: e.target.value })} className="w-full px-5 py-3 rounded-2xl bg-white border border-slate-200 h-28" />
                    </div>
                    <div className="flex gap-3 justify-end">
                      <button onClick={() => setShowNewEventForm(false)} className="px-4 py-2 rounded-2xl border">Cancel</button>
                      <button onClick={saveCalendarEvent} className="px-4 py-2 rounded-2xl bg-indigo-600 text-white">Save</button>
                    </div>
                  </div>
                ) : (
                  <div className="text-sm text-slate-500">Select "New Event" to create a calendar entry for this day.</div>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Create Space Modal */}
      {showCreateSpaceModal && (
        <div className="fixed inset-0 backdrop-blur-md flex items-center justify-center z-50 p-6 animate-fade-in bg-slate-900/40">
          <div className="rounded-[2rem] p-8 w-full max-w-sm shadow-2xl bg-white ring-1 ring-slate-900/5">
            <h3 className="text-2xl font-bold mb-6 text-slate-800">
              Create Space
            </h3>
            <div className="space-y-4">
              <input
                type="text"
                value={newSpaceName}
                onChange={e => setNewSpaceName(e.target.value)}
                className="w-full px-5 py-4 rounded-2xl bg-slate-50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="Space Name"
                autoFocus
              />
              <div className="flex gap-4">
                <button
                  onClick={() => setShowCreateSpaceModal(false)}
                  className="flex-1 py-3.5 font-bold rounded-2xl text-slate-500 border border-slate-200 hover:bg-slate-50 transition-colors"
                >
                  Cancel
                </button>
                <button
                  onClick={createSpace}
                  className="flex-1 py-3.5 font-bold rounded-2xl bg-indigo-600 text-white shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all"
                >
                  Create
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Add Friend Modal - UPDATED FOR BULK SELECTION */}
      {showAddFriendModal && (
        <div className="fixed inset-0 backdrop-blur-md flex items-center justify-center z-50 p-6 animate-fade-in bg-slate-900/40">
          <div className="rounded-[2rem] p-8 w-full max-w-md shadow-2xl bg-white ring-1 ring-slate-900/5">
            <div className="flex items-center justify-between mb-8">
              <h3 className="text-3xl font-bold text-slate-800">Add Friends</h3>
              <button
                onClick={() => setShowAddFriendModal(false)}
                className="p-2 rounded-full transition-colors hover:bg-slate-100 text-slate-500"
              >
                <X className="w-6 h-6" />
              </button>
            </div>
            {!inviteSent ? (
              <div className="space-y-6">
                <div className="relative">
                  <label className="block text-[10px] font-bold uppercase tracking-widest text-slate-500 mb-2">
                    Find People
                  </label>
                  <div className="relative">
                    <Search className="absolute left-5 top-4 w-5 h-5 text-slate-500" />
                    <input
                      type="text"
                      value={inviteSearchQuery}
                      onChange={e => {
                        setInviteSearchQuery(e.target.value)
                      }}
                      placeholder="Search by name..."
                      className="w-full pl-12 pr-5 py-4 rounded-2xl focus:outline-none focus:ring-2 focus:ring-pink-500/50 focus:border-transparent font-medium bg-slate-50 border border-slate-200 text-slate-800"
                    />
                  </div>
                  {inviteSearchResults.length > 0 && (
                    <div className="absolute z-10 w-full mt-2 rounded-2xl shadow-xl max-h-48 overflow-y-auto py-2 bg-white border border-slate-100">
                      {inviteSearchResults.map(u => {
                        const isSelected = selectedFriendInvitees.includes(u.id)
                        return (
                          <div
                            key={u.id}
                            onClick={() => toggleFriendSelection(u.id)}
                            className={`px-5 py-3 cursor-pointer flex items-center justify-between gap-3 transition-colors border-l-4 ${
                              isSelected
                                ? "border-indigo-500 bg-indigo-50"
                                : "border-transparent hover:bg-slate-50"
                            }`}
                          >
                            <div className="flex items-center gap-3">
                              <span className="text-xl rounded-full w-9 h-9 flex items-center justify-center bg-slate-50">
                                {u.avatar}
                              </span>
                              <span className="font-bold text-slate-700">
                                {u.name}
                              </span>
                            </div>
                            {isSelected && (
                              <CheckCircle className="w-5 h-5 text-indigo-500" />
                            )}
                          </div>
                        )
                      })}
                    </div>
                  )}
                </div>
                {selectedFriendInvitees.length > 0 && (
                  <div className="p-4 rounded-2xl border bg-indigo-50 border-indigo-100">
                    <p className="text-[10px] font-bold uppercase tracking-wide text-indigo-500 mb-2">
                      Selected ({selectedFriendInvitees.length})
                    </p>
                    <div className="flex flex-wrap gap-2">
                      {selectedFriendInvitees.map(id => {
                        const u =
                          inviteSearchResults.find(r => r.id === id) ||
                          users.find(us => us.id === id)
                        return (
                          <div
                            key={id}
                            className="text-xs bg-white px-2 py-1 rounded-lg border border-indigo-100 font-bold text-indigo-800 flex items-center gap-1"
                          >
                            {u?.name}
                            <X
                              className="w-3 h-3 cursor-pointer"
                              onClick={() => toggleFriendSelection(id)}
                            />
                          </div>
                        )
                      })}
                    </div>
                  </div>
                )}
                <button
                  onClick={handleBulkFriendInvite}
                  disabled={selectedFriendInvitees.length === 0}
                  className="w-full py-4 rounded-2xl font-bold disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 text-white shadow-lg transition-all transform hover:scale-[1.02] bg-indigo-600 hover:bg-indigo-700 shadow-indigo-200"
                >
                  <UserPlus className="w-5 h-5" />
                  Send {selectedFriendInvitees.length} Request
                  {selectedFriendInvitees.length !== 1 ? "s" : ""}
                </button>
              </div>
            ) : (
              <div className="text-center py-10">
                <div className="w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 border animate-bounce bg-emerald-100 border-emerald-200">
                  <Check className="w-12 h-12 text-emerald-600" />
                </div>
                <h4 className="text-2xl font-bold mb-2 text-slate-800">
                  Sent!
                </h4>
                <p className="text-slate-500">
                  Friend requests delivered successfully.
                </p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Add To Channel Modal - Invite Member logic */}
      {showAddToSpaceModal && (
        <div className="fixed inset-0 backdrop-blur-md flex items-center justify-center z-50 p-6 animate-fade-in bg-slate-900/40">
          <div className="rounded-[2rem] p-8 w-full max-w-md shadow-2xl bg-white ring-1 ring-slate-900/5">
            <div className="flex items-center justify-between mb-8">
              <h3 className="text-3xl font-bold text-slate-800">
                Invite Members
              </h3>
              <button
                onClick={() => setShowAddToSpaceModal(false)}
                className="p-2 rounded-full transition-colors hover:bg-slate-100 text-slate-500"
              >
                <X className="w-6 h-6" />
              </button>
            </div>

            {!inviteSent ? (
              <div className="space-y-6">
                {friends.length === 0 ? (
                  <div className="text-center py-8">
                    <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400">
                      <Users className="w-8 h-8" />
                    </div>
                    <p className="text-sm font-medium text-slate-600 mb-6 px-4">
                      You need to be friends with people before inviting them to
                      this channel.
                    </p>
                    <button
                      onClick={() => {
                        setShowAddToSpaceModal(false)
                        setShowAddFriendModal(true)
                      }}
                      className="w-full py-4 rounded-2xl font-bold bg-indigo-600 text-white shadow-lg hover:bg-indigo-700 transition-all flex items-center justify-center gap-2"
                    >
                      <UserPlus className="w-5 h-5" /> Find Friends
                    </button>
                  </div>
                ) : (
                  <>
                    <div className="relative">
                      <label className="block text-[10px] font-bold uppercase tracking-widest text-slate-500 mb-2">
                        Search Friends
                      </label>
                      <div className="relative">
                        <Search className="absolute left-5 top-4 w-5 h-5 text-slate-500" />
                        <input
                          type="text"
                          value={inviteSearchQuery}
                          onChange={e => setInviteSearchQuery(e.target.value)}
                          placeholder="Search by name..."
                          className="w-full pl-12 pr-5 py-4 rounded-2xl focus:outline-none focus:ring-2 focus:ring-pink-500/50 focus:border-transparent font-medium bg-slate-50 border border-slate-200 text-slate-800"
                        />
                      </div>
                      {inviteSearchResults.length > 0 && (
                        <div className="absolute z-10 w-full mt-2 rounded-2xl shadow-xl max-h-48 overflow-y-auto py-2 bg-white border border-slate-100">
                          {inviteSearchResults.map(u => {
                            const isSelected = selectedInviteUsers.includes(
                              u.id
                            )
                            return (
                              <div
                                key={u.id}
                                onClick={() => toggleInviteSelection(u.id)}
                                className={`px-5 py-3 cursor-pointer flex items-center justify-between gap-3 transition-colors border-l-4 ${
                                  isSelected
                                    ? "border-indigo-500 bg-indigo-50"
                                    : "border-transparent hover:bg-slate-50"
                                }`}
                              >
                                <div className="flex items-center gap-3">
                                  <span className="text-xl rounded-full w-9 h-9 flex items-center justify-center bg-slate-50">
                                    {u.avatar}
                                  </span>
                                  <span className="font-bold text-slate-700">
                                    {u.name}
                                  </span>
                                </div>
                                {isSelected && (
                                  <CheckCircle className="w-5 h-5 text-indigo-500" />
                                )}
                              </div>
                            )
                          })}
                        </div>
                      )}
                    </div>
                    {selectedInviteUsers.length > 0 && (
                      <div className="p-4 rounded-2xl border bg-indigo-50 border-indigo-100">
                        <p className="text-[10px] font-bold uppercase tracking-wide text-indigo-500 mb-2">
                          Selected ({selectedInviteUsers.length})
                        </p>
                        <div className="flex flex-wrap gap-2">
                          {selectedInviteUsers.map(id => {
                            const u =
                              inviteSearchResults.find(r => r.id === id) ||
                              users.find(us => us.id === id)
                            return (
                              <div
                                key={id}
                                className="text-xs bg-white px-2 py-1 rounded-lg border border-indigo-100 font-bold text-indigo-800 flex items-center gap-1"
                              >
                                {u?.name}
                                <X
                                  className="w-3 h-3 cursor-pointer"
                                  onClick={() => toggleInviteSelection(id)}
                                />
                              </div>
                            )
                          })}
                        </div>
                      </div>
                    )}
                    <button
                      onClick={addFriendsToChannel}
                      disabled={selectedInviteUsers.length === 0}
                      className="w-full py-4 rounded-2xl font-bold disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 text-white shadow-lg transition-all transform hover:scale-[1.02] bg-indigo-600 hover:bg-indigo-700 shadow-indigo-200"
                    >
                      <UserPlus className="w-5 h-5" />
                      Add {selectedInviteUsers.length} Member
                      {selectedInviteUsers.length !== 1 ? "s" : ""}
                    </button>

                    <div className="text-center mt-2">
                      <button
                        onClick={() => {
                          setShowAddToSpaceModal(false)
                          setShowAddFriendModal(true)
                        }}
                        className="text-xs font-bold text-slate-400 hover:text-indigo-600 transition-colors"
                      >
                        Don't see them? Find new friends
                      </button>
                    </div>
                  </>
                )}
              </div>
            ) : (
              <div className="text-center py-10">
                <div className="w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 border animate-bounce bg-emerald-100 border-emerald-200">
                  <Check className="w-12 h-12 text-emerald-600" />
                </div>
                <h4 className="text-2xl font-bold mb-2 text-slate-800">
                  Added!
                </h4>
                <p className="text-slate-500">
                  Members successfully added to the channel.
                </p>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Notifications Modal */}
      {showNotificationsModal && (
        <div className="fixed inset-0 backdrop-blur-md flex items-center justify-center z-50 p-6 animate-fade-in bg-slate-900/40">
          <div className="rounded-[2rem] p-8 w-full max-w-md shadow-2xl flex flex-col max-h-[80vh] bg-white ring-1 ring-slate-900/5">
            <div className="flex items-center justify-between mb-8">
              <h3 className="text-3xl font-bold flex items-center gap-3 text-slate-800">
                <Bell className="w-8 h-8 text-indigo-500" /> Notifications
              </h3>
              <div className="flex items-center gap-2">
                <button
                  onClick={clearAllNotifications}
                  disabled={!((currentUser?.notifications || []).some(n => n.type === 'info'))}
                  className="text-sm font-bold px-3 py-2 rounded-xl transition-colors text-slate-500 hover:bg-slate-100 disabled:opacity-40 disabled:cursor-not-allowed"
                >
                  Clear all
                </button>
                <button
                  onClick={() => setShowNotificationsModal(false)}
                  className="p-2 rounded-full transition-colors hover:bg-slate-100 text-slate-500"
                >
                  <X className="w-6 h-6" />
                </button>
              </div>
            </div>
            <div className="flex-1 overflow-y-auto space-y-3 pr-2 scrollbar-thin">
              {currentUser?.notifications.length === 0 ? (
                <div className="text-center py-16 text-slate-500">
                  <Bell className="w-16 h-16 mx-auto mb-4 opacity-20" />
                  <p className="font-medium">No new notifications</p>
                </div>
              ) : (
                currentUser?.notifications.map(notif => (
                  <div
                    key={notif.id}
                    className="p-5 border rounded-2xl transition-all group border-slate-100 bg-slate-50 hover:bg-white hover:shadow-lg"
                  >
                    <div className="flex gap-4">
                      <div className="p-3 rounded-full h-fit shadow-sm bg-white border border-slate-100">
                        {notif.type === "friend_request" ? (
                          <UserPlus className="w-5 h-5 text-indigo-600" />
                        ) : notif.type === "info" ? (
                          <Info className="w-5 h-5 text-emerald-500" />
                        ) : (
                          <Mail className="w-5 h-5 text-pink-500" />
                        )}
                      </div>
                      <div className="flex-1">
                        {notif.type === "friend_request" ? (
                          <p className="text-sm leading-relaxed text-slate-600">
                            <span className="font-bold text-slate-900">
                              {notif.from}
                            </span>{" "}
                            sent you a friend request.
                          </p>
                        ) : notif.type === "info" ? (
                          <p className="text-sm leading-relaxed text-slate-600">
                            {notif.message}
                          </p>
                        ) : (
                          <p className="text-sm leading-relaxed text-slate-600">
                            <span className="font-bold text-slate-900">
                              {notif.from}
                            </span>{" "}
                            invited you to{" "}
                            <span className="font-bold text-indigo-600">
                              {notif.spaceName}
                            </span>
                          </p>
                        )}



                        {notif.type === "info" ? (
                          <button
                            onClick={() => dismissNotification(notif.id)}
                            className="mt-3 text-xs font-bold text-slate-400 hover:text-slate-600"
                          >
                            Dismiss
                          </button>
                        ) : (
                          <div className="flex gap-3 mt-4">
                            <button
                              onClick={() =>
                                handleNotificationAction(notif.id, notif.type)
                              }
                              className="flex-1 text-xs font-bold py-3 rounded-xl flex items-center justify-center gap-2 shadow-lg transition-all transform active:scale-95 bg-indigo-600 hover:bg-indigo-700 text-white"
                            >
                              <CheckCircle className="w-4 h-4" /> Accept
                            </button>
                            <button
                              onClick={() =>
                                handleRejectNotification(notif.id, notif.type)
                              }
                              className="flex-1 text-xs font-bold py-3 rounded-xl flex items-center justify-center gap-2 border border-slate-200 transition-all hover:bg-slate-100 text-slate-500"
                            >
                              Reject
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        </div>
      )}

      {/* Create Channel Modal */}
      {showChannelModal && (
        <div className="fixed inset-0 backdrop-blur-md flex items-center justify-center z-50 p-6 animate-fade-in bg-slate-900/40">
          <div className="rounded-[2rem] p-8 w-full max-w-sm shadow-2xl bg-white ring-1 ring-slate-900/5">
            <h3 className="text-2xl font-bold mb-6 text-slate-800">
              New Channel
            </h3>
            <div className="space-y-4">
              <input
                type="text"
                value={newChannelName}
                onChange={e => setNewChannelName(e.target.value)}
                className="w-full px-5 py-4 rounded-2xl bg-slate-50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="Channel Name"
                autoFocus
              />
              <div className="flex gap-4">
                <button
                  onClick={() => setShowChannelModal(false)}
                  className="flex-1 py-3.5 font-bold rounded-2xl text-slate-500 border border-slate-200 hover:bg-slate-50 transition-colors"
                >
                  Cancel
                </button>
                <button
                  onClick={createChannel}
                  className="flex-1 py-3.5 font-bold rounded-2xl bg-indigo-600 text-white shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all"
                >
                  Create
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Docs Modal */}
      {showDocsModal && (
        <div className="fixed inset-0 backdrop-blur-lg flex items-center justify-center z-50 p-4 md:p-6 animate-fade-in bg-slate-900/50">
          <div className="rounded-[2rem] p-6 md:p-8 w-full max-w-6xl max-h-[90vh] shadow-2xl bg-gradient-to-br from-white to-slate-50/50 ring-1 ring-slate-200/50 flex flex-col backdrop-blur-xl">
            <div className="flex items-center justify-between mb-8">
              <div className="flex items-center gap-4">
                <div className="p-3 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 shadow-lg shadow-indigo-200">
                  <FileText className="w-7 h-7 text-white" />
                </div>
                <div>
                  <h3 className="text-3xl font-bold text-slate-800">
                    My Documents
                  </h3>
                  <p className="text-sm text-slate-500 mt-0.5">Access your Google Drive files and Gmail attachments</p>
                </div>
                {googleAccessToken && (
                  <button
                    onClick={() => setShowConnectAppsModal(true)}
                    className="ml-auto px-5 py-2.5 text-sm font-bold rounded-xl bg-gradient-to-r from-indigo-50 to-purple-50 text-indigo-600 hover:from-indigo-100 hover:to-purple-100 transition-all flex items-center gap-2 border border-indigo-100 shadow-sm hover:shadow-md"
                  >
                    <Plus className="w-4 h-4" />
                    Connect More Apps
                  </button>
                )}
              </div>
              <button
                onClick={() => setShowDocsModal(false)}
                className="p-2.5 rounded-xl transition-all hover:bg-slate-100 text-slate-400 hover:text-slate-600 hover:rotate-90 duration-300"
              >
                <X className="w-6 h-6" />
              </button>
            </div>

            {!googleAccessToken ? (
              <div className="flex-1 flex flex-col items-center justify-center py-16">
                <div className="w-24 h-24 rounded-full flex items-center justify-center mb-6 bg-gradient-to-br from-indigo-50 to-purple-50 border-2 border-indigo-100">
                  <FileText className="w-12 h-12 text-indigo-600" />
                </div>
                <h4 className="text-2xl font-bold mb-3 text-slate-800">Connect Your Google Account</h4>
                <p className="text-slate-500 mb-6 text-center max-w-md">
                  Connect your Google account to access <strong>Gmail attachments</strong> and <strong>Google Drive files</strong> in one unified view.
                </p>
                <p className="text-xs text-slate-400 mb-4 text-center">
                  You'll be asked to grant permissions for Gmail and Drive access.
                </p>
                <button
                  onClick={handleConnectGoogleDocs}
                  className="px-8 py-4 font-bold rounded-2xl transition-all flex items-center gap-3 bg-indigo-600 hover:bg-indigo-700 text-white shadow-lg shadow-indigo-200"
                >
                  <svg className="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                  </svg>
                  Connect Google Account
                </button>
              </div>
            ) : (
              <div className="flex-1 flex flex-col overflow-hidden">
                {loadingDocs ? (
                  <div className="flex-1 flex items-center justify-center">
                    <div className="text-center">
                      <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                      <p className="text-slate-500 text-sm">Loading documents...</p>
                    </div>
                  </div>
                ) : docsError ? (
                  <div className="flex-1 flex items-center justify-center">
                    <div className="text-center">
                      <div className="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 bg-red-50">
                        <XCircle className="w-8 h-8 text-red-600" />
                      </div>
                      <p className="text-red-600 font-medium mb-4">{docsError}</p>
                      <button
                        onClick={() => loadGoogleDocs(googleAccessToken)}
                        className="px-6 py-3 font-bold rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white"
                      >
                        Retry
                      </button>
                    </div>
                  </div>
                ) : (
                  <>
                    {/* Filter Tabs */}
                    <div className="flex flex-wrap gap-3 mb-8 pb-2">
                      <button
                        onClick={() => {
                          setSelectedAppFilter('all')
                          loadGoogleDocs(googleAccessToken)
                        }}
                        className={`px-5 py-3 rounded-xl font-bold text-sm whitespace-nowrap transition-all transform hover:scale-105 flex items-center justify-center gap-2.5 ${
                          selectedAppFilter === 'all'
                            ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg shadow-indigo-200'
                            : 'bg-white text-slate-600 hover:bg-slate-50 border border-slate-200 hover:border-indigo-200 shadow-sm'
                        }`}
                      >
                        All Documents
                      </button>
                      {googleDocs.some(doc => GoogleService.getAppTypeFromMime(doc.mimeType) === 'docs') && (
                        <button
                          onClick={() => {
                            setSelectedAppFilter('docs')
                            loadGoogleDocs(googleAccessToken, 'docs')
                          }}
                          className={`px-5 py-3 rounded-xl font-bold text-sm whitespace-nowrap transition-all flex items-center justify-center gap-2.5 transform hover:scale-105 ${
                            selectedAppFilter === 'docs'
                              ? 'bg-blue-600 text-white shadow-lg shadow-blue-200'
                              : 'bg-white text-blue-600 hover:bg-blue-50 border border-blue-200 hover:border-blue-300 shadow-sm'
                          }`}
                        >
                          <img src="https://ssl.gstatic.com/docs/doclist/images/mediatype/icon_1_document_x16.png" alt="Docs" className="w-4 h-4 flex-shrink-0 object-contain" /> Docs
                        </button>
                      )}
                      {googleDocs.some(doc => GoogleService.getAppTypeFromMime(doc.mimeType) === 'sheets') && (
                        <button
                          onClick={() => {
                            setSelectedAppFilter('sheets')
                            loadGoogleDocs(googleAccessToken, 'sheets')
                          }}
                          className={`px-5 py-3 rounded-xl font-bold text-sm whitespace-nowrap transition-all flex items-center justify-center gap-2.5 transform hover:scale-105 ${
                            selectedAppFilter === 'sheets'
                              ? 'bg-green-600 text-white shadow-lg shadow-green-200'
                              : 'bg-white text-green-600 hover:bg-green-50 border border-green-200 hover:border-green-300 shadow-sm'
                          }`}
                        >
                          <img src="https://ssl.gstatic.com/docs/doclist/images/mediatype/icon_1_spreadsheet_x16.png" alt="Sheets" className="w-4 h-4 flex-shrink-0 object-contain" /> Sheets
                        </button>
                      )}
                      {googleDocs.some(doc => GoogleService.getAppTypeFromMime(doc.mimeType) === 'slides') && (
                        <button
                          onClick={() => {
                            setSelectedAppFilter('slides')
                            loadGoogleDocs(googleAccessToken, 'slides')
                          }}
                          className={`px-5 py-3 rounded-xl font-bold text-sm whitespace-nowrap transition-all flex items-center justify-center gap-2.5 transform hover:scale-105 ${
                            selectedAppFilter === 'slides'
                              ? 'bg-yellow-600 text-white shadow-lg shadow-yellow-200'
                              : 'bg-white text-yellow-600 hover:bg-yellow-50 border border-yellow-200 hover:border-yellow-300 shadow-sm'
                          }`}
                        >
                          <img src="https://ssl.gstatic.com/docs/doclist/images/mediatype/icon_1_presentation_x16.png" alt="Slides" className="w-4 h-4 flex-shrink-0 object-contain" /> Slides
                        </button>
                      )}
                      {gmailAttachments.length > 0 && (
                        <button
                          onClick={() => {
                            setSelectedAppFilter('gmail')
                            loadGoogleDocs(googleAccessToken, 'gmail')
                          }}
                          className={`px-5 py-3 rounded-xl font-bold text-sm whitespace-nowrap transition-all flex items-center justify-center gap-2.5 transform hover:scale-105 ${
                            selectedAppFilter === 'gmail'
                              ? 'bg-red-600 text-white shadow-lg shadow-red-200'
                              : 'bg-white text-red-600 hover:bg-red-50 border border-red-200 hover:border-red-300 shadow-sm'
                          }`}
                        >
                          <img src="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico" alt="Gmail" className="w-4 h-4 flex-shrink-0 object-contain" /> Gmail
                        </button>
                      )}
                    </div>

                    {/* Documents Grid */}
                    <div className="flex-1 overflow-y-auto pr-2">
                      {(selectedAppFilter === 'all' || selectedAppFilter !== 'gmail') && googleDocs.length > 0 && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mb-6">
                          {googleDocs.map((doc) => {
                            const appType = GoogleService.getAppTypeFromMime(doc.mimeType)
                            const appIcon = GoogleService.getAppIcon(appType)
                            const appName = GoogleService.getAppDisplayName(appType)
                            
                            return (
                              <div
                                key={doc.id}
                                className={`group relative rounded-2xl border overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-2 bg-white ${appIcon.border} hover:border-indigo-400 shadow-sm hover:scale-[1.02]`}
                              >
                                {/* Document Preview/Thumbnail */}
                                <a
                                  href={doc.webViewLink}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="block"
                                >
                                  <div className={`h-32 flex items-center justify-center relative ${appIcon.color}`}>
                                    {doc.thumbnailLink ? (
                                      <img 
                                        src={doc.thumbnailLink} 
                                        alt={doc.name}
                                        className="w-full h-full object-cover"
                                      />
                                    ) : (
                                      <>
                                        <img 
                                          src={appIcon.iconUrl} 
                                          alt={appName}
                                          className="w-16 h-16 object-contain"
                                          onError={(e) => {
                                            e.target.style.display = 'none'
                                            e.target.nextElementSibling.style.display = 'flex'
                                          }}
                                        />
                                        <span className="text-6xl hidden items-center justify-center">{appIcon.emoji}</span>
                                      </>
                                    )}
                                    {/* App Badge */}
                                    <div className="absolute top-2 right-2 px-2 py-1 rounded-lg text-[10px] font-bold bg-white/90 backdrop-blur-sm text-slate-700 shadow-sm">
                                      {appName}
                                    </div>
                                  </div>
                                </a>
                                
                                {/* Document Info */}
                                <div className="p-4">
                                  <a
                                    href={doc.webViewLink}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="block"
                                  >
                                    <h5 className="font-bold text-slate-800 truncate mb-1 group-hover:text-indigo-600 transition-colors">
                                      {doc.name}
                                    </h5>
                                    <p className="text-xs text-slate-500 mb-2">
                                      Modified {new Date(doc.modifiedTime).toLocaleDateString('en-US', { 
                                        month: 'short', 
                                        day: 'numeric',
                                        year: 'numeric'
                                      })}
                                    </p>
                                  </a>
                                  <div className="flex items-center justify-between">
                                    <span className="text-[10px] font-bold uppercase tracking-wide text-slate-400">
                                      {doc.mimeType?.split('/')[1]?.replace('vnd.google-apps.', '') || 'file'}
                                    </span>
                                    <div className="flex items-center gap-2">
                                      <button
                                        onClick={(e) => {
                                          e.preventDefault()
                                          e.stopPropagation()
                                          addDocumentAsAttachment(doc)
                                        }}
                                        className="p-2 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 text-white hover:from-indigo-600 hover:to-purple-700 transition-all shadow-md hover:shadow-lg transform hover:scale-110 active:scale-95"
                                        title="Add to message"
                                      >
                                        <Plus className="w-4 h-4" />
                                      </button>
                                      <a
                                        href={doc.webViewLink}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="text-slate-400 group-hover:text-indigo-600 transition-colors"
                                      >
                                        <ExternalLink className="w-4 h-4" />
                                      </a>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            )
                          })}
                        </div>
                      )}



                      {/* Shared Chat Documents */}
                      {sharedChatDocs.length > 0 && (
                        <div className="mb-6">
                          <h4 className="text-lg font-bold mb-4 text-slate-800 flex items-center gap-2">
                            <FileText className="w-5 h-5 text-indigo-600" /> Shared in Channels & Chats
                          </h4>
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {sharedChatDocs.map((attachment, idx) => (
                              <div key={attachment.id || `${attachment.name}-${idx}`} className="group relative rounded-2xl border overflow-hidden transition-all hover:shadow-xl hover:-translate-y-1 bg-white">
                                <div className="h-28 flex items-center justify-center bg-slate-50 text-indigo-600 relative">
                                  <div className="w-16 h-16 flex items-center justify-center text-3xl">ðŸ“Ž</div>
                                  <div className="absolute top-2 right-2 px-2 py-1 rounded-lg text-[10px] font-bold bg-white/90 backdrop-blur-sm text-slate-700 shadow-sm">
                                    {attachment.source === 'drive' ? 'Drive' : 'Chat'}
                                  </div>
                                </div>
                                <div className="p-4">
                                  <h5 className="font-bold text-slate-800 truncate mb-1">{attachment.name || 'Attachment'}</h5>
                                  <p className="text-xs text-slate-500 mb-2">Shared in {attachment.chatId}</p>
                                  <div className="flex items-center justify-between">
                                    <span className="text-[10px] font-bold uppercase tracking-wide text-slate-400">{attachment.mimeType ? (attachment.mimeType.split('/')[1] || '') : ''}</span>
                                    <div className="flex items-center gap-2">
                                      <button
                                        onClick={(e) => { e.preventDefault(); e.stopPropagation(); addDocumentAsAttachment({ id: attachment.id, name: attachment.name, mimeType: attachment.mimeType, url: attachment.url || attachment.webViewLink, source: attachment.source || 'chat' }) }}
                                        className="p-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 transition-all"
                                        title="Add to message"
                                      >
                                        <Plus className="w-4 h-4" />
                                      </button>
                                      {attachment.url || attachment.webViewLink ? (
                                        <a href={attachment.url || attachment.webViewLink} target="_blank" rel="noopener noreferrer" className="text-slate-400">
                                          <ExternalLink className="w-4 h-4" />
                                        </a>
                                      ) : null}
                                    </div>
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Gmail Attachments Grid */}
                      {(selectedAppFilter === 'all' || selectedAppFilter === 'gmail') && gmailAttachments.length > 0 && (
                        <div className="mb-6">
                          {selectedAppFilter === 'all' && googleDocs.length > 0 && (
                            <h4 className="text-lg font-bold mb-4 text-slate-800 flex items-center gap-2">
                              <Mail className="w-5 h-5 text-red-600" /> Gmail Attachments
                            </h4>
                          )}
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {gmailAttachments.map((attachment, idx) => (
                              <div
                                key={idx}
                                className="group relative rounded-2xl border-2 border-red-200 overflow-hidden transition-all hover:shadow-xl hover:-translate-y-1 bg-white hover:border-red-300"
                              >
                                <div className="h-32 flex items-center justify-center bg-red-50 text-red-600 relative">
                                  <img 
                                    src="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico"
                                    alt="Gmail"
                                    className="w-16 h-16 object-contain"
                                    onError={(e) => {
                                      e.target.style.display = 'none'
                                      e.target.nextElementSibling.style.display = 'block'
                                    }}
                                  />
                                  <span className="text-6xl hidden">ðŸ“§</span>
                                  <div className="absolute top-2 right-2 px-2 py-1 rounded-lg text-[10px] font-bold bg-white/90 backdrop-blur-sm text-slate-700 shadow-sm">
                                    Gmail
                                  </div>
                                </div>
                                <div className="p-4">
                                  <h5 className="font-bold text-slate-800 truncate mb-1">
                                    {attachment.filename}
                                  </h5>
                                  <p className="text-xs text-slate-500 mb-2">
                                    {new Date(parseInt(attachment.date)).toLocaleDateString('en-US', { 
                                      month: 'short', 
                                      day: 'numeric',
                                      year: 'numeric'
                                    })}
                                  </p>
                                  <div className="flex items-center justify-between">
                                    <span className="text-[10px] font-bold uppercase tracking-wide text-slate-400">
                                      {(attachment.size / 1024).toFixed(1)} KB
                                    </span>
                                    <div className="flex items-center gap-2">
                                      <button
                                        onClick={(e) => {
                                          e.preventDefault()
                                          e.stopPropagation()
                                          addDocumentAsAttachment({
                                            id: attachment.id,
                                            name: attachment.filename,
                                            mimeType: attachment.mimeType,
                                            webViewLink: `https://mail.google.com/mail/u/0/#inbox/${attachment.messageId}`
                                          })
                                        }}
                                        className="p-1.5 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 transition-colors"
                                        title="Add to message"
                                      >
                                        <Plus className="w-4 h-4" />
                                      </button>
                                      <Paperclip className="w-4 h-4 text-red-400" />
                                    </div>
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {googleDocs.length === 0 && gmailAttachments.length === 0 && (
                        <div className="flex-1 flex items-center justify-center py-16">
                          <div className="text-center">
                            <div className="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 bg-slate-50">
                              <FileText className="w-8 h-8 text-slate-400" />
                            </div>
                            <p className="text-slate-500 font-medium">No documents found</p>
                            <p className="text-xs text-slate-400 mt-2">Try connecting more apps or changing filters</p>
                          </div>
                        </div>
                      )}
                    </div>
                  </>
                )}
              </div>
            )}
          </div>
        </div>
      )}

      {/* Connect More Apps Modal */}
      {showConnectAppsModal && (
        <div className="fixed inset-0 backdrop-blur-md flex items-center justify-center z-[60] p-6 animate-fade-in bg-slate-900/40">
          <div className="rounded-[2rem] p-8 w-full max-w-md shadow-2xl bg-white ring-1 ring-slate-900/5">
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-2xl font-bold text-slate-800">Connect More Apps</h3>
              <button
                onClick={() => setShowConnectAppsModal(false)}
                className="p-2 rounded-full transition-colors hover:bg-slate-100 text-slate-500"
              >
                <X className="w-5 h-5" />
              </button>
            </div>
            <p className="text-slate-500 text-sm mb-6">
              Connect additional Google apps to access more documents
            </p>
            <div className="space-y-3">
              {[
                { id: 'docs', name: 'Google Docs', emoji: 'ðŸ“„', color: 'bg-blue-50 hover:bg-blue-100 border-blue-200' },
                { id: 'sheets', name: 'Google Sheets', emoji: 'ðŸ“Š', color: 'bg-green-50 hover:bg-green-100 border-green-200' },
                { id: 'slides', name: 'Google Slides', emoji: 'ðŸ“½ï¸', color: 'bg-yellow-50 hover:bg-yellow-100 border-yellow-200' },
                { id: 'gmail', name: 'Gmail Attachments', emoji: 'ðŸ“§', color: 'bg-red-50 hover:bg-red-100 border-red-200' }
              ].map((app) => (
                <button
                  key={app.id}
                  onClick={() => handleConnectSpecificApp(app.id)}
                  disabled={connectedApps.includes(app.id)}
                  className={`w-full p-4 rounded-2xl border-2 transition-all flex items-center gap-4 ${
                    connectedApps.includes(app.id)
                      ? 'bg-slate-50 border-slate-200 opacity-60 cursor-not-allowed'
                      : `${app.color} cursor-pointer transform hover:scale-[1.02]`
                  }`}
                >
                  <span className="text-3xl">{app.emoji}</span>
                  <div className="flex-1 text-left">
                    <h4 className="font-bold text-slate-800">{app.name}</h4>
                    <p className="text-xs text-slate-500">
                      {connectedApps.includes(app.id) ? 'Already connected' : 'Click to connect'}
                    </p>
                  </div>
                  {connectedApps.includes(app.id) && (
                    <CheckCircle className="w-5 h-5 text-green-600" />
                  )}
                </button>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* Google Calendar Connection Modal */}
      {showCalendarConnectModal && (
        <div className="fixed inset-0 backdrop-blur-md flex items-center justify-center z-[60] p-6 animate-fade-in bg-slate-900/40">
          <div className="rounded-[2rem] p-8 w-full max-w-md shadow-2xl bg-white ring-1 ring-slate-900/5">
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-2xl font-bold text-slate-800 flex items-center gap-3">
                <Calendar className="w-7 h-7 text-purple-600" />
                Connect Google Calendar
              </h3>
              <button
                onClick={() => setShowCalendarConnectModal(false)}
                className="p-2 rounded-full transition-colors hover:bg-slate-100 text-slate-500"
              >
                <X className="w-5 h-5" />
              </button>
            </div>
            <div className="mb-6">
              <div className="w-20 h-20 rounded-full flex items-center justify-center mb-4 mx-auto bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-100">
                <Calendar className="w-10 h-10 text-purple-600" />
              </div>
              <p className="text-slate-500 text-center mb-2">
                Connect your Google Calendar to view and sync your events in real-time.
              </p>
              <p className="text-xs text-slate-400 text-center">
                You'll be asked to grant calendar access permissions.
              </p>
            </div>
            <div className="space-y-3">
              <button
                onClick={handleConnectGoogleCalendar}
                className="w-full px-6 py-4 font-bold rounded-2xl transition-all flex items-center justify-center gap-3 bg-purple-600 hover:bg-purple-700 text-white shadow-lg shadow-purple-200"
              >
                <svg className="w-5 h-5" viewBox="0 0 24 24">
                  <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                  <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                  <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                  <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Connect Google Calendar
              </button>
              <button
                onClick={() => setShowCalendarConnectModal(false)}
                className="w-full px-6 py-3 font-medium rounded-2xl transition-all text-slate-600 hover:bg-slate-100"
              >
                Maybe Later
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Success Toast Notification */}
      {showSuccessToast && (
        <div className="fixed bottom-8 right-8 z-[70] animate-fade-in">
          <div className="rounded-2xl p-4 shadow-2xl bg-green-600 text-white flex items-center gap-3 min-w-[300px]">
            <div className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center flex-shrink-0">
              <CheckCircle className="w-5 h-5" />
            </div>
            <div className="flex-1">
              <p className="font-bold text-sm">Added Successfully!</p>
              <p className="text-xs text-white/80 mt-0.5">{successMessage}</p>
            </div>
            <button
              onClick={() => setShowSuccessToast(false)}
              className="p-1 rounded-full hover:bg-white/20 transition-colors"
            >
              <X className="w-4 h-4" />
            </button>
          </div>
        </div>
      )}
    </div>
  )
}
